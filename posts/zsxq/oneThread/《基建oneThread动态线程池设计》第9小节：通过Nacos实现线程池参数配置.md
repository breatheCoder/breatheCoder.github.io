2025å¹´07æœˆ15æ—¥ 22:13  
é€šè¿‡ Nacos å®ç°çº¿ç¨‹æ± å‚æ•°é…ç½®ï¼Œå…ƒæ•°æ®ä¿¡æ¯ï¼š

*  
ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± oneThreadï¼š<https://t.zsxq.com/5GfrN>  
*  
ä»£ç ä»“åº“ï¼š<https://gitcode.net/nageoffer/onethread> ------ ç”³è¯·é¡¹ç›®æƒé™å‚è€ƒä¸Šè¿°çº¿ç¨‹æ± é¡¹ç›®é“¾æ¥  
*  
ç« èŠ‚éš¾åº¦ï¼šâ˜…â˜…â˜…â˜†â˜† - è¾ƒéš¾  
*  
  è§†é¢‘åœ°å€ï¼šæ–‡æ¡£å…ˆè¡Œè§†é¢‘æ¬¡ä¹‹



*** ** * ** ***

å†…å®¹æ‘˜è¦ï¼šæœ¬èŠ‚ä¸»è¦è®²è§£äº†å½“ Nacos é…ç½®å‘ç”Ÿå˜æ›´æ—¶ï¼Œç›‘å¬å™¨æ¥æ”¶åˆ°çš„æ˜¯å®Œæ•´çš„é…ç½®æ–‡ä»¶å­—ç¬¦ä¸²å†…å®¹ï¼ˆå¦‚ YAML æ ¼å¼ï¼‰ã€‚ç”±äºè¿™ç±»å­—ç¬¦ä¸²æ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œè§£æï¼Œè½¬æ¢æˆå¯æ“ä½œçš„ Java å¯¹è±¡ï¼ˆå¦‚ `BootstrapConfigProperties`ï¼‰ï¼Œä»¥ä¾¿åç»­åŠ¨æ€åˆ·æ–°çº¿ç¨‹æ± é…ç½®ã€‚

è¯¾ç¨‹ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š

*  
ä»€ä¹ˆæ˜¯ Nacosï¼Ÿ  
*  
Nacos å¦‚ä½•å®Œæˆé…ç½®ç›‘å¬ï¼Ÿ  
*  
  æ–‡æœ«æ€»ç»“

ä»€ä¹ˆæ˜¯ Nacosï¼Ÿ {#nacos}
-------------------

> è¯¥ç« èŠ‚å–è‡ª [Nacos å®˜ç½‘](https://nacos.io/docs/v2.5/overview) Version 2.5ï¼Œæœ¬ç« èŠ‚é‡ç‚¹ä½¿ç”¨çš„æ˜¯ Nacos åŠ¨æ€é…ç½®æœåŠ¡ï¼Œå¦‚å·²äº†è§£å¯è·³è¿‡è¯¥å°èŠ‚ã€‚

Nacos `/nÉ‘:kÉ™ÊŠs/` æ˜¯ Dynamic Naming and Configuration Service çš„é¦–å­—æ¯ç®€ç§°ï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚

Nacos è‡´åŠ›äºå¸®åŠ©æ‚¨å‘ç°ã€é…ç½®å’Œç®¡ç†å¾®æœåŠ¡ã€‚Nacos æä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚

Nacos å¸®åŠ©æ‚¨æ›´æ•æ·å’Œå®¹æ˜“åœ°æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡å¹³å°ã€‚ Nacos æ˜¯æ„å»ºä»¥\*\*"æœåŠ¡"\*\* ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ (ä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼) çš„æœåŠ¡åŸºç¡€è®¾æ–½ã€‚

### 1. äº§å“åŠŸèƒ½ {#1}

#### 1.1 æœåŠ¡å‘ç°å’ŒæœåŠ¡å¥åº·ç›‘æµ‹ {#1-1}

Nacos æ”¯æŒåŸºäº DNS å’ŒåŸºäº RPC çš„æœåŠ¡å‘ç°ã€‚æœåŠ¡æä¾›è€…ä½¿ç”¨åŸç”ŸSDKã€OpenAPIã€æˆ–ä¸€ä¸ªç‹¬ç«‹çš„ Agent æ³¨å†Œ Service åï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨ HTTP\&API æŸ¥æ‰¾å’Œå‘ç°æœåŠ¡ã€‚

Nacos æä¾›å¯¹æœåŠ¡çš„å®æ—¶çš„å¥åº·æ£€æŸ¥ï¼Œé˜»æ­¢å‘ä¸å¥åº·çš„ä¸»æœºæˆ–æœåŠ¡å®ä¾‹å‘é€è¯·æ±‚ã€‚Nacos æ”¯æŒä¼ è¾“å±‚ (PING æˆ– TCP)å’Œåº”ç”¨å±‚ (å¦‚ HTTPã€MySQLã€ç”¨æˆ·è‡ªå®šä¹‰ï¼‰çš„å¥åº·æ£€æŸ¥ã€‚ å¯¹äºå¤æ‚çš„äº‘ç¯å¢ƒå’Œç½‘ç»œæ‹“æ‰‘ç¯å¢ƒä¸­ï¼ˆå¦‚ VPCã€è¾¹ç¼˜ç½‘ç»œç­‰ï¼‰æœåŠ¡çš„å¥åº·æ£€æŸ¥ï¼ŒNacos æä¾›äº† agent ä¸ŠæŠ¥æ¨¡å¼å’ŒæœåŠ¡ç«¯ä¸»åŠ¨æ£€æµ‹2ç§å¥åº·æ£€æŸ¥æ¨¡å¼ã€‚Nacos è¿˜æä¾›äº†ç»Ÿä¸€çš„å¥åº·æ£€æŸ¥ä»ªè¡¨ç›˜ï¼Œå¸®åŠ©æ‚¨æ ¹æ®å¥åº·çŠ¶æ€ç®¡ç†æœåŠ¡çš„å¯ç”¨æ€§åŠæµé‡ã€‚

#### 1.2 åŠ¨æ€é…ç½®æœåŠ¡ {#1-2}

åŠ¨æ€é…ç½®æœåŠ¡å¯ä»¥è®©æ‚¨ä»¥ä¸­å¿ƒåŒ–ã€å¤–éƒ¨åŒ–å’ŒåŠ¨æ€åŒ–çš„æ–¹å¼ç®¡ç†æ‰€æœ‰ç¯å¢ƒçš„åº”ç”¨é…ç½®å’ŒæœåŠ¡é…ç½®ã€‚

åŠ¨æ€é…ç½®æ¶ˆé™¤äº†é…ç½®å˜æ›´æ—¶é‡æ–°éƒ¨ç½²åº”ç”¨å’ŒæœåŠ¡çš„éœ€è¦ï¼Œè®©é…ç½®ç®¡ç†å˜å¾—æ›´åŠ é«˜æ•ˆå’Œæ•æ·ã€‚

é…ç½®ä¸­å¿ƒåŒ–ç®¡ç†è®©å®ç°æ— çŠ¶æ€æœåŠ¡å˜å¾—æ›´ç®€å•ï¼Œè®©æœåŠ¡æŒ‰éœ€å¼¹æ€§æ‰©å±•å˜å¾—æ›´å®¹æ˜“ã€‚

Nacos æä¾›äº†ä¸€ä¸ªç®€æ´æ˜“ç”¨çš„UI ([æ§åˆ¶å°æ ·ä¾‹ Demo](http://console.nacos.io/index.html?spm=5238cd80.72a042d5.0.0.5bc0cd36IfxBwB)) å¸®åŠ©æ‚¨ç®¡ç†æ‰€æœ‰çš„æœåŠ¡å’Œåº”ç”¨çš„é…ç½®ã€‚Nacos è¿˜æä¾›åŒ…æ‹¬é…ç½®ç‰ˆæœ¬è·Ÿè¸ªã€é‡‘ä¸é›€å‘å¸ƒã€ä¸€é”®å›æ»šé…ç½®ä»¥åŠå®¢æˆ·ç«¯é…ç½®æ›´æ–°çŠ¶æ€è·Ÿè¸ªåœ¨å†…çš„ä¸€ç³»åˆ—å¼€ç®±å³ç”¨çš„é…ç½®ç®¡ç†ç‰¹æ€§ï¼Œå¸®åŠ©æ‚¨æ›´å®‰å…¨åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç†é…ç½®å˜æ›´å’Œé™ä½é…ç½®å˜æ›´å¸¦æ¥çš„é£é™©ã€‚

#### 1.3 åŠ¨æ€ DNS æœåŠ¡ {#1-3-dns}

åŠ¨æ€ DNS æœåŠ¡æ”¯æŒæƒé‡è·¯ç”±ï¼Œè®©æ‚¨æ›´å®¹æ˜“åœ°å®ç°ä¸­é—´å±‚è´Ÿè½½å‡è¡¡ã€æ›´çµæ´»çš„è·¯ç”±ç­–ç•¥ã€æµé‡æ§åˆ¶ä»¥åŠæ•°æ®ä¸­å¿ƒå†…ç½‘çš„ç®€å•DNSè§£ææœåŠ¡ã€‚åŠ¨æ€DNSæœåŠ¡è¿˜èƒ½è®©æ‚¨æ›´å®¹æ˜“åœ°å®ç°ä»¥ DNS åè®®ä¸ºåŸºç¡€çš„æœåŠ¡å‘ç°ï¼Œä»¥å¸®åŠ©æ‚¨æ¶ˆé™¤è€¦åˆåˆ°å‚å•†ç§æœ‰æœåŠ¡å‘ç° API ä¸Šçš„é£é™©ã€‚

Nacos æä¾›äº†ä¸€äº›ç®€å•çš„ DNS APIs å¸®åŠ©æ‚¨ç®¡ç†æœåŠ¡çš„å…³è”åŸŸåå’Œå¯ç”¨çš„ IP åˆ—è¡¨ã€‚

#### 1.4 æœåŠ¡åŠå…¶å…ƒæ•°æ®ç®¡ç† {#1-4}

Nacos èƒ½è®©æ‚¨ä»å¾®æœåŠ¡å¹³å°å»ºè®¾çš„è§†è§’ç®¡ç†æ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰æœåŠ¡åŠå…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ç®¡ç†æœåŠ¡çš„æè¿°ã€ç”Ÿå‘½å‘¨æœŸã€æœåŠ¡çš„é™æ€ä¾èµ–åˆ†æã€æœåŠ¡çš„å¥åº·çŠ¶æ€ã€æœåŠ¡çš„æµé‡ç®¡ç†ã€è·¯ç”±åŠå®‰å…¨ç­–ç•¥ã€æœåŠ¡çš„ SLA ä»¥åŠæœ€é¦–è¦çš„ metrics ç»Ÿè®¡æ•°æ®ã€‚

### 2. äº§å“ä¼˜åŠ¿ {#2}

*  
**æ˜“äºä½¿ç”¨** ï¼šNacos ç»å†å‡ ä¸‡äººä½¿ç”¨åé¦ˆä¼˜åŒ–ï¼Œæä¾›ç»Ÿä¸€çš„æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†åŠŸèƒ½ï¼Œé€šè¿‡ç›´è§‚çš„ Web ç•Œé¢å’Œç®€æ´çš„ APIï¼Œä¸ºå¼€å‘å’Œè¿ç»´äººå‘˜åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­å¸¦æ¥äº†ä¾¿æ·çš„æœåŠ¡æ³¨å†Œã€å‘ç°å’Œé…ç½®æ›´æ–°æ“ä½œã€‚  
*  
**ç‰¹æ€§ä¸°å¯Œ** ï¼šNacos æä¾›äº†åŒ…æ‹¬æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†ã€åŠ¨æ€ DNS æœåŠ¡ã€æœåŠ¡å…ƒæ•°æ®ç®¡ç†ã€æµé‡ç®¡ç†ã€æœåŠ¡ç›‘æ§ã€æœåŠ¡æ²»ç†ç­‰åœ¨å†…çš„ä¸€ç³»åˆ—ç‰¹æ€§ï¼Œå¸®åŠ©æ‚¨åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œæ›´è½»æ¾çš„æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡ã€‚  
*  
**æè‡´æ€§èƒ½** ï¼šNacos ç»è¿‡é˜¿é‡ŒåŒåä¸€è¶…å¿«ä¼¸ç¼©åœºæ™¯çš„é”¤ç‚¼ï¼Œæä¾›é«˜æ€§èƒ½çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°èƒ½åŠ›ï¼Œä»¥åŠä½å»¶è¿Ÿçš„é…ç½®æ›´æ–°å“åº”ï¼Œç¡®ä¿åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é«˜æ•ˆç‡å’Œç¨³å®šè¿è¡Œã€‚  
*  
**è¶…å¤§å®¹é‡** ï¼šNacos è¯ç”Ÿè‡ªé˜¿é‡Œçš„ç™¾ä¸‡å®ä¾‹è§„æ¨¡ï¼Œé€ å°±æ”¯æŒæµ·é‡æœåŠ¡å’Œé…ç½®çš„ç®¡ç†ï¼Œèƒ½å¤Ÿæ»¡è¶³å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿå¯¹é«˜å¹¶å‘å’Œé«˜å¯ç”¨æ€§çš„éœ€æ±‚ã€‚  
*  
**ç¨³å®šå¯ç”¨** ï¼šNacos é€šè¿‡è‡ªç ”çš„åŒæ­¥åè®®ï¼Œé…åˆç”Ÿæ€ä¸­åº”ç”¨å¹¿æ³›çš„ Raft åè®®ï¼Œç¡®ä¿äº†æœåŠ¡çš„é«˜å¯ç”¨æ€§å’Œæ•°æ®çš„ç¨³å®šæ€§ï¼Œä¿è¯é˜¿é‡ŒåŒåä¸€ç³»ç»Ÿçš„é«˜å¯ç”¨ç¨³å®šè¿è¡Œã€‚  
*  
  **å¼€æ”¾ç”Ÿæ€** ï¼šNacos æ‹¥æœ‰æ´»è·ƒçš„å¼€æºç¤¾åŒºã€å¹¿æ³›çš„ç”Ÿæ€æ•´åˆå’ŒæŒç»­çš„åˆ›æ–°å‘å±•ï¼Œä¸ä»…å¤§é‡å…¼å®¹äº† Spring Cloudã€Dubbo ç­‰å¤§å—æ¬¢è¿çš„å¼€æºæ¡†æ¶ã€è¿˜æä¾›äº†ä¸°å¯Œçš„æ’ä»¶åŒ–èƒ½åŠ›ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œæä¾›å¯å®šåˆ¶æ»¡è¶³è‡ªèº«ç‰¹æ®Šéœ€æ±‚çš„ç‹¬æœ‰äº‘åŸç”Ÿå¾®æœåŠ¡ç³»ç»Ÿã€‚

### 3. è®¾è®¡ç†å¿µ {#3}

> æˆ‘ä»¬ç›¸ä¿¡ä¸€åˆ‡éƒ½æ˜¯æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡èŠ‚ç‚¹è¢«æ„æƒ³ä¸ºä¸€ä¸ªæ˜Ÿçƒï¼Œæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€ä¸ªæ˜Ÿç³»ã€‚Nacos è‡´åŠ›äºå¸®åŠ©å»ºç«‹è¿™äº›æœåŠ¡ä¹‹é—´çš„**è¿æ¥** ï¼ŒåŠ©åŠ›æ¯ä¸ªé¢å‘æ˜Ÿè¾°çš„æ¢¦æƒ³èƒ½å¤Ÿé€è¿‡äº‘å±‚ï¼Œé£åœ¨äº‘ä¸Šï¼Œæ›´å¥½çš„é“¾æ¥æ•´ç‰‡æ˜Ÿç©ºã€‚

Nacoså¸Œæœ›å¸®åŠ©ç”¨æˆ·åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œåœ¨ç§æœ‰äº‘ã€æ··åˆäº‘æˆ–è€…å…¬æœ‰äº‘ç­‰æ‰€æœ‰äº‘ç¯å¢ƒä¸­ï¼Œæ›´å¥½çš„æ„å»ºã€äº¤ä»˜ã€ç®¡ç†è‡ªå·±çš„å¾®æœåŠ¡å¹³å°ï¼Œæ›´å¿«çš„å¤ç”¨å’Œç»„åˆä¸šåŠ¡æœåŠ¡ï¼Œæ›´å¿«çš„äº¤ä»˜å•†ä¸šåˆ›æ–°çš„ä»·å€¼ï¼Œä»è€Œä¸ºç”¨æˆ·èµ¢å¾—å¸‚åœºã€‚æ­£æ˜¯åŸºäºè¿™ä¸€æ„¿æ™¯ï¼ŒNacosçš„è®¾è®¡ç†å¿µè¢«å®šä½ä¸º`æ˜“äºä½¿ç”¨`ã€`é¢å‘æ ‡å‡†`ã€`é«˜å¯ç”¨`å’Œ`æ–¹ä¾¿æ‰©å±•`ã€‚

![image.png](https://article-images.zsxq.com/FhHLKQNLcrcqSVCCoJ3GgZvlm0Ei "image.png")

#### 3.1 æ˜“äºä½¿ç”¨ {#3-1}

æ˜“äºä½¿ç”¨æ˜¯ Nacos çš„ä¸€ä¸ªæ ¸å¿ƒç†å¿µï¼Œå®ƒé€šè¿‡æä¾›ç”¨æˆ·å‹å¥½çš„ Web ç•Œé¢å’Œç®€æ´çš„ API æ¥ç®€åŒ–æœåŠ¡çš„æ³¨å†Œã€å‘ç°å’Œé…ç½®ç®¡ç†è¿‡ç¨‹ã€‚å¼€å‘è€…å¯ä»¥è½»æ¾é›†æˆ Nacos åˆ°ä»–ä»¬çš„åº”ç”¨ä¸­ï¼Œæ— éœ€æŠ•å…¥å¤§é‡æ—¶é—´åœ¨å¤æ‚çš„è®¾ç½®å’Œå­¦ä¹ ä¸Šã€‚

#### 3.2 é¢å‘æ ‡å‡† {#3-2}

Nacos é‡‡ç”¨é¢å‘æ ‡å‡†çš„è®¾è®¡ç†å¿µï¼Œéµå¾ªäº‘åŸç”Ÿåº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µå’Œæ ‡å‡†åè®®ï¼Œä»¥ç¡®ä¿å…¶æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†åŠŸèƒ½ä¸å¹¿æ³›çš„æŠ€æœ¯æ ˆå’Œå¹³å°æ— ç¼å¯¹æ¥ã€‚

#### 3.3 é«˜å¯ç”¨ {#3-3}

ä¸ºäº†æ»¡è¶³ä¼ä¸šçº§åº”ç”¨å¯¹é«˜å¯ç”¨çš„éœ€æ±‚ï¼ŒNacos å®ç°äº†é›†ç¾¤æ¨¡å¼ï¼Œç¡®ä¿åœ¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæœåŠ¡çš„å‘ç°å’Œé…ç½®ç®¡ç†åŠŸèƒ½ä¸ä¼šå—å½±å“ã€‚é›†ç¾¤æ¨¡å¼ä¹Ÿæ„å‘³ç€ Nacos å¯ä»¥é€šè¿‡å¢åŠ èŠ‚ç‚¹æ¥æ°´å¹³æ‰©å±•ï¼Œæå‡ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½å’Œæ‰¿è½½èƒ½åŠ›ã€‚

![image.png](https://article-images.zsxq.com/Ful0-ca1czSHxE6seFD10ti0wuFz "image.png")

#### 3.4 æ–¹ä¾¿æ‰©å±• {#3-4}

Nacos è¿˜æ³¨é‡æ˜“äºæ‰©å±•ï¼Œå®ƒé‡‡ç”¨äº†æ¨¡å—åŒ–çš„è®¾è®¡ä½¿å¾—å„ä¸ªç»„ä»¶éƒ½å¯ä»¥ç‹¬ç«‹åœ°è¿›è¡Œæ‰©å±•æˆ–æ›¿æ¢ã€‚è¿™ä¹Ÿä¸ºç¤¾åŒºè´¡çŒ®è€…æä¾›äº†æ–¹ä¾¿ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿé’ˆå¯¹ç‰¹å®šçš„éœ€æ±‚å¼€å‘æ–°çš„åŠŸèƒ½æˆ–è€…æ”¹å–„ç°æœ‰åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æ¨åŠ¨ Nacos çš„ç”Ÿæ€å‘å±•ã€‚

![image.png](https://article-images.zsxq.com/FuYbQ9uL7c0Jx25R0YxEhN1wqAQX "image.png")

é€šè¿‡ä¸Šè¿°è®¾è®¡ç†å¿µçš„å®ç°ï¼ŒNacos ä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„å¹³å°ï¼Œä»¥æ”¯æŒä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ï¼ŒåŠ é€Ÿä¸šåŠ¡åˆ›æ–°å’Œæ•°å­—è½¬å‹ï¼Œæœ€ç»ˆå¸®åŠ©ç”¨æˆ·åœ¨ç«äº‰æ¿€çƒˆçš„å¸‚åœºä¸­å æ®æœ‰åˆ©åœ°ä½ã€‚

Nacos å¦‚ä½•å®Œæˆé…ç½®ç›‘å¬ï¼Ÿ {#nacos}
------------------------

ç”±äº Nacos çš„å®Œæ•´é…ç½®å˜æ›´ç›‘å¬æœºåˆ¶æ¶‰åŠåˆ°æ¨¡æ¿æ–¹æ³•ã€è§‚å¯Ÿè€…æ¨¡å¼ç­‰è¿›é˜¶è®¾è®¡æ¨¡å¼ï¼Œæ•´ä½“æµç¨‹ç›¸å¯¹å¤æ‚ã€‚ä¸ºäº†è®©å¤§å®¶æ›´å®¹æ˜“ç†è§£å’Œå¾ªåºæ¸è¿›åœ°æŒæ¡ç›¸å…³åŸç†ï¼ŒBreatheå°†æ‹†åˆ†ä¸ºå¤šä¸ªç« èŠ‚è®²è§£ã€‚æœŸé—´å¦‚æœä½ çœ‹åˆ°æ–‡æ¡£æŸäº›ç±»ååç¼€å¸¦æœ‰ V1ã€V2 ç­‰å­—æ ·ï¼Œä»£è¡¨è¿™æ˜¯æ¼”è¿›è¿‡ç¨‹ä¸­çš„é˜¶æ®µæ€§ç‰ˆæœ¬ä»£ç ï¼Œæ–¹ä¾¿å¤§å®¶è·Ÿè¿›ç†è§£ã€‚
> æœ¬ç« èŠ‚çš„é‡ç‚¹å†…å®¹é›†ä¸­åœ¨ä¸¤ä¸ªæ¨¡å—ï¼š`common-spring-boot-starter` å’Œ `nacos-cloud-spring-boot-starter`ã€‚

ä»æ•´ä½“ä¸Šçœ‹ï¼ŒåŠ¨æ€çº¿ç¨‹æ± å‚æ•°å˜æ›´çš„æµç¨‹å…¶å®å¹¶ä¸å¤æ‚ï¼Œå¯ä»¥ç±»æ¯”ä¸º"æŠŠå¤§è±¡è£…è¿›å†°ç®±"çš„ä¸‰æ­¥èµ°ï¼š

* 1.  
**ç›‘å¬é…ç½®å˜æ›´** ï¼šSpringBoot æ³¨å†Œäº†ç›‘å¬å™¨ï¼Œä¸€æ—¦æ£€æµ‹åˆ° Nacos é…ç½®æ–‡ä»¶å‘ç”Ÿå˜æ›´ï¼Œç«‹å³è·å–æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼›  
* 2.  
**å‚æ•°ç»‘å®š** ï¼šå°†æ¥æ”¶åˆ°çš„æœ€æ–°é…ç½®å†…å®¹ï¼Œç»‘å®šåˆ° `BootstrapConfigProperties` å¯¹è±¡ä¸­ï¼Œå®Œæˆå­—ç¬¦ä¸² â†’ Java å¯¹è±¡çš„è½¬æ¢ï¼›  
* 3.  
  **æ›´æ–°çº¿ç¨‹æ± ** ï¼šé€šè¿‡ `BootstrapConfigProperties` ä¸å½“å‰çº¿ç¨‹æ± å‚æ•°è¿›è¡Œæ¯”å¯¹ï¼Œå‘ç°å˜æ›´åˆ™æ‰§è¡Œæ›´æ–°æ“ä½œï¼Œæ— å˜æ›´åˆ™è·³è¿‡ï¼Œé¿å…æ— æ„ä¹‰åˆ·æ–°ã€‚

ä¸ºäº†å¸®åŠ©å¤§å®¶å¿«é€Ÿç†æ¸…æµç¨‹ï¼Œè¿™é‡Œå…ˆæ”¾ä¸Šä¸€å¼ **æ—¶åºå›¾** ï¼Œå¸®åŠ©å¤§å®¶å¯¹æ•´ä½“æ‰§è¡Œè¿‡ç¨‹æœ‰ä¸ªåˆæ­¥çš„ç†è§£ï¼š

![image-20250715175156406.png](https://article-images.zsxq.com/FubBL66Iesi7afmCmfqnmbK_N-ok "image-20250715175156406.png")

å¦‚æœå¤§å®¶æƒ³è¦ä½¿ç”¨ Nacosï¼Œéœ€è¦åœ¨ pom.xml æ–‡ä»¶ä¸­æ·»åŠ å¯¹åº”çš„ä¾èµ–ï¼ŒNacos åœ¨ SpringCloud é¢†åŸŸå¯¹åº”çš„ä¾èµ–ä¸ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
              
å› ä¸ºå’±ä»¬åœ¨æ ¹èŠ‚ç‚¹è¿›è¡Œäº†ç‰ˆæœ¬ç®¡ç†ï¼Œæ‰€ä»¥åœ¨ `nacos-cloud-spring-boot-starter` ç»„ä»¶ä¸­åªéœ€è¦å†™ä¾èµ–å³å¯ã€‚

### 1. æ³¨å†Œ Nacos Listener {#1-nacos-listener}

ä» Nacos æä¾›çš„é…ç½®ä¸­å¿ƒæŠ½è±¡æ¥å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€æ˜¯ `addListener`ï¼Œç”¨äºæ³¨å†Œé…ç½®å˜æ›´ç›‘å¬å™¨ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public interface ConfigService {
        // ......
        /**
         * Add a listener to the configuration, after the server modified the configuration, the client will use the
         * incoming listener callback. Recommended asynchronous processing, the application can implement the getExecutor
         * method in the ManagerListener, provide a thread pool of execution. If not provided, use the main thread callback, May
         * block other configurations or be blocked by other configurations.
         *
         * @param dataId   dataId
         * @param group    group
         * @param listener listener
         * @throws NacosException NacosException
         */
        void addListener(String dataId, String group, Listener listener) throws NacosException;
        // ......
    }
              
ä¸‹é¢æ˜¯ `addListener` æ–¹æ³•çš„æ³¨é‡Šç¿»è¯‘ï¼Œæ–¹ä¾¿å¤§å®¶æ›´å¥½ç†è§£å®ƒçš„ä½œç”¨ï¼š
> å‘é…ç½®æ·»åŠ ç›‘å¬å™¨ï¼Œå½“æœåŠ¡ç«¯ä¿®æ”¹é…ç½®åï¼Œå®¢æˆ·ç«¯ä¼šé€šè¿‡ä¼ å…¥çš„ç›‘å¬å™¨è¿›è¡Œå›è°ƒã€‚æ¨èä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œåº”ç”¨å¯ä»¥åœ¨ `ManagerListener` ä¸­å®ç° `getExecutor` æ–¹æ³•ï¼Œæä¾›ä¸€ä¸ªç”¨äºæ‰§è¡Œçš„çº¿ç¨‹æ± ã€‚å¦‚æœæ²¡æœ‰æä¾›ï¼Œå°†ä½¿ç”¨ä¸»çº¿ç¨‹è¿›è¡Œå›è°ƒï¼Œè¿™å¯èƒ½ä¼šé˜»å¡å…¶ä»–é…ç½®ï¼Œæˆ–è¢«å…¶ä»–é…ç½®é˜»å¡ã€‚

æ¥ä¸‹æ¥å°±æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºè¿›è¡Œæ·»åŠ ç›‘å¬å‘¢ï¼Ÿæ¯•ç«Ÿä½ å†™ä¸ªæ·»åŠ ç›‘å¬æ–¹æ³•æ€»è¦è¢«è°ƒç”¨æ‰èƒ½ç”Ÿæ•ˆã€‚è¿™é‡Œä½¿ç”¨ SpringBoot æ‰©å±•æ¥å£ `ApplicationRunner` å®ç°ï¼Œä¸€ä¸ªå¯åŠ¨æ—¶è‡ªåŠ¨å›è°ƒçš„"é’©å­"æ¥å£ã€‚

*  
**è§¦å‘æ—¶æœº** ï¼šåœ¨ Spring å®¹å™¨å®Œæˆåˆå§‹åŒ–ã€æ‰€æœ‰ Bean éƒ½åŠ è½½å¥½ã€å¹¶ä¸”åº”ç”¨å‡†å¤‡å°±ç»ªåè‡ªåŠ¨è°ƒç”¨ã€‚  
*  
  **å…¸å‹ç”¨é€”** ï¼šåšé¡¹ç›®å¯åŠ¨åçš„é¢„åŠ è½½ã€æ³¨å†Œç›‘å¬å™¨ã€åˆå§‹åŒ–ç¼“å­˜ã€å¯åŠ¨ä»»åŠ¡ã€æ£€æŸ¥é…ç½®ç­‰ä¸€åˆ‡éœ€è¦åœ¨å¯åŠ¨åé©¬ä¸Šåšçš„æ“ä½œã€‚

æœ‰åŒå­¦å¯èƒ½ä¼šå¥½å¥‡ï¼š"Breatheï¼Œä¸ºä»€ä¹ˆä½ ä¸ç”¨ `CommandLineRunner` å‘¢ï¼Ÿ"å…¶å®æ— æ‰€è°“ï¼Œ**åœ¨å’±ä»¬è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œ`ApplicationRunner`å’Œ`CommandLineRunner`ç”¨å“ªä¸ªéƒ½è¡Œï¼Œä¸»è¦çœ‹å¿ƒæƒ…ï¼Œæ•ˆæœä¸Šæ²¡æœ‰æœ¬è´¨åŒºåˆ«** ã€‚

å¥½ï¼Œå’±ä»¬ç»§ç»­å¾€ä¸‹çœ‹ ------ **æ¥çœ‹ä¸‹æ³¨å†Œé…ç½®ç›‘å¬çš„æ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ï¼š**  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @Slf4j
    @RequiredArgsConstructor
    public class NacosCloudRefresherHandlerV1 implements ApplicationRunner {
    â€‹
        private final ConfigService configService;
        private final BootstrapConfigProperties properties;
    â€‹
        @Override
        public void run(ApplicationArguments args) throws Exception {
            BootstrapConfigProperties.NacosConfig nacosConfig = properties.getNacos();
            configService.addListener(
                    nacosConfig.getDataId(),
                    nacosConfig.getGroup(),
                    new Listener() {
    â€‹
                        @Override
                        public Executor getExecutor() {
                            return ThreadPoolExecutorBuilder.builder()
                                    .corePoolSize(1)
                                    .maximumPoolSize(1)
                                    .keepAliveTime(9999L)
                                    .workQueueType(BlockingQueueTypeEnum.SYNCHRONOUS_QUEUE)
                                    .threadFactory("clod-nacos-refresher-thread_")
                                    .rejectedHandler(new ThreadPoolExecutor.CallerRunsPolicy())
                                    .build();
                        }
    â€‹
                        @Override
                        public void receiveConfigInfo(String configInfo) {
                            // å¦‚æœ Nacos é…ç½®æ–‡ä»¶å˜æ›´ï¼Œä¼šè§¦å‘è¯¥æ–¹æ³•è¿›è¡Œå›è°ƒ
                        }
                    });
    â€‹
            log.info("Dynamic thread pool refresher, add nacos cloud listener success. data-id: {}, group: {}", nacosConfig.getDataId(), nacosConfig.getGroup());
        }
    }
              
æ–¹æ³•çš„å…·ä½“é€»è¾‘å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

* 1.  
**è·å–Nacosé…ç½®å‚æ•°** ï¼šé¦–å…ˆï¼Œé€šè¿‡ `properties.getNacos()` è·å–é…ç½®ä¸­å¿ƒçš„å…³é”®å‚æ•°ï¼Œæ¯”å¦‚ `dataId` å’Œ `group`ï¼Œè¿™ä¸¤ä¸ªå­—æ®µå…±åŒç¡®å®šäº†å”¯ä¸€çš„é…ç½®æ–‡ä»¶ä½ç½®ã€‚  
* 2.  
**æ³¨å†Œé…ç½®å˜æ›´ç›‘å¬å™¨** ï¼šæ¥ç€è°ƒç”¨ `configService.addListener(...)` æ–¹æ³•ï¼Œå‘æŒ‡å®šçš„ `dataId` å’Œ `group` æ³¨å†Œç›‘å¬å™¨ã€‚ä¸€æ—¦ Nacos ç«¯å¯¹åº”çš„é…ç½®å‘ç”Ÿå˜æ›´ï¼Œç›‘å¬å™¨å°±ä¼šè¢«è‡ªåŠ¨è§¦å‘ã€‚  
* 3.  
**è‡ªå®šä¹‰Listenerçš„æ‰§è¡Œçº¿ç¨‹æ± ** ï¼šåœ¨åŒ¿å `Listener` å®ç°ä¸­ï¼Œé‡å†™äº† `getExecutor()` æ–¹æ³•ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ª**å•çº¿ç¨‹æ± ** æ¥å¼‚æ­¥æ‰§è¡Œå›è°ƒé€»è¾‘ï¼Œé¿å…é˜»å¡ Nacos å®¢æˆ·ç«¯çš„ä¸»çº¿ç¨‹ï¼ŒåŒæ—¶ä¹Ÿè§„é¿äº†å¹¶å‘å¸¦æ¥çš„å‰¯ä½œç”¨ã€‚  
* 4.  
**é…ç½®å˜æ›´å›è°ƒ** ï¼šå½“é…ç½®å‘ç”Ÿå˜æ›´æ—¶ï¼Œ`receiveConfigInfo(...)` æ–¹æ³•ä¼šè¢«å›è°ƒã€‚æˆ‘ä»¬é€šå¸¸ä¼šåœ¨è¿™é‡Œè°ƒç”¨ `refreshThreadPoolProperties(...)`ï¼Œå°†æœ€æ–°çš„é…ç½®ä¿¡æ¯è§£æå‡ºæ¥å¹¶åŠ¨æ€åˆ·æ–°çº¿ç¨‹æ± å‚æ•°ã€‚  
* 5.  
  **æ—¥å¿—è¾“å‡º** ï¼šä¸ºäº†æ–¹ä¾¿åç»­è¿ç»´æ’æŸ¥ï¼Œæ³¨å†ŒæˆåŠŸåä¼šæ‰“å°ä¸€æ¡ `info` çº§åˆ«çš„æ—¥å¿—ï¼Œæ˜ç¡®è¡¨ç¤ºç›‘å¬å™¨å·²ç»ç”Ÿæ•ˆã€‚

é…ç½®åˆ·æ–°è®²å¾—å†å¤šï¼Œä¸å¦‚ç›´æ¥çœ‹çœ‹"é•¿ä»€ä¹ˆæ ·"ã€‚ä¸‹å›¾å°±æ˜¯é…ç½®æ–‡ä»¶å˜æ›´åçš„å®é™…å†…å®¹æˆªå›¾ï¼Œé…åˆåé¢çš„è®²è§£ä¸€èµ·ç†è§£ä¼šæ›´æ¸…æ™°ã€‚

![image-20250715184829862.png](https://article-images.zsxq.com/FuI91qQOQK9sEZ2zbx_R7Ayp6SDM "image-20250715184829862.png")

### 2. é…ç½®å±æ€§åŠ¨æ€ç»‘å®š {#2}

é€šè¿‡å‰é¢çš„å±•ç¤ºï¼Œå¤§å®¶åº”è¯¥æ³¨æ„åˆ°äº†ï¼šNacos åœ¨é…ç½®å˜æ›´æ—¶ä¼ é€’ç»™ç›‘å¬å™¨çš„ï¼Œæ˜¯æ•´ä¸ªé…ç½®æ–‡ä»¶å†…å®¹çš„å­—ç¬¦ä¸²ã€‚ç”±äºæˆ‘ä»¬é…ç½®çš„æ˜¯ **YAMLæ ¼å¼** ï¼Œæ‰€ä»¥è¿™é‡Œæ¥æ”¶åˆ°çš„ä¹Ÿæ˜¯ä¸€æ•´æ®µ YAML å­—ç¬¦ä¸²ï¼ˆå¦‚æœæ˜¯ `properties` æ ¼å¼çš„é…ç½®ï¼ŒåŒç†è¿”å›çš„å°±æ˜¯ properties å­—ç¬¦ä¸²ï¼‰ã€‚

ä½†è¿™æ®µå­—ç¬¦ä¸²æ˜¯åŸå§‹å†…å®¹ï¼Œæ²¡æ³•ç›´æ¥ç”¨åœ¨ä¸šåŠ¡é€»è¾‘é‡Œã€‚é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿå¾ˆç®€å•ï¼š**å°†å®ƒè§£æä¸ºJavaå¯¹è±¡** ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œå°±æ˜¯å°†å®ƒè½¬æ¢ä¸º `BootstrapConfigProperties` å®ä¾‹ï¼Œåç»­çº¿ç¨‹æ± çš„åŠ¨æ€åˆ·æ–°æ‰å¯ä»¥è¿›è¡Œã€‚

ä¸‹é¢æ˜¯å…·ä½“çš„è§£æä»£ç é€»è¾‘ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public void refreshThreadPoolProperties(String configInfo) throws IOException {
        Map<Object, Object> configInfoMap = ConfigParserHandler.getInstance().parseConfig(configInfo, properties.getConfigFileType());
        ConfigurationPropertySource sources = new MapConfigurationPropertySource(configInfoMap);
        Binder binder = new Binder(sources);
    â€‹
        BootstrapConfigProperties refresherProperties = binder.bind(BootstrapConfigProperties.PREFIX, Bindable.ofInstance(properties)).get();
        log.info("Latest updated configuration: \n{}", configInfo);
        log.info("Java configuration object binding: \n{}", JSON.toJSONString(refresherProperties));
    â€‹
        // ...... æ£€æµ‹çº¿ç¨‹æ± å‚æ•°æ˜¯å¦å˜æ›´ï¼Œå¦‚æœå·²å˜æ›´åˆ™è¿›è¡Œæ›´æ–°
    }
              
#### 2.1 configInfo â†’ Mapï¼šé…ç½®å­—ç¬¦ä¸²è§£æ {#2-1-config-info-map}

`parseConfig` æ–¹æ³•å°†æ¥è‡ª Nacos çš„é…ç½®å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰è§£æä¸ºä¸€ä¸ªæ‰å¹³åŒ–çš„ `Map<Object, Object>`ï¼Œç”¨äºåç»­ç»‘å®šã€‚

è¿è¡Œæ—¶æˆªå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20250715190627335.png](https://article-images.zsxq.com/FpnmOiPAmPl1IrqEWfJAhJdtRMIe "image-20250715190627335.png")

é…ç½®è§£æå™¨ ConfigParserHandler æ–¹æ³•èŒè´£å¤§å®¶å·²ç»æ¸…æ¥šäº†ï¼Œä»£ç å¹¶ä¸å¤šä¹Ÿä¸éš¾ï¼Œç®€å•ç”¨åˆ°äº†å•ä¾‹å’Œç®€å•å·¥å‚æ¨¡å¼ï¼Œå¤§å®¶å¯ä»¥ç‚¹ Debug çœ‹ä¸‹ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

#### 2.2 Map â†’ PropertySourceï¼šé€‚é…ä¸º Spring é…ç½®æº {#2-2-map-property-source-spring}

å°† Map å°è£…ä¸º SpringBoot çš„ `ConfigurationPropertySource`ï¼Œè®©å…¶å…·å¤‡"é…ç½®ç»‘å®š"çš„èƒ½åŠ›ã€‚è¯¥èƒ½åŠ›ä¸º SpringBoot åŸç”Ÿæä¾›çš„èƒ½åŠ›ã€‚

åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªé…ç½®ç»‘å®šå™¨ï¼Œç”¨äºå°† `PropertySource` ä¸­çš„é…ç½®é¡¹ç»‘å®šåˆ° Java å¯¹è±¡ä¸Šã€‚`Binder` æ˜¯ SpringBoot çš„åº•å±‚ç»‘å®šå¼•æ“ï¼Œèƒ½å¤Ÿå°†é…ç½®æºçš„æ•°æ®ç»‘å®šåˆ° Java å¯¹è±¡ä¸­ã€‚
> å®ƒæ”¯æŒé»˜è®¤å€¼ã€åµŒå¥—å¯¹è±¡ã€é›†åˆã€æ³›å‹ã€ç±»å‹è½¬æ¢ç­‰å„ç§å¤æ‚é…ç½®çš„è‡ªåŠ¨ç»‘å®šé€»è¾‘ï¼ŒçœŸçš„æ˜¯å¼ºåˆ°ç¦»è°±ã€‚è®²ä¸ªçœŸäº‹ï¼Œæœ€æ—©æˆ‘è¿˜ä¸çŸ¥é“ SpringBoot æœ‰ `Binder` è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™ï¼ŒHippo4j è§£æå­—ç¬¦ä¸²é€»è¾‘æ˜¯è‡ªå·±ä¸€è¡Œè¡Œå†™è§£æé€»è¾‘ï¼Œéå†é…ç½®ã€æ‰‹åŠ¨ç±»å‹è½¬æ¢ã€åˆ¤ç©º......å†™å®Œé‚£æ®µä»£ç ï¼Œæˆ‘è‡ªå·±éƒ½è§‰å¾—åƒæ˜¯ä¸€å¨ã€‚ã€‚ã€‚

å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œè€ƒå¤äº†ä¸€ä¸‹ Hippo4j çš„æ—©æœŸæäº¤è®°å½•ï¼Œæœç„¶æƒ¨ä¸å¿ç¹ã€‚è¦ä¸æ˜¯ SpringBoot ç»™åŠ›ï¼Œå¤§å®¶ç°åœ¨è¿˜çœŸå¾—ç¿»æˆ‘é‚£æ®µ"é—ä½œ"è°ƒ Bug......  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                      /**
       * æ­¤å¤„é‡‡ç”¨ç¡¬ç¼–ç é€‚é…ä½ç‰ˆæœ¬ SpringBoot 1.5.x, å¦‚æœæœ‰æ›´å¥½çš„æ–¹æ³•è¿›è¡Œé€»è¾‘è½¬æ¢çš„è¯, æ¬¢è¿ PR.
       *
       * @param configInfo
       * @return
       */
      private static BootstrapCoreProperties adapt(Map<Object, Object> configInfo) {
          BootstrapCoreProperties bindableCoreProperties;
          try {
              // filter
              Map<Object, Object> targetMap = Maps.newHashMap();
              configInfo.forEach((key, val) -> {
                  if (key != null && StringUtil.isNotBlank((String) key) && ((String) key).indexOf(PREFIX + ".executors") != -1) {
                      String targetKey = key.toString().replace(PREFIX + ".", "");
                      targetMap.put(targetKey, val);
                  }
              });
    â€‹
              // convert
              List<ExecutorProperties> executorPropertiesList = Lists.newArrayList();
              for (int i = 0; i < Integer.MAX_VALUE; i++) {
                  Map<String, Object> tarterSingleMap = Maps.newHashMap();
    â€‹
                  for (Map.Entry entry : targetMap.entrySet()) {
                      String key = entry.getKey().toString();
                      if (key.indexOf(i + "") != -1) {
                          key = key.replace("executors[" + i + "].", "");
    â€‹
                          String[] keySplit = key.split("-");
                          if (keySplit != null && keySplit.length > 0) {
                              key = key.replace("-", "_");
                          }
    â€‹
                          tarterSingleMap.put(key, entry.getValue());
                      }
                  }
    â€‹
                  if (CollectionUtil.isEmpty(tarterSingleMap)) {
                      break;
                  }
    â€‹
                  ExecutorProperties executorProperties = BeanUtil.mapToBean(tarterSingleMap, ExecutorProperties.class, true, CopyOptions.create());
                  if (executorProperties != null) {
                      executorPropertiesList.add(executorProperties);
                  }
              }
    â€‹
              bindableCoreProperties = new BootstrapCoreProperties();
              bindableCoreProperties.setExecutors(executorPropertiesList);
          } catch (Exception ex) {
              throw ex;
          }
    â€‹
          return bindableCoreProperties;
      }
              
æ‰€ä»¥ï¼Œè¿™é‡Œå¿…é¡»å¾—æ€»ç»“ä¸€æ¡è¡€çš„æ•™è®­ï¼šå½“ä½ å‡†å¤‡æ‰‹æ’¸ä¸€äº›å¤æ‚åº•å±‚é€»è¾‘æ—¶ï¼Œåˆ«æ€¥ç€é—­é—¨é€ è½¦ã€‚å› ä¸ºä½ é‡åˆ°çš„é—®é¢˜ï¼Œå¤§æ¦‚ç‡å·²ç»è¢«æ— æ•°å¤§ä½¬è¸©è¿‡å‘äº†------å…³é”®æ˜¯ä»–ä»¬ä¸ä»…è¸©è¿‡ï¼Œè¿˜æŠŠè½®å­é€ å¾—åˆç¨³åˆå¸…ï¼Œæˆ‘ä»¬ç›´æ¥æ‹¿æ¥ç”¨ï¼Œçœæ—¶çœåŠ›è¿˜æ›´ä¸“ä¸šã€‚

#### 2.3 bind â†’ Javaå¯¹è±¡ï¼šç»‘å®šä¸ºé…ç½®ç±»å®ä¾‹ {#2-3-bind-java}

é€šè¿‡ `Binder` å°†é…ç½®æºçš„å†…å®¹ç»‘å®šåˆ°å·²æœ‰çš„ `properties` å¯¹è±¡ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªæœ€æ–°çš„é…ç½®å®ä¾‹ `refresherProperties`ã€‚å…¶ä¸­çš„ `"onethread"` æ˜¯ç»‘å®šçš„å‰ç¼€ï¼Œè¡¨ç¤ºåªä¼šæ³¨å…¥è¿™ä¸ªå‰ç¼€ä¸‹å¯¹åº”çš„é…ç½®å­—æ®µã€‚

åº•å±‚åŸç†æ˜¯ï¼šSpring Boot ä¼šä½¿ç”¨åå°„æœºåˆ¶ï¼Œæ ¹æ®é…ç½®é¡¹è‡ªåŠ¨è°ƒç”¨ JavaObject çš„ `setXxx()` æ–¹æ³•å®Œæˆå±æ€§èµ‹å€¼ï¼Œéå¸¸æ™ºèƒ½ã€‚

æœ€åçš„ `.get()` è¡¨ç¤ºå–å‡ºç»‘å®šç»“æœï¼Œ**æ³¨æ„** ï¼šå¦‚æœæ²¡æœ‰æˆåŠŸåŒ¹é…é…ç½®é¡¹ï¼Œè¿™é‡Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤é€šå¸¸åœ¨ç”Ÿäº§åœºæ™¯ä¸­å»ºè®®é…åˆ `Optional` æˆ– `orElse` è¿›è¡Œå…œåº•å¤„ç†ã€‚

### 3. Starter è‡ªåŠ¨è£…é… {#3-starter}

ä»¥ä¸Šå°±æ˜¯å®ç° **åŠ¨æ€çº¿ç¨‹æ± å‚æ•°ç›‘å¬ä¸åˆ·æ–°** çš„æ ¸å¿ƒé€»è¾‘ã€‚å’Œæˆ‘ä»¬ä¹‹å‰æ„å»º `common-spring-boot-starter` çš„è¿‡ç¨‹ä¸€æ ·ï¼Œè¿™é‡Œä¾ç„¶éµå¾ª **SpringBootStarterçš„è‡ªåŠ¨è£…é…ä¸‰éƒ¨æ›²** ï¼š

* 1.  
ç¼–å†™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆç›‘å¬é…ç½®å˜åŒ–ã€åˆ·æ–°çº¿ç¨‹æ± å‚æ•°ï¼‰ï¼›  
* 2.  
ç¼–å†™é…ç½®ç±»ï¼Œå°†æ ¸å¿ƒé€»è¾‘æ³¨å†Œä¸º Spring Beanï¼›  
* 3.  
  é€šè¿‡è‡ªåŠ¨è£…é…æœºåˆ¶è®© SpringBoot æ„ŸçŸ¥å¹¶åŠ è½½è¿™äº› Beanã€‚

éµå¾ªè¿™ä¸ªå¥—è·¯ï¼Œæˆ‘ä»¬å°±èƒ½é¡ºåˆ©å®ŒæˆåŸºäº Nacos çš„åŠ¨æ€çº¿ç¨‹æ± é…ç½®ç›‘å¬åŠŸèƒ½ã€‚

æ–‡æœ«æ€»ç»“
----

åŠ¨æ€çº¿ç¨‹æ± çš„æ ¸å¿ƒåœ¨äº"åŠ¨æ€"äºŒå­—ï¼Œè€Œè¿™ä¸ªåŠ¨æ€çš„èµ·ç‚¹ï¼Œå°±æ˜¯ç›‘å¬é…ç½®ä¸­å¿ƒçš„å˜æ›´äº‹ä»¶ã€‚æˆ‘ä»¬é€šè¿‡ç›‘å¬å™¨æ‹¿åˆ°æœ€æ–°é…ç½®ï¼Œè§£ææˆé…ç½®å¯¹è±¡åï¼Œå†äº¤ç”±åç»­é€»è¾‘å®Œæˆå‚æ•°åˆ·æ–°ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ— è®ºæ˜¯ Nacos æä¾›çš„å›è°ƒæœºåˆ¶ï¼Œè¿˜æ˜¯æˆ‘ä»¬å°è£…çš„é…ç½®è§£æä¸åˆ·æ–°é€»è¾‘ï¼Œéƒ½ä½“ç°äº† SpringBoot ä¸ä¸­é—´ä»¶æ·±åº¦é›†æˆçš„ä¼˜åŠ¿ã€‚

ä¸‹ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ·±å…¥æ¢ç´¢å‚æ•°å˜æ›´åï¼Œçº¿ç¨‹æ± æ˜¯å¦‚ä½•å®Œæˆæ›´æ–°çš„ï¼Œæ•¬è¯·æœŸå¾…ã€‚

å®Œç»“ï¼Œæ’’èŠ± ğŸ‰  
é€šè¿‡ Nacos å®ç°çº¿ç¨‹æ± å‚æ•°é…ç½®ï¼Œå…ƒæ•°æ®ä¿¡æ¯ï¼š

*  
ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± oneThreadï¼š<https://t.zsxq.com/5GfrN>  
*  
ä»£ç ä»“åº“ï¼š<https://gitcode.net/nageoffer/onethread> ------ ç”³è¯·é¡¹ç›®æƒé™å‚è€ƒä¸Šè¿°çº¿ç¨‹æ± é¡¹ç›®é“¾æ¥  
*  
ç« èŠ‚éš¾åº¦ï¼šâ˜…â˜…â˜…â˜†â˜† - è¾ƒéš¾  
*  
  è§†é¢‘åœ°å€ï¼šæ–‡æ¡£å…ˆè¡Œè§†é¢‘æ¬¡ä¹‹



*** ** * ** ***

å†…å®¹æ‘˜è¦ï¼šæœ¬èŠ‚ä¸»è¦è®²è§£äº†å½“ Nacos é…ç½®å‘ç”Ÿå˜æ›´æ—¶ï¼Œç›‘å¬å™¨æ¥æ”¶åˆ°çš„æ˜¯å®Œæ•´çš„é…ç½®æ–‡ä»¶å­—ç¬¦ä¸²å†…å®¹ï¼ˆå¦‚ YAML æ ¼å¼ï¼‰ã€‚ç”±äºè¿™ç±»å­—ç¬¦ä¸²æ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œè§£æï¼Œè½¬æ¢æˆå¯æ“ä½œçš„ Java å¯¹è±¡ï¼ˆå¦‚ `BootstrapConfigProperties`ï¼‰ï¼Œä»¥ä¾¿åç»­åŠ¨æ€åˆ·æ–°çº¿ç¨‹æ± é…ç½®ã€‚

è¯¾ç¨‹ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š

*  
ä»€ä¹ˆæ˜¯ Nacosï¼Ÿ  
*  
Nacos å¦‚ä½•å®Œæˆé…ç½®ç›‘å¬ï¼Ÿ  
*  
  æ–‡æœ«æ€»ç»“

ä»€ä¹ˆæ˜¯ Nacosï¼Ÿ {#nacos}
-------------------

> è¯¥ç« èŠ‚å–è‡ª [Nacos å®˜ç½‘](https://nacos.io/docs/v2.5/overview) Version 2.5ï¼Œæœ¬ç« èŠ‚é‡ç‚¹ä½¿ç”¨çš„æ˜¯ Nacos åŠ¨æ€é…ç½®æœåŠ¡ï¼Œå¦‚å·²äº†è§£å¯è·³è¿‡è¯¥å°èŠ‚ã€‚

Nacos `/nÉ‘:kÉ™ÊŠs/` æ˜¯ Dynamic Naming and Configuration Service çš„é¦–å­—æ¯ç®€ç§°ï¼Œä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚

Nacos è‡´åŠ›äºå¸®åŠ©æ‚¨å‘ç°ã€é…ç½®å’Œç®¡ç†å¾®æœåŠ¡ã€‚Nacos æä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚

Nacos å¸®åŠ©æ‚¨æ›´æ•æ·å’Œå®¹æ˜“åœ°æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡å¹³å°ã€‚ Nacos æ˜¯æ„å»ºä»¥\*\*"æœåŠ¡"\*\* ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ (ä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼) çš„æœåŠ¡åŸºç¡€è®¾æ–½ã€‚

### 1. äº§å“åŠŸèƒ½ {#1}

#### 1.1 æœåŠ¡å‘ç°å’ŒæœåŠ¡å¥åº·ç›‘æµ‹ {#1-1}

Nacos æ”¯æŒåŸºäº DNS å’ŒåŸºäº RPC çš„æœåŠ¡å‘ç°ã€‚æœåŠ¡æä¾›è€…ä½¿ç”¨åŸç”ŸSDKã€OpenAPIã€æˆ–ä¸€ä¸ªç‹¬ç«‹çš„ Agent æ³¨å†Œ Service åï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ä½¿ç”¨ HTTP\&API æŸ¥æ‰¾å’Œå‘ç°æœåŠ¡ã€‚

Nacos æä¾›å¯¹æœåŠ¡çš„å®æ—¶çš„å¥åº·æ£€æŸ¥ï¼Œé˜»æ­¢å‘ä¸å¥åº·çš„ä¸»æœºæˆ–æœåŠ¡å®ä¾‹å‘é€è¯·æ±‚ã€‚Nacos æ”¯æŒä¼ è¾“å±‚ (PING æˆ– TCP)å’Œåº”ç”¨å±‚ (å¦‚ HTTPã€MySQLã€ç”¨æˆ·è‡ªå®šä¹‰ï¼‰çš„å¥åº·æ£€æŸ¥ã€‚ å¯¹äºå¤æ‚çš„äº‘ç¯å¢ƒå’Œç½‘ç»œæ‹“æ‰‘ç¯å¢ƒä¸­ï¼ˆå¦‚ VPCã€è¾¹ç¼˜ç½‘ç»œç­‰ï¼‰æœåŠ¡çš„å¥åº·æ£€æŸ¥ï¼ŒNacos æä¾›äº† agent ä¸ŠæŠ¥æ¨¡å¼å’ŒæœåŠ¡ç«¯ä¸»åŠ¨æ£€æµ‹2ç§å¥åº·æ£€æŸ¥æ¨¡å¼ã€‚Nacos è¿˜æä¾›äº†ç»Ÿä¸€çš„å¥åº·æ£€æŸ¥ä»ªè¡¨ç›˜ï¼Œå¸®åŠ©æ‚¨æ ¹æ®å¥åº·çŠ¶æ€ç®¡ç†æœåŠ¡çš„å¯ç”¨æ€§åŠæµé‡ã€‚

#### 1.2 åŠ¨æ€é…ç½®æœåŠ¡ {#1-2}

åŠ¨æ€é…ç½®æœåŠ¡å¯ä»¥è®©æ‚¨ä»¥ä¸­å¿ƒåŒ–ã€å¤–éƒ¨åŒ–å’ŒåŠ¨æ€åŒ–çš„æ–¹å¼ç®¡ç†æ‰€æœ‰ç¯å¢ƒçš„åº”ç”¨é…ç½®å’ŒæœåŠ¡é…ç½®ã€‚

åŠ¨æ€é…ç½®æ¶ˆé™¤äº†é…ç½®å˜æ›´æ—¶é‡æ–°éƒ¨ç½²åº”ç”¨å’ŒæœåŠ¡çš„éœ€è¦ï¼Œè®©é…ç½®ç®¡ç†å˜å¾—æ›´åŠ é«˜æ•ˆå’Œæ•æ·ã€‚

é…ç½®ä¸­å¿ƒåŒ–ç®¡ç†è®©å®ç°æ— çŠ¶æ€æœåŠ¡å˜å¾—æ›´ç®€å•ï¼Œè®©æœåŠ¡æŒ‰éœ€å¼¹æ€§æ‰©å±•å˜å¾—æ›´å®¹æ˜“ã€‚

Nacos æä¾›äº†ä¸€ä¸ªç®€æ´æ˜“ç”¨çš„UI ([æ§åˆ¶å°æ ·ä¾‹ Demo](http://console.nacos.io/index.html?spm=5238cd80.72a042d5.0.0.5bc0cd36IfxBwB)) å¸®åŠ©æ‚¨ç®¡ç†æ‰€æœ‰çš„æœåŠ¡å’Œåº”ç”¨çš„é…ç½®ã€‚Nacos è¿˜æä¾›åŒ…æ‹¬é…ç½®ç‰ˆæœ¬è·Ÿè¸ªã€é‡‘ä¸é›€å‘å¸ƒã€ä¸€é”®å›æ»šé…ç½®ä»¥åŠå®¢æˆ·ç«¯é…ç½®æ›´æ–°çŠ¶æ€è·Ÿè¸ªåœ¨å†…çš„ä¸€ç³»åˆ—å¼€ç®±å³ç”¨çš„é…ç½®ç®¡ç†ç‰¹æ€§ï¼Œå¸®åŠ©æ‚¨æ›´å®‰å…¨åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç†é…ç½®å˜æ›´å’Œé™ä½é…ç½®å˜æ›´å¸¦æ¥çš„é£é™©ã€‚

#### 1.3 åŠ¨æ€ DNS æœåŠ¡ {#1-3-dns}

åŠ¨æ€ DNS æœåŠ¡æ”¯æŒæƒé‡è·¯ç”±ï¼Œè®©æ‚¨æ›´å®¹æ˜“åœ°å®ç°ä¸­é—´å±‚è´Ÿè½½å‡è¡¡ã€æ›´çµæ´»çš„è·¯ç”±ç­–ç•¥ã€æµé‡æ§åˆ¶ä»¥åŠæ•°æ®ä¸­å¿ƒå†…ç½‘çš„ç®€å•DNSè§£ææœåŠ¡ã€‚åŠ¨æ€DNSæœåŠ¡è¿˜èƒ½è®©æ‚¨æ›´å®¹æ˜“åœ°å®ç°ä»¥ DNS åè®®ä¸ºåŸºç¡€çš„æœåŠ¡å‘ç°ï¼Œä»¥å¸®åŠ©æ‚¨æ¶ˆé™¤è€¦åˆåˆ°å‚å•†ç§æœ‰æœåŠ¡å‘ç° API ä¸Šçš„é£é™©ã€‚

Nacos æä¾›äº†ä¸€äº›ç®€å•çš„ DNS APIs å¸®åŠ©æ‚¨ç®¡ç†æœåŠ¡çš„å…³è”åŸŸåå’Œå¯ç”¨çš„ IP åˆ—è¡¨ã€‚

#### 1.4 æœåŠ¡åŠå…¶å…ƒæ•°æ®ç®¡ç† {#1-4}

Nacos èƒ½è®©æ‚¨ä»å¾®æœåŠ¡å¹³å°å»ºè®¾çš„è§†è§’ç®¡ç†æ•°æ®ä¸­å¿ƒçš„æ‰€æœ‰æœåŠ¡åŠå…ƒæ•°æ®ï¼ŒåŒ…æ‹¬ç®¡ç†æœåŠ¡çš„æè¿°ã€ç”Ÿå‘½å‘¨æœŸã€æœåŠ¡çš„é™æ€ä¾èµ–åˆ†æã€æœåŠ¡çš„å¥åº·çŠ¶æ€ã€æœåŠ¡çš„æµé‡ç®¡ç†ã€è·¯ç”±åŠå®‰å…¨ç­–ç•¥ã€æœåŠ¡çš„ SLA ä»¥åŠæœ€é¦–è¦çš„ metrics ç»Ÿè®¡æ•°æ®ã€‚

### 2. äº§å“ä¼˜åŠ¿ {#2}

*  
**æ˜“äºä½¿ç”¨** ï¼šNacos ç»å†å‡ ä¸‡äººä½¿ç”¨åé¦ˆä¼˜åŒ–ï¼Œæä¾›ç»Ÿä¸€çš„æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†åŠŸèƒ½ï¼Œé€šè¿‡ç›´è§‚çš„ Web ç•Œé¢å’Œç®€æ´çš„ APIï¼Œä¸ºå¼€å‘å’Œè¿ç»´äººå‘˜åœ¨äº‘åŸç”Ÿç¯å¢ƒä¸­å¸¦æ¥äº†ä¾¿æ·çš„æœåŠ¡æ³¨å†Œã€å‘ç°å’Œé…ç½®æ›´æ–°æ“ä½œã€‚  
*  
**ç‰¹æ€§ä¸°å¯Œ** ï¼šNacos æä¾›äº†åŒ…æ‹¬æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†ã€åŠ¨æ€ DNS æœåŠ¡ã€æœåŠ¡å…ƒæ•°æ®ç®¡ç†ã€æµé‡ç®¡ç†ã€æœåŠ¡ç›‘æ§ã€æœåŠ¡æ²»ç†ç­‰åœ¨å†…çš„ä¸€ç³»åˆ—ç‰¹æ€§ï¼Œå¸®åŠ©æ‚¨åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œæ›´è½»æ¾çš„æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡ã€‚  
*  
**æè‡´æ€§èƒ½** ï¼šNacos ç»è¿‡é˜¿é‡ŒåŒåä¸€è¶…å¿«ä¼¸ç¼©åœºæ™¯çš„é”¤ç‚¼ï¼Œæä¾›é«˜æ€§èƒ½çš„æœåŠ¡æ³¨å†Œå’Œå‘ç°èƒ½åŠ›ï¼Œä»¥åŠä½å»¶è¿Ÿçš„é…ç½®æ›´æ–°å“åº”ï¼Œç¡®ä¿åœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„é«˜æ•ˆç‡å’Œç¨³å®šè¿è¡Œã€‚  
*  
**è¶…å¤§å®¹é‡** ï¼šNacos è¯ç”Ÿè‡ªé˜¿é‡Œçš„ç™¾ä¸‡å®ä¾‹è§„æ¨¡ï¼Œé€ å°±æ”¯æŒæµ·é‡æœåŠ¡å’Œé…ç½®çš„ç®¡ç†ï¼Œèƒ½å¤Ÿæ»¡è¶³å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿå¯¹é«˜å¹¶å‘å’Œé«˜å¯ç”¨æ€§çš„éœ€æ±‚ã€‚  
*  
**ç¨³å®šå¯ç”¨** ï¼šNacos é€šè¿‡è‡ªç ”çš„åŒæ­¥åè®®ï¼Œé…åˆç”Ÿæ€ä¸­åº”ç”¨å¹¿æ³›çš„ Raft åè®®ï¼Œç¡®ä¿äº†æœåŠ¡çš„é«˜å¯ç”¨æ€§å’Œæ•°æ®çš„ç¨³å®šæ€§ï¼Œä¿è¯é˜¿é‡ŒåŒåä¸€ç³»ç»Ÿçš„é«˜å¯ç”¨ç¨³å®šè¿è¡Œã€‚  
*  
  **å¼€æ”¾ç”Ÿæ€** ï¼šNacos æ‹¥æœ‰æ´»è·ƒçš„å¼€æºç¤¾åŒºã€å¹¿æ³›çš„ç”Ÿæ€æ•´åˆå’ŒæŒç»­çš„åˆ›æ–°å‘å±•ï¼Œä¸ä»…å¤§é‡å…¼å®¹äº† Spring Cloudã€Dubbo ç­‰å¤§å—æ¬¢è¿çš„å¼€æºæ¡†æ¶ã€è¿˜æä¾›äº†ä¸°å¯Œçš„æ’ä»¶åŒ–èƒ½åŠ›ï¼Œå¸®åŠ©ç”¨æˆ·åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œæä¾›å¯å®šåˆ¶æ»¡è¶³è‡ªèº«ç‰¹æ®Šéœ€æ±‚çš„ç‹¬æœ‰äº‘åŸç”Ÿå¾®æœåŠ¡ç³»ç»Ÿã€‚

### 3. è®¾è®¡ç†å¿µ {#3}

> æˆ‘ä»¬ç›¸ä¿¡ä¸€åˆ‡éƒ½æ˜¯æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡èŠ‚ç‚¹è¢«æ„æƒ³ä¸ºä¸€ä¸ªæ˜Ÿçƒï¼Œæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€ä¸ªæ˜Ÿç³»ã€‚Nacos è‡´åŠ›äºå¸®åŠ©å»ºç«‹è¿™äº›æœåŠ¡ä¹‹é—´çš„**è¿æ¥** ï¼ŒåŠ©åŠ›æ¯ä¸ªé¢å‘æ˜Ÿè¾°çš„æ¢¦æƒ³èƒ½å¤Ÿé€è¿‡äº‘å±‚ï¼Œé£åœ¨äº‘ä¸Šï¼Œæ›´å¥½çš„é“¾æ¥æ•´ç‰‡æ˜Ÿç©ºã€‚

Nacoså¸Œæœ›å¸®åŠ©ç”¨æˆ·åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œåœ¨ç§æœ‰äº‘ã€æ··åˆäº‘æˆ–è€…å…¬æœ‰äº‘ç­‰æ‰€æœ‰äº‘ç¯å¢ƒä¸­ï¼Œæ›´å¥½çš„æ„å»ºã€äº¤ä»˜ã€ç®¡ç†è‡ªå·±çš„å¾®æœåŠ¡å¹³å°ï¼Œæ›´å¿«çš„å¤ç”¨å’Œç»„åˆä¸šåŠ¡æœåŠ¡ï¼Œæ›´å¿«çš„äº¤ä»˜å•†ä¸šåˆ›æ–°çš„ä»·å€¼ï¼Œä»è€Œä¸ºç”¨æˆ·èµ¢å¾—å¸‚åœºã€‚æ­£æ˜¯åŸºäºè¿™ä¸€æ„¿æ™¯ï¼ŒNacosçš„è®¾è®¡ç†å¿µè¢«å®šä½ä¸º`æ˜“äºä½¿ç”¨`ã€`é¢å‘æ ‡å‡†`ã€`é«˜å¯ç”¨`å’Œ`æ–¹ä¾¿æ‰©å±•`ã€‚

![image.png](https://article-images.zsxq.com/FhHLKQNLcrcqSVCCoJ3GgZvlm0Ei "image.png")

#### 3.1 æ˜“äºä½¿ç”¨ {#3-1}

æ˜“äºä½¿ç”¨æ˜¯ Nacos çš„ä¸€ä¸ªæ ¸å¿ƒç†å¿µï¼Œå®ƒé€šè¿‡æä¾›ç”¨æˆ·å‹å¥½çš„ Web ç•Œé¢å’Œç®€æ´çš„ API æ¥ç®€åŒ–æœåŠ¡çš„æ³¨å†Œã€å‘ç°å’Œé…ç½®ç®¡ç†è¿‡ç¨‹ã€‚å¼€å‘è€…å¯ä»¥è½»æ¾é›†æˆ Nacos åˆ°ä»–ä»¬çš„åº”ç”¨ä¸­ï¼Œæ— éœ€æŠ•å…¥å¤§é‡æ—¶é—´åœ¨å¤æ‚çš„è®¾ç½®å’Œå­¦ä¹ ä¸Šã€‚

#### 3.2 é¢å‘æ ‡å‡† {#3-2}

Nacos é‡‡ç”¨é¢å‘æ ‡å‡†çš„è®¾è®¡ç†å¿µï¼Œéµå¾ªäº‘åŸç”Ÿåº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µå’Œæ ‡å‡†åè®®ï¼Œä»¥ç¡®ä¿å…¶æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†åŠŸèƒ½ä¸å¹¿æ³›çš„æŠ€æœ¯æ ˆå’Œå¹³å°æ— ç¼å¯¹æ¥ã€‚

#### 3.3 é«˜å¯ç”¨ {#3-3}

ä¸ºäº†æ»¡è¶³ä¼ä¸šçº§åº”ç”¨å¯¹é«˜å¯ç”¨çš„éœ€æ±‚ï¼ŒNacos å®ç°äº†é›†ç¾¤æ¨¡å¼ï¼Œç¡®ä¿åœ¨èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ï¼ŒæœåŠ¡çš„å‘ç°å’Œé…ç½®ç®¡ç†åŠŸèƒ½ä¸ä¼šå—å½±å“ã€‚é›†ç¾¤æ¨¡å¼ä¹Ÿæ„å‘³ç€ Nacos å¯ä»¥é€šè¿‡å¢åŠ èŠ‚ç‚¹æ¥æ°´å¹³æ‰©å±•ï¼Œæå‡ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½å’Œæ‰¿è½½èƒ½åŠ›ã€‚

![image.png](https://article-images.zsxq.com/Ful0-ca1czSHxE6seFD10ti0wuFz "image.png")

#### 3.4 æ–¹ä¾¿æ‰©å±• {#3-4}

Nacos è¿˜æ³¨é‡æ˜“äºæ‰©å±•ï¼Œå®ƒé‡‡ç”¨äº†æ¨¡å—åŒ–çš„è®¾è®¡ä½¿å¾—å„ä¸ªç»„ä»¶éƒ½å¯ä»¥ç‹¬ç«‹åœ°è¿›è¡Œæ‰©å±•æˆ–æ›¿æ¢ã€‚è¿™ä¹Ÿä¸ºç¤¾åŒºè´¡çŒ®è€…æä¾›äº†æ–¹ä¾¿ï¼Œä½¿ä»–ä»¬èƒ½å¤Ÿé’ˆå¯¹ç‰¹å®šçš„éœ€æ±‚å¼€å‘æ–°çš„åŠŸèƒ½æˆ–è€…æ”¹å–„ç°æœ‰åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æ¨åŠ¨ Nacos çš„ç”Ÿæ€å‘å±•ã€‚

![image.png](https://article-images.zsxq.com/FuYbQ9uL7c0Jx25R0YxEhN1wqAQX "image.png")

é€šè¿‡ä¸Šè¿°è®¾è®¡ç†å¿µçš„å®ç°ï¼ŒNacos ä¸ºç”¨æˆ·æä¾›äº†ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„å¹³å°ï¼Œä»¥æ”¯æŒä¸æ–­å˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚ï¼ŒåŠ é€Ÿä¸šåŠ¡åˆ›æ–°å’Œæ•°å­—è½¬å‹ï¼Œæœ€ç»ˆå¸®åŠ©ç”¨æˆ·åœ¨ç«äº‰æ¿€çƒˆçš„å¸‚åœºä¸­å æ®æœ‰åˆ©åœ°ä½ã€‚

Nacos å¦‚ä½•å®Œæˆé…ç½®ç›‘å¬ï¼Ÿ {#nacos}
------------------------

ç”±äº Nacos çš„å®Œæ•´é…ç½®å˜æ›´ç›‘å¬æœºåˆ¶æ¶‰åŠåˆ°æ¨¡æ¿æ–¹æ³•ã€è§‚å¯Ÿè€…æ¨¡å¼ç­‰è¿›é˜¶è®¾è®¡æ¨¡å¼ï¼Œæ•´ä½“æµç¨‹ç›¸å¯¹å¤æ‚ã€‚ä¸ºäº†è®©å¤§å®¶æ›´å®¹æ˜“ç†è§£å’Œå¾ªåºæ¸è¿›åœ°æŒæ¡ç›¸å…³åŸç†ï¼ŒBreatheå°†æ‹†åˆ†ä¸ºå¤šä¸ªç« èŠ‚è®²è§£ã€‚æœŸé—´å¦‚æœä½ çœ‹åˆ°æ–‡æ¡£æŸäº›ç±»ååç¼€å¸¦æœ‰ V1ã€V2 ç­‰å­—æ ·ï¼Œä»£è¡¨è¿™æ˜¯æ¼”è¿›è¿‡ç¨‹ä¸­çš„é˜¶æ®µæ€§ç‰ˆæœ¬ä»£ç ï¼Œæ–¹ä¾¿å¤§å®¶è·Ÿè¿›ç†è§£ã€‚
> æœ¬ç« èŠ‚çš„é‡ç‚¹å†…å®¹é›†ä¸­åœ¨ä¸¤ä¸ªæ¨¡å—ï¼š`common-spring-boot-starter` å’Œ `nacos-cloud-spring-boot-starter`ã€‚

ä»æ•´ä½“ä¸Šçœ‹ï¼ŒåŠ¨æ€çº¿ç¨‹æ± å‚æ•°å˜æ›´çš„æµç¨‹å…¶å®å¹¶ä¸å¤æ‚ï¼Œå¯ä»¥ç±»æ¯”ä¸º"æŠŠå¤§è±¡è£…è¿›å†°ç®±"çš„ä¸‰æ­¥èµ°ï¼š

* 1.  
**ç›‘å¬é…ç½®å˜æ›´** ï¼šSpringBoot æ³¨å†Œäº†ç›‘å¬å™¨ï¼Œä¸€æ—¦æ£€æµ‹åˆ° Nacos é…ç½®æ–‡ä»¶å‘ç”Ÿå˜æ›´ï¼Œç«‹å³è·å–æœ€æ–°çš„é…ç½®ä¿¡æ¯ï¼›  
* 2.  
**å‚æ•°ç»‘å®š** ï¼šå°†æ¥æ”¶åˆ°çš„æœ€æ–°é…ç½®å†…å®¹ï¼Œç»‘å®šåˆ° `BootstrapConfigProperties` å¯¹è±¡ä¸­ï¼Œå®Œæˆå­—ç¬¦ä¸² â†’ Java å¯¹è±¡çš„è½¬æ¢ï¼›  
* 3.  
  **æ›´æ–°çº¿ç¨‹æ± ** ï¼šé€šè¿‡ `BootstrapConfigProperties` ä¸å½“å‰çº¿ç¨‹æ± å‚æ•°è¿›è¡Œæ¯”å¯¹ï¼Œå‘ç°å˜æ›´åˆ™æ‰§è¡Œæ›´æ–°æ“ä½œï¼Œæ— å˜æ›´åˆ™è·³è¿‡ï¼Œé¿å…æ— æ„ä¹‰åˆ·æ–°ã€‚

ä¸ºäº†å¸®åŠ©å¤§å®¶å¿«é€Ÿç†æ¸…æµç¨‹ï¼Œè¿™é‡Œå…ˆæ”¾ä¸Šä¸€å¼ **æ—¶åºå›¾** ï¼Œå¸®åŠ©å¤§å®¶å¯¹æ•´ä½“æ‰§è¡Œè¿‡ç¨‹æœ‰ä¸ªåˆæ­¥çš„ç†è§£ï¼š

![image-20250715175156406.png](https://article-images.zsxq.com/FubBL66Iesi7afmCmfqnmbK_N-ok "image-20250715175156406.png")

å¦‚æœå¤§å®¶æƒ³è¦ä½¿ç”¨ Nacosï¼Œéœ€è¦åœ¨ pom.xml æ–‡ä»¶ä¸­æ·»åŠ å¯¹åº”çš„ä¾èµ–ï¼ŒNacos åœ¨ SpringCloud é¢†åŸŸå¯¹åº”çš„ä¾èµ–ä¸ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
              
å› ä¸ºå’±ä»¬åœ¨æ ¹èŠ‚ç‚¹è¿›è¡Œäº†ç‰ˆæœ¬ç®¡ç†ï¼Œæ‰€ä»¥åœ¨ `nacos-cloud-spring-boot-starter` ç»„ä»¶ä¸­åªéœ€è¦å†™ä¾èµ–å³å¯ã€‚

### 1. æ³¨å†Œ Nacos Listener {#1-nacos-listener}

ä» Nacos æä¾›çš„é…ç½®ä¸­å¿ƒæŠ½è±¡æ¥å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€æ˜¯ `addListener`ï¼Œç”¨äºæ³¨å†Œé…ç½®å˜æ›´ç›‘å¬å™¨ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public interface ConfigService {
        // ......
        /**
         * Add a listener to the configuration, after the server modified the configuration, the client will use the
         * incoming listener callback. Recommended asynchronous processing, the application can implement the getExecutor
         * method in the ManagerListener, provide a thread pool of execution. If not provided, use the main thread callback, May
         * block other configurations or be blocked by other configurations.
         *
         * @param dataId   dataId
         * @param group    group
         * @param listener listener
         * @throws NacosException NacosException
         */
        void addListener(String dataId, String group, Listener listener) throws NacosException;
        // ......
    }
              
ä¸‹é¢æ˜¯ `addListener` æ–¹æ³•çš„æ³¨é‡Šç¿»è¯‘ï¼Œæ–¹ä¾¿å¤§å®¶æ›´å¥½ç†è§£å®ƒçš„ä½œç”¨ï¼š
> å‘é…ç½®æ·»åŠ ç›‘å¬å™¨ï¼Œå½“æœåŠ¡ç«¯ä¿®æ”¹é…ç½®åï¼Œå®¢æˆ·ç«¯ä¼šé€šè¿‡ä¼ å…¥çš„ç›‘å¬å™¨è¿›è¡Œå›è°ƒã€‚æ¨èä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œåº”ç”¨å¯ä»¥åœ¨ `ManagerListener` ä¸­å®ç° `getExecutor` æ–¹æ³•ï¼Œæä¾›ä¸€ä¸ªç”¨äºæ‰§è¡Œçš„çº¿ç¨‹æ± ã€‚å¦‚æœæ²¡æœ‰æä¾›ï¼Œå°†ä½¿ç”¨ä¸»çº¿ç¨‹è¿›è¡Œå›è°ƒï¼Œè¿™å¯èƒ½ä¼šé˜»å¡å…¶ä»–é…ç½®ï¼Œæˆ–è¢«å…¶ä»–é…ç½®é˜»å¡ã€‚

æ¥ä¸‹æ¥å°±æ˜¯åœ¨ä»€ä¹ˆæ—¶æœºè¿›è¡Œæ·»åŠ ç›‘å¬å‘¢ï¼Ÿæ¯•ç«Ÿä½ å†™ä¸ªæ·»åŠ ç›‘å¬æ–¹æ³•æ€»è¦è¢«è°ƒç”¨æ‰èƒ½ç”Ÿæ•ˆã€‚è¿™é‡Œä½¿ç”¨ SpringBoot æ‰©å±•æ¥å£ `ApplicationRunner` å®ç°ï¼Œä¸€ä¸ªå¯åŠ¨æ—¶è‡ªåŠ¨å›è°ƒçš„"é’©å­"æ¥å£ã€‚

*  
**è§¦å‘æ—¶æœº** ï¼šåœ¨ Spring å®¹å™¨å®Œæˆåˆå§‹åŒ–ã€æ‰€æœ‰ Bean éƒ½åŠ è½½å¥½ã€å¹¶ä¸”åº”ç”¨å‡†å¤‡å°±ç»ªåè‡ªåŠ¨è°ƒç”¨ã€‚  
*  
  **å…¸å‹ç”¨é€”** ï¼šåšé¡¹ç›®å¯åŠ¨åçš„é¢„åŠ è½½ã€æ³¨å†Œç›‘å¬å™¨ã€åˆå§‹åŒ–ç¼“å­˜ã€å¯åŠ¨ä»»åŠ¡ã€æ£€æŸ¥é…ç½®ç­‰ä¸€åˆ‡éœ€è¦åœ¨å¯åŠ¨åé©¬ä¸Šåšçš„æ“ä½œã€‚

æœ‰åŒå­¦å¯èƒ½ä¼šå¥½å¥‡ï¼š"Breatheï¼Œä¸ºä»€ä¹ˆä½ ä¸ç”¨ `CommandLineRunner` å‘¢ï¼Ÿ"å…¶å®æ— æ‰€è°“ï¼Œ**åœ¨å’±ä»¬è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œ`ApplicationRunner`å’Œ`CommandLineRunner`ç”¨å“ªä¸ªéƒ½è¡Œï¼Œä¸»è¦çœ‹å¿ƒæƒ…ï¼Œæ•ˆæœä¸Šæ²¡æœ‰æœ¬è´¨åŒºåˆ«** ã€‚

å¥½ï¼Œå’±ä»¬ç»§ç»­å¾€ä¸‹çœ‹ ------ **æ¥çœ‹ä¸‹æ³¨å†Œé…ç½®ç›‘å¬çš„æ–¹æ³•æ˜¯æ€ä¹ˆå®ç°çš„ï¼š**  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @Slf4j
    @RequiredArgsConstructor
    public class NacosCloudRefresherHandlerV1 implements ApplicationRunner {
    â€‹
        private final ConfigService configService;
        private final BootstrapConfigProperties properties;
    â€‹
        @Override
        public void run(ApplicationArguments args) throws Exception {
            BootstrapConfigProperties.NacosConfig nacosConfig = properties.getNacos();
            configService.addListener(
                    nacosConfig.getDataId(),
                    nacosConfig.getGroup(),
                    new Listener() {
    â€‹
                        @Override
                        public Executor getExecutor() {
                            return ThreadPoolExecutorBuilder.builder()
                                    .corePoolSize(1)
                                    .maximumPoolSize(1)
                                    .keepAliveTime(9999L)
                                    .workQueueType(BlockingQueueTypeEnum.SYNCHRONOUS_QUEUE)
                                    .threadFactory("clod-nacos-refresher-thread_")
                                    .rejectedHandler(new ThreadPoolExecutor.CallerRunsPolicy())
                                    .build();
                        }
    â€‹
                        @Override
                        public void receiveConfigInfo(String configInfo) {
                            // å¦‚æœ Nacos é…ç½®æ–‡ä»¶å˜æ›´ï¼Œä¼šè§¦å‘è¯¥æ–¹æ³•è¿›è¡Œå›è°ƒ
                        }
                    });
    â€‹
            log.info("Dynamic thread pool refresher, add nacos cloud listener success. data-id: {}, group: {}", nacosConfig.getDataId(), nacosConfig.getGroup());
        }
    }
              
æ–¹æ³•çš„å…·ä½“é€»è¾‘å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

* 1.  
**è·å–Nacosé…ç½®å‚æ•°** ï¼šé¦–å…ˆï¼Œé€šè¿‡ `properties.getNacos()` è·å–é…ç½®ä¸­å¿ƒçš„å…³é”®å‚æ•°ï¼Œæ¯”å¦‚ `dataId` å’Œ `group`ï¼Œè¿™ä¸¤ä¸ªå­—æ®µå…±åŒç¡®å®šäº†å”¯ä¸€çš„é…ç½®æ–‡ä»¶ä½ç½®ã€‚  
* 2.  
**æ³¨å†Œé…ç½®å˜æ›´ç›‘å¬å™¨** ï¼šæ¥ç€è°ƒç”¨ `configService.addListener(...)` æ–¹æ³•ï¼Œå‘æŒ‡å®šçš„ `dataId` å’Œ `group` æ³¨å†Œç›‘å¬å™¨ã€‚ä¸€æ—¦ Nacos ç«¯å¯¹åº”çš„é…ç½®å‘ç”Ÿå˜æ›´ï¼Œç›‘å¬å™¨å°±ä¼šè¢«è‡ªåŠ¨è§¦å‘ã€‚  
* 3.  
**è‡ªå®šä¹‰Listenerçš„æ‰§è¡Œçº¿ç¨‹æ± ** ï¼šåœ¨åŒ¿å `Listener` å®ç°ä¸­ï¼Œé‡å†™äº† `getExecutor()` æ–¹æ³•ï¼Œè‡ªå®šä¹‰äº†ä¸€ä¸ª**å•çº¿ç¨‹æ± ** æ¥å¼‚æ­¥æ‰§è¡Œå›è°ƒé€»è¾‘ï¼Œé¿å…é˜»å¡ Nacos å®¢æˆ·ç«¯çš„ä¸»çº¿ç¨‹ï¼ŒåŒæ—¶ä¹Ÿè§„é¿äº†å¹¶å‘å¸¦æ¥çš„å‰¯ä½œç”¨ã€‚  
* 4.  
**é…ç½®å˜æ›´å›è°ƒ** ï¼šå½“é…ç½®å‘ç”Ÿå˜æ›´æ—¶ï¼Œ`receiveConfigInfo(...)` æ–¹æ³•ä¼šè¢«å›è°ƒã€‚æˆ‘ä»¬é€šå¸¸ä¼šåœ¨è¿™é‡Œè°ƒç”¨ `refreshThreadPoolProperties(...)`ï¼Œå°†æœ€æ–°çš„é…ç½®ä¿¡æ¯è§£æå‡ºæ¥å¹¶åŠ¨æ€åˆ·æ–°çº¿ç¨‹æ± å‚æ•°ã€‚  
* 5.  
  **æ—¥å¿—è¾“å‡º** ï¼šä¸ºäº†æ–¹ä¾¿åç»­è¿ç»´æ’æŸ¥ï¼Œæ³¨å†ŒæˆåŠŸåä¼šæ‰“å°ä¸€æ¡ `info` çº§åˆ«çš„æ—¥å¿—ï¼Œæ˜ç¡®è¡¨ç¤ºç›‘å¬å™¨å·²ç»ç”Ÿæ•ˆã€‚

é…ç½®åˆ·æ–°è®²å¾—å†å¤šï¼Œä¸å¦‚ç›´æ¥çœ‹çœ‹"é•¿ä»€ä¹ˆæ ·"ã€‚ä¸‹å›¾å°±æ˜¯é…ç½®æ–‡ä»¶å˜æ›´åçš„å®é™…å†…å®¹æˆªå›¾ï¼Œé…åˆåé¢çš„è®²è§£ä¸€èµ·ç†è§£ä¼šæ›´æ¸…æ™°ã€‚

![image-20250715184829862.png](https://article-images.zsxq.com/FuI91qQOQK9sEZ2zbx_R7Ayp6SDM "image-20250715184829862.png")

### 2. é…ç½®å±æ€§åŠ¨æ€ç»‘å®š {#2}

é€šè¿‡å‰é¢çš„å±•ç¤ºï¼Œå¤§å®¶åº”è¯¥æ³¨æ„åˆ°äº†ï¼šNacos åœ¨é…ç½®å˜æ›´æ—¶ä¼ é€’ç»™ç›‘å¬å™¨çš„ï¼Œæ˜¯æ•´ä¸ªé…ç½®æ–‡ä»¶å†…å®¹çš„å­—ç¬¦ä¸²ã€‚ç”±äºæˆ‘ä»¬é…ç½®çš„æ˜¯ **YAMLæ ¼å¼** ï¼Œæ‰€ä»¥è¿™é‡Œæ¥æ”¶åˆ°çš„ä¹Ÿæ˜¯ä¸€æ•´æ®µ YAML å­—ç¬¦ä¸²ï¼ˆå¦‚æœæ˜¯ `properties` æ ¼å¼çš„é…ç½®ï¼ŒåŒç†è¿”å›çš„å°±æ˜¯ properties å­—ç¬¦ä¸²ï¼‰ã€‚

ä½†è¿™æ®µå­—ç¬¦ä¸²æ˜¯åŸå§‹å†…å®¹ï¼Œæ²¡æ³•ç›´æ¥ç”¨åœ¨ä¸šåŠ¡é€»è¾‘é‡Œã€‚é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿå¾ˆç®€å•ï¼š**å°†å®ƒè§£æä¸ºJavaå¯¹è±¡** ã€‚åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œå°±æ˜¯å°†å®ƒè½¬æ¢ä¸º `BootstrapConfigProperties` å®ä¾‹ï¼Œåç»­çº¿ç¨‹æ± çš„åŠ¨æ€åˆ·æ–°æ‰å¯ä»¥è¿›è¡Œã€‚

ä¸‹é¢æ˜¯å…·ä½“çš„è§£æä»£ç é€»è¾‘ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public void refreshThreadPoolProperties(String configInfo) throws IOException {
        Map<Object, Object> configInfoMap = ConfigParserHandler.getInstance().parseConfig(configInfo, properties.getConfigFileType());
        ConfigurationPropertySource sources = new MapConfigurationPropertySource(configInfoMap);
        Binder binder = new Binder(sources);
    â€‹
        BootstrapConfigProperties refresherProperties = binder.bind(BootstrapConfigProperties.PREFIX, Bindable.ofInstance(properties)).get();
        log.info("Latest updated configuration: \n{}", configInfo);
        log.info("Java configuration object binding: \n{}", JSON.toJSONString(refresherProperties));
    â€‹
        // ...... æ£€æµ‹çº¿ç¨‹æ± å‚æ•°æ˜¯å¦å˜æ›´ï¼Œå¦‚æœå·²å˜æ›´åˆ™è¿›è¡Œæ›´æ–°
    }
              
#### 2.1 configInfo â†’ Mapï¼šé…ç½®å­—ç¬¦ä¸²è§£æ {#2-1-config-info-map}

`parseConfig` æ–¹æ³•å°†æ¥è‡ª Nacos çš„é…ç½®å†…å®¹ï¼ˆå­—ç¬¦ä¸²ï¼‰è§£æä¸ºä¸€ä¸ªæ‰å¹³åŒ–çš„ `Map<Object, Object>`ï¼Œç”¨äºåç»­ç»‘å®šã€‚

è¿è¡Œæ—¶æˆªå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20250715190627335.png](https://article-images.zsxq.com/FpnmOiPAmPl1IrqEWfJAhJdtRMIe "image-20250715190627335.png")

é…ç½®è§£æå™¨ ConfigParserHandler æ–¹æ³•èŒè´£å¤§å®¶å·²ç»æ¸…æ¥šäº†ï¼Œä»£ç å¹¶ä¸å¤šä¹Ÿä¸éš¾ï¼Œç®€å•ç”¨åˆ°äº†å•ä¾‹å’Œç®€å•å·¥å‚æ¨¡å¼ï¼Œå¤§å®¶å¯ä»¥ç‚¹ Debug çœ‹ä¸‹ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

#### 2.2 Map â†’ PropertySourceï¼šé€‚é…ä¸º Spring é…ç½®æº {#2-2-map-property-source-spring}

å°† Map å°è£…ä¸º SpringBoot çš„ `ConfigurationPropertySource`ï¼Œè®©å…¶å…·å¤‡"é…ç½®ç»‘å®š"çš„èƒ½åŠ›ã€‚è¯¥èƒ½åŠ›ä¸º SpringBoot åŸç”Ÿæä¾›çš„èƒ½åŠ›ã€‚

åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªé…ç½®ç»‘å®šå™¨ï¼Œç”¨äºå°† `PropertySource` ä¸­çš„é…ç½®é¡¹ç»‘å®šåˆ° Java å¯¹è±¡ä¸Šã€‚`Binder` æ˜¯ SpringBoot çš„åº•å±‚ç»‘å®šå¼•æ“ï¼Œèƒ½å¤Ÿå°†é…ç½®æºçš„æ•°æ®ç»‘å®šåˆ° Java å¯¹è±¡ä¸­ã€‚
> å®ƒæ”¯æŒé»˜è®¤å€¼ã€åµŒå¥—å¯¹è±¡ã€é›†åˆã€æ³›å‹ã€ç±»å‹è½¬æ¢ç­‰å„ç§å¤æ‚é…ç½®çš„è‡ªåŠ¨ç»‘å®šé€»è¾‘ï¼ŒçœŸçš„æ˜¯å¼ºåˆ°ç¦»è°±ã€‚è®²ä¸ªçœŸäº‹ï¼Œæœ€æ—©æˆ‘è¿˜ä¸çŸ¥é“ SpringBoot æœ‰ `Binder` è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™ï¼ŒHippo4j è§£æå­—ç¬¦ä¸²é€»è¾‘æ˜¯è‡ªå·±ä¸€è¡Œè¡Œå†™è§£æé€»è¾‘ï¼Œéå†é…ç½®ã€æ‰‹åŠ¨ç±»å‹è½¬æ¢ã€åˆ¤ç©º......å†™å®Œé‚£æ®µä»£ç ï¼Œæˆ‘è‡ªå·±éƒ½è§‰å¾—åƒæ˜¯ä¸€å¨ã€‚ã€‚ã€‚

å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œè€ƒå¤äº†ä¸€ä¸‹ Hippo4j çš„æ—©æœŸæäº¤è®°å½•ï¼Œæœç„¶æƒ¨ä¸å¿ç¹ã€‚è¦ä¸æ˜¯ SpringBoot ç»™åŠ›ï¼Œå¤§å®¶ç°åœ¨è¿˜çœŸå¾—ç¿»æˆ‘é‚£æ®µ"é—ä½œ"è°ƒ Bug......  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                      /**
       * æ­¤å¤„é‡‡ç”¨ç¡¬ç¼–ç é€‚é…ä½ç‰ˆæœ¬ SpringBoot 1.5.x, å¦‚æœæœ‰æ›´å¥½çš„æ–¹æ³•è¿›è¡Œé€»è¾‘è½¬æ¢çš„è¯, æ¬¢è¿ PR.
       *
       * @param configInfo
       * @return
       */
      private static BootstrapCoreProperties adapt(Map<Object, Object> configInfo) {
          BootstrapCoreProperties bindableCoreProperties;
          try {
              // filter
              Map<Object, Object> targetMap = Maps.newHashMap();
              configInfo.forEach((key, val) -> {
                  if (key != null && StringUtil.isNotBlank((String) key) && ((String) key).indexOf(PREFIX + ".executors") != -1) {
                      String targetKey = key.toString().replace(PREFIX + ".", "");
                      targetMap.put(targetKey, val);
                  }
              });
    â€‹
              // convert
              List<ExecutorProperties> executorPropertiesList = Lists.newArrayList();
              for (int i = 0; i < Integer.MAX_VALUE; i++) {
                  Map<String, Object> tarterSingleMap = Maps.newHashMap();
    â€‹
                  for (Map.Entry entry : targetMap.entrySet()) {
                      String key = entry.getKey().toString();
                      if (key.indexOf(i + "") != -1) {
                          key = key.replace("executors[" + i + "].", "");
    â€‹
                          String[] keySplit = key.split("-");
                          if (keySplit != null && keySplit.length > 0) {
                              key = key.replace("-", "_");
                          }
    â€‹
                          tarterSingleMap.put(key, entry.getValue());
                      }
                  }
    â€‹
                  if (CollectionUtil.isEmpty(tarterSingleMap)) {
                      break;
                  }
    â€‹
                  ExecutorProperties executorProperties = BeanUtil.mapToBean(tarterSingleMap, ExecutorProperties.class, true, CopyOptions.create());
                  if (executorProperties != null) {
                      executorPropertiesList.add(executorProperties);
                  }
              }
    â€‹
              bindableCoreProperties = new BootstrapCoreProperties();
              bindableCoreProperties.setExecutors(executorPropertiesList);
          } catch (Exception ex) {
              throw ex;
          }
    â€‹
          return bindableCoreProperties;
      }
              
æ‰€ä»¥ï¼Œè¿™é‡Œå¿…é¡»å¾—æ€»ç»“ä¸€æ¡è¡€çš„æ•™è®­ï¼šå½“ä½ å‡†å¤‡æ‰‹æ’¸ä¸€äº›å¤æ‚åº•å±‚é€»è¾‘æ—¶ï¼Œåˆ«æ€¥ç€é—­é—¨é€ è½¦ã€‚å› ä¸ºä½ é‡åˆ°çš„é—®é¢˜ï¼Œå¤§æ¦‚ç‡å·²ç»è¢«æ— æ•°å¤§ä½¬è¸©è¿‡å‘äº†------å…³é”®æ˜¯ä»–ä»¬ä¸ä»…è¸©è¿‡ï¼Œè¿˜æŠŠè½®å­é€ å¾—åˆç¨³åˆå¸…ï¼Œæˆ‘ä»¬ç›´æ¥æ‹¿æ¥ç”¨ï¼Œçœæ—¶çœåŠ›è¿˜æ›´ä¸“ä¸šã€‚

#### 2.3 bind â†’ Javaå¯¹è±¡ï¼šç»‘å®šä¸ºé…ç½®ç±»å®ä¾‹ {#2-3-bind-java}

é€šè¿‡ `Binder` å°†é…ç½®æºçš„å†…å®¹ç»‘å®šåˆ°å·²æœ‰çš„ `properties` å¯¹è±¡ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªæœ€æ–°çš„é…ç½®å®ä¾‹ `refresherProperties`ã€‚å…¶ä¸­çš„ `"onethread"` æ˜¯ç»‘å®šçš„å‰ç¼€ï¼Œè¡¨ç¤ºåªä¼šæ³¨å…¥è¿™ä¸ªå‰ç¼€ä¸‹å¯¹åº”çš„é…ç½®å­—æ®µã€‚

åº•å±‚åŸç†æ˜¯ï¼šSpring Boot ä¼šä½¿ç”¨åå°„æœºåˆ¶ï¼Œæ ¹æ®é…ç½®é¡¹è‡ªåŠ¨è°ƒç”¨ JavaObject çš„ `setXxx()` æ–¹æ³•å®Œæˆå±æ€§èµ‹å€¼ï¼Œéå¸¸æ™ºèƒ½ã€‚

æœ€åçš„ `.get()` è¡¨ç¤ºå–å‡ºç»‘å®šç»“æœï¼Œ**æ³¨æ„** ï¼šå¦‚æœæ²¡æœ‰æˆåŠŸåŒ¹é…é…ç½®é¡¹ï¼Œè¿™é‡Œä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤é€šå¸¸åœ¨ç”Ÿäº§åœºæ™¯ä¸­å»ºè®®é…åˆ `Optional` æˆ– `orElse` è¿›è¡Œå…œåº•å¤„ç†ã€‚

### 3. Starter è‡ªåŠ¨è£…é… {#3-starter}

ä»¥ä¸Šå°±æ˜¯å®ç° **åŠ¨æ€çº¿ç¨‹æ± å‚æ•°ç›‘å¬ä¸åˆ·æ–°** çš„æ ¸å¿ƒé€»è¾‘ã€‚å’Œæˆ‘ä»¬ä¹‹å‰æ„å»º `common-spring-boot-starter` çš„è¿‡ç¨‹ä¸€æ ·ï¼Œè¿™é‡Œä¾ç„¶éµå¾ª **SpringBootStarterçš„è‡ªåŠ¨è£…é…ä¸‰éƒ¨æ›²** ï¼š

* 1.  
ç¼–å†™æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆç›‘å¬é…ç½®å˜åŒ–ã€åˆ·æ–°çº¿ç¨‹æ± å‚æ•°ï¼‰ï¼›  
* 2.  
ç¼–å†™é…ç½®ç±»ï¼Œå°†æ ¸å¿ƒé€»è¾‘æ³¨å†Œä¸º Spring Beanï¼›  
* 3.  
  é€šè¿‡è‡ªåŠ¨è£…é…æœºåˆ¶è®© SpringBoot æ„ŸçŸ¥å¹¶åŠ è½½è¿™äº› Beanã€‚

éµå¾ªè¿™ä¸ªå¥—è·¯ï¼Œæˆ‘ä»¬å°±èƒ½é¡ºåˆ©å®ŒæˆåŸºäº Nacos çš„åŠ¨æ€çº¿ç¨‹æ± é…ç½®ç›‘å¬åŠŸèƒ½ã€‚

æ–‡æœ«æ€»ç»“
----

åŠ¨æ€çº¿ç¨‹æ± çš„æ ¸å¿ƒåœ¨äº"åŠ¨æ€"äºŒå­—ï¼Œè€Œè¿™ä¸ªåŠ¨æ€çš„èµ·ç‚¹ï¼Œå°±æ˜¯ç›‘å¬é…ç½®ä¸­å¿ƒçš„å˜æ›´äº‹ä»¶ã€‚æˆ‘ä»¬é€šè¿‡ç›‘å¬å™¨æ‹¿åˆ°æœ€æ–°é…ç½®ï¼Œè§£ææˆé…ç½®å¯¹è±¡åï¼Œå†äº¤ç”±åç»­é€»è¾‘å®Œæˆå‚æ•°åˆ·æ–°ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ— è®ºæ˜¯ Nacos æä¾›çš„å›è°ƒæœºåˆ¶ï¼Œè¿˜æ˜¯æˆ‘ä»¬å°è£…çš„é…ç½®è§£æä¸åˆ·æ–°é€»è¾‘ï¼Œéƒ½ä½“ç°äº† SpringBoot ä¸ä¸­é—´ä»¶æ·±åº¦é›†æˆçš„ä¼˜åŠ¿ã€‚

ä¸‹ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ·±å…¥æ¢ç´¢å‚æ•°å˜æ›´åï¼Œçº¿ç¨‹æ± æ˜¯å¦‚ä½•å®Œæˆæ›´æ–°çš„ï¼Œæ•¬è¯·æœŸå¾…ã€‚

å®Œç»“ï¼Œæ’’èŠ± ğŸ‰

