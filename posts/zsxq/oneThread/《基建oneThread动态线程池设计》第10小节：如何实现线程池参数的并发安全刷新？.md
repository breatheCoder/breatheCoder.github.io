2025å¹´07æœˆ18æ—¥ 22:10  
å¦‚ä½•å®ç°çº¿ç¨‹æ± å‚æ•°çš„å¹¶å‘å®‰å…¨åˆ·æ–°ï¼Ÿå…ƒæ•°æ®ä¿¡æ¯ï¼š

*  
ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± oneThreadï¼š<https://t.zsxq.com/5GfrN>  
*  
ä»£ç ä»“åº“ï¼š<https://gitcode.net/nageoffer/onethread> ------ ç”³è¯·é¡¹ç›®æƒé™å‚è€ƒä¸Šè¿°çº¿ç¨‹æ± é¡¹ç›®é“¾æ¥  
*  
ç« èŠ‚éš¾åº¦ï¼šâ˜…â˜…â˜†â˜†â˜† - ä¸­ç­‰  
*  
  è§†é¢‘åœ°å€ï¼šæœ¬ç« èŠ‚å†…å®¹ç®€å•ï¼Œæ— 



*** ** * ** ***

å†…å®¹æ‘˜è¦ï¼šæœ¬æ–‡èšç„¦ oneThread åŠ¨æ€çº¿ç¨‹æ± çš„å‚æ•°åˆ·æ–°æœºåˆ¶ï¼Œè¯¦ç»†æ‹†è§£"æ£€æµ‹å·®å¼‚ â†’ çƒ­æ›´æ–°å‚æ•° â†’ æ›´æ–°å…ƒæ•°æ® â†’ æ¶ˆæ¯é€šçŸ¥ä¸å®¡è®¡æ—¥å¿—"å…¨é“¾è·¯å®ç°ã€‚é€šè¿‡é€è¡Œè§£æå…³é”®ä»£ç ï¼Œå¸®åŠ©è¯»è€…ç†è§£å¦‚ä½•åœ¨è¿è¡ŒæœŸå®‰å…¨ã€æ— æ„ŸçŸ¥åœ°å°†è¿œç¨‹é…ç½®åŒæ­¥åˆ°çº¿ç¨‹æ± ã€‚

è¯¾ç¨‹ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š

*  
ä¸šåŠ¡æ—¶åº  
*  
é…ç½®å‰ç½®éªŒè¯  
*  
çº¿ç¨‹æ± é…ç½®å˜æ›´  
*  
å¦‚ä½•ä¿éšœçº¿ç¨‹æ± é…ç½®åˆ·æ–°çš„å¹¶å‘å®‰å…¨ï¼Ÿ  
*  
  æ–‡æœ«æ€»ç»“

åœ¨ä¸Šä¸€ç« èŠ‚ï¼Œå’±ä»¬å·²ç»å®ç°äº†ä»é…ç½®ä¸­å¿ƒè·å–æœ€æ–°çš„å˜æ›´å†…å®¹ï¼Œå¹¶å°†å¯¹åº”çš„å­—ç¬¦ä¸²åºåˆ—åŒ–ä¸º Java å¯¹è±¡ä¾›åç»­æµç¨‹ä½¿ç”¨ã€‚æ¥ä¸‹æ¥ä¼šä»æœ€æ–°é…ç½®å’Œå†…å­˜ä¸­çš„çº¿ç¨‹æ± é…ç½®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæœ‰å˜åŒ–åˆ™æ›´æ–°ï¼Œæ²¡æœ‰å˜åŒ–åˆ™è·³è¿‡ã€‚

ä¸šåŠ¡æ—¶åº
----

åŠ¨æ€çº¿ç¨‹æ± çš„æ ¸å¿ƒèƒ½åŠ›ä¹‹ä¸€ï¼Œå°±æ˜¯è¿è¡Œæ—¶å¯ä»¥è‡ªåŠ¨æ„ŸçŸ¥é…ç½®å˜åŒ–å¹¶çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚ä¸ºå®ç°è¿™ä¸€èƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

* 1.  
è·å–è¿œç¨‹æœ€æ–°çº¿ç¨‹æ± é…ç½®ï¼›  
* 2.  
å¯¹æ¯”å½“å‰å†…å­˜ä¸­å·²æœ‰çš„çº¿ç¨‹æ± é…ç½®ï¼›  
* 3.  
å¦‚æœæ£€æµ‹åˆ°é…ç½®å‘ç”Ÿå˜æ›´ï¼Œåˆ™æ‰§è¡Œæ›´æ–°ï¼›  
* 4.  
å­˜å‚¨æœ€æ–°é…ç½®ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é…ç½®æ›´æ–°æ—¶æ¯”å¯¹ï¼›  
* 5.  
  é€šçŸ¥å„æ–¹é…ç½®å·²å˜æ›´ï¼Œå¹¶æ‰“å°å˜æ›´æ—¥å¿—ã€‚

![iShot_2025-07-17_19.45.60.png](https://article-images.zsxq.com/Fk88zLZ1HELu4EnKh0in2pgvGGB8 "iShot_2025-07-17_19.45.60.png")

é…ç½®å‰ç½®éªŒè¯
------

### 1. åˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹æ± é…ç½® {#1}

ä»£ç é¦–å…ˆä½¿ç”¨æ£€æŸ¥è¿œç¨‹é…ç½®æ˜¯å¦åŒ…å«çº¿ç¨‹æ± è®¾ç½®ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œè·³è¿‡åç»­å¤„ç†ã€‚è¿™ç¡®ä¿äº†åªæœ‰å½“æœ‰æœ‰æ•ˆçš„çº¿ç¨‹æ± é…ç½®æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    if (CollUtil.isEmpty(refresherProperties.getExecutors())) {
        return;
    }
              
### 2. åˆ¤æ–­çº¿ç¨‹æ± é…ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ– {#2}

æˆ‘ä»¬é€ä¸ªéå†çº¿ç¨‹æ±  IDï¼Œå¹¶é€šè¿‡ `hasThreadPoolConfigChanged()` è¿›è¡Œå¯¹æ¯”ã€‚è¯¥æ–¹æ³•ä¼šæ£€æŸ¥æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€æ‹’ç»ç­–ç•¥ã€é˜Ÿåˆ—å®¹é‡ç­‰å¤šä¸ªå…³é”®å‚æ•°æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    for (ThreadPoolExecutorProperties remoteProperties : refresherProperties.getExecutors()) {
        boolean changed = hasThreadPoolConfigChanged(remoteProperties);
        if (!changed) {
            continue;
        }
        ...
    }
              
æ ¹æ®çº¿ç¨‹æ±  ID è·å–æ³¨å†Œä¸­å¿ƒä¸­çš„ `ThreadPoolExecutorHolder`ã€‚å¦‚æœæœªæ‰¾åˆ°çº¿ç¨‹æ± å®ä¾‹ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å› `false`ã€‚è‹¥æ‰¾åˆ°å®ä¾‹ï¼Œè°ƒç”¨ `hasDifference` å¯¹æ¯”æ–°æ—§é…ç½®ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private boolean hasThreadPoolConfigChanged(ThreadPoolExecutorProperties remoteProperties) {
        String threadPoolId = remoteProperties.getThreadPoolId();
        ThreadPoolExecutorHolder holder = OneThreadRegistry.getHolder(threadPoolId);
        if (holder == null) {
            log.warn("No thread pool found for thread pool id: {}", threadPoolId);
            return false;
        }
        ThreadPoolExecutor executor = holder.getExecutor();
        ThreadPoolExecutorProperties originalProperties = holder.getExecutorProperties();
    â€‹
        return hasDifference(originalProperties, remoteProperties, executor);
    }
              
è¯¥æ–¹æ³•é€å­—æ®µæ¯”è¾ƒå…³é”®å±æ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œåˆ¤æ–­é€»è¾‘ä¸ºï¼š

*  
åªè¦æœ‰ä¸€ä¸ªå­—æ®µä¸ç›¸ç­‰ï¼Œåˆ™è®¤ä¸ºé…ç½®å·²å˜æ›´ã€‚  
*  
  å­—æ®µåŒ…æ‹¬ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€æ˜¯å¦å…è®¸è¶…æ—¶ã€å­˜æ´»æ—¶é—´ã€æ‹’ç»ç­–ç•¥ã€é˜Ÿåˆ—å®¹é‡ç­‰ã€‚

textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private boolean hasDifference(ThreadPoolExecutorProperties original,
                                  ThreadPoolExecutorProperties remote,
                                  ThreadPoolExecutor executor) {
        return isChanged(original.getCorePoolSize(), remote.getCorePoolSize())
            || isChanged(original.getMaximumPoolSize(), remote.getMaximumPoolSize())
            || isChanged(original.getAllowCoreThreadTimeOut(), remote.getAllowCoreThreadTimeOut())
            || isChanged(original.getKeepAliveTime(), remote.getKeepAliveTime())
            || isChanged(original.getRejectedHandler(), remote.getRejectedHandler())
            || isQueueCapacityChanged(original, remote, executor);
    }
              
`isChanged` æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œç”¨äºæ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ä¸åŒï¼š

*  
å¿½ç•¥ç©ºå€¼ï¼Œä»…å¯¹é null å­—æ®µè¿›è¡Œåˆ¤æ–­ï¼›  
*  
  ä½¿ç”¨ `Objects.equals()` ä¿è¯æ³›å‹ç±»å‹å®‰å…¨æ¯”è¾ƒã€‚

textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private <T> boolean isChanged(T before, T after) {
        return after != null && !Objects.equals(before, after);
    }
              
> ç½‘ä¸Šä¹Ÿæœ‰ä¸€äº›ä¸“ä¸šåš Java å¯¹è±¡æ¯”å¯¹æ˜¯å¦ä¸€è‡´çš„æ¡†æ¶ï¼š[dadiyang/equator](https://github.com/dadiyang/equator)ï¼Œå› ä¸ºæˆ‘æ‡’å¾—å»çœ‹é‡Œé¢çš„ APIï¼Œæ‰€ä»¥å°±è‡ªå·±è¿›è¡Œçš„åˆ¤æ–­ã€‚å¦‚æœæœ‰å¤æ‚å¯¹è±¡ä¸”å­—æ®µå¤šçš„ï¼Œæ¨èä½¿ç”¨ç°æˆå·¥å…·ç±»ã€‚

å¯¹äºé˜Ÿåˆ—å®¹é‡ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ£€æŸ¥ `isQueueCapacityChanged`ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰é˜Ÿåˆ—éƒ½æ”¯æŒåŠ¨æ€è°ƒæ•´å®¹é‡ã€‚é˜Ÿåˆ—å®¹é‡ä»…æ”¯æŒæˆ‘ä»¬è‡ªå®šä¹‰çš„ `ResizableCapacityLinkedBlockingQueue`ï¼Œå¦åˆ™ä¸å¯åŠ¨æ€è°ƒæ•´ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private boolean isQueueCapacityChanged(...){
        Integer remoteCapacity = remoteProperties.getQueueCapacity();
        Integer originalCapacity = originalProperties.getQueueCapacity();
        BlockingQueue<?> queue = executor.getQueue();
    â€‹
        return remoteCapacity != null
            && !Objects.equals(remoteCapacity, originalCapacity)
            && Objects.equals("ResizableCapacityLinkedBlockingQueue", queue.getClass().getSimpleName());
    }
    â€‹
              
åªæœ‰è¿œç¨‹é…ç½®ä¸­çš„é˜Ÿåˆ—å®¹é‡ä¸ä¸ºç©ºï¼Œå¹¶ä¸”ä¸å½“å‰å†…å­˜ä¸­çš„é…ç½®ä¸ä¸€è‡´ï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹æ± ä½¿ç”¨çš„æ˜¯æ”¯æŒåŠ¨æ€æ‰©å®¹çš„é˜Ÿåˆ—ï¼ˆå¦‚`ResizableCapacityLinkedBlockingQueue`ï¼‰ï¼Œæ‰è®¤ä¸ºå®¹é‡ç¡®å®å‘ç”Ÿäº†å˜åŒ–ã€‚
> é»˜è®¤çš„ ArrayBlockingQueue å’Œ LinkedBlockingQueue ä¸ºä»€ä¹ˆä¸èƒ½æ”¹å˜å®¹é‡ï¼Œä¸‹ä¸€ç« èŠ‚ä¼šè¯¦ç»†è¯´æ˜ã€‚

çº¿ç¨‹æ± é…ç½®å˜æ›´
-------

å¦‚æœæ£€æµ‹åˆ°å˜åŒ–ï¼Œè°ƒç”¨çº¿ç¨‹æ± åˆ·æ–°æ–¹æ³•åº”ç”¨æ–°çš„é…ç½®ï¼š

### 1. æ ¸å¿ƒ / æœ€å¤§çº¿ç¨‹æ•° {#1}

çº¿ç¨‹æ•°æ›´æ–°çš„åŸåˆ™æ˜¯ï¼š**å…ˆæœ€å¤§åæ ¸å¿ƒ** ã€‚å¦‚æœæ–°æ ¸å¿ƒçº¿ç¨‹æ•°å¤§äºå½“å‰æœ€å¤§çº¿ç¨‹æ•°ï¼Œå¿…é¡»å…ˆè°ƒå¤§ `maximumPoolSize`ï¼Œå¦åˆ™ JDK ä¼šæŠ› `IllegalArgumentException`ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    Integer remoteCorePoolSize = remoteProperties.getCorePoolSize();
    Integer remoteMaximumPoolSize = remoteProperties.getMaximumPoolSize();
    if (remoteCorePoolSize != null && remoteMaximumPoolSize != null) {
        int originalMaximumPoolSize = executor.getMaximumPoolSize();
        if (remoteCorePoolSize > originalMaximumPoolSize) {
            executor.setMaximumPoolSize(remoteMaximumPoolSize);
            executor.setCorePoolSize(remoteCorePoolSize);
        } else {
            executor.setCorePoolSize(remoteCorePoolSize);
            executor.setMaximumPoolSize(remoteMaximumPoolSize);
        }
    } else {
        if (remoteMaximumPoolSize != null) {
            executor.setMaximumPoolSize(remoteMaximumPoolSize);
        }
        if (remoteCorePoolSize != null) {
            executor.setCorePoolSize(remoteCorePoolSize);
        }
    }
              
ä¹‹æ‰€ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ˜¯å› ä¸º JDK17 **çº¿ç¨‹æ± åº•å±‚åœ¨è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶åšäº†å‚æ•°é™åˆ¶æ ¡éªŒ** ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public void setCorePoolSize(int corePoolSize) {
        if (corePoolSize < 0 || maximumPoolSize < corePoolSize)
            throw new IllegalArgumentException();
        int delta = corePoolSize - this.corePoolSize;
        this.corePoolSize = corePoolSize;
        if (workerCountOf(ctl.get()) > corePoolSize)
            interruptIdleWorkers();
        else if (delta > 0) {
            // We don't really know how many new threads are "needed".
            // As a heuristic, prestart enough new workers (up to new
            // core size) to handle the current number of tasks in
            // queue, but stop if queue becomes empty while doing so.
            int k = Math.min(delta, workQueue.size());
            while (k-- > 0 && addWorker(null, true)) {
                if (workQueue.isEmpty())
                    break;
            }
        }
    }
              
æœ‰äº›åŒå­¦å¯èƒ½æ‰“å¼€è‡ªå·±é¡¹ç›®ä¸€çœ‹ï¼Œå‘ç°ä»£ç é‡Œå¹¶æ²¡æœ‰ç›¸å…³æ ¡éªŒé€»è¾‘ï¼Œè¿™æ˜¯å› ä¸º **JDK8å¹¶æœªå¼•å…¥è¿™æ®µçº¿ç¨‹æ•°çš„æ ¡éªŒæœºåˆ¶** ã€‚æˆ‘åœ¨å¼€å‘ Hippo4j çš„è¿‡ç¨‹ä¸­ä¹Ÿæ›¾è¸©è¿‡è¿™ä¸ªå‘ï¼Œæ„ŸåŒèº«å—ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public void setCorePoolSize(int corePoolSize) {
        if (corePoolSize < 0)
            throw new IllegalArgumentException();
        int delta = corePoolSize - this.corePoolSize;
        this.corePoolSize = corePoolSize;
        if (workerCountOf(ctl.get()) > corePoolSize)
            interruptIdleWorkers();
        else if (delta > 0) {
            // We don't really know how many new threads are "needed".
            // As a heuristic, prestart enough new workers (up to new
            // core size) to handle the current number of tasks in
            // queue, but stop if queue becomes empty while doing so.
            int k = Math.min(delta, workQueue.size());
            while (k-- > 0 && addWorker(null, true)) {
                if (workQueue.isEmpty())
                    break;
            }
        }
    }
              
å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ª Issue ğŸ‘‰ [Hippo4j Issue#1063](https://github.com/opengoofy/hippo4j/issues/1063)ï¼Œé‡Œé¢æœ‰è¯¦ç»†çš„åˆ†æè¿‡ç¨‹å’Œå¤ç°åœºæ™¯ã€‚

### 2. æ‹’ç»ç­–ç•¥ {#2}

å€ŸåŠ©æšä¸¾å·¥å‚æ–¹æ³•æŠŠå­—ç¬¦ä¸²ç­–ç•¥åè½¬æ¢ä¸ºçœŸæ­£çš„ `RejectedExecutionHandler` å®ä¾‹ï¼Œä¿è¯å¯æ’æ‹”ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    if (remoteProperties.getRejectedHandler() != null &&
            !Objects.equals(remoteProperties.getRejectedHandler(), originalProperties.getRejectedHandler())) {
        RejectedExecutionHandler handler = RejectedPolicyTypeEnum.createPolicy(remoteProperties.getRejectedHandler());
        executor.setRejectedExecutionHandler(handler);
    }
              
### 3. é˜Ÿåˆ—å®¹é‡åŠ¨æ€æ‰©å®¹ {#3}

åªæœ‰å½“é˜Ÿåˆ—å®ä¾‹å®ç°äº†å¯æ‰©å®¹æ¥å£æ—¶æ‰å¯ä»¥ä¿®æ”¹å®¹é‡ï¼Œé¿å… `LinkedBlockingQueue` ç­‰ JDK åŸç”Ÿé˜Ÿåˆ—ä¸æ”¯æŒå®¹é‡å˜åŒ–å¯¼è‡´çš„é£é™©ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    if (isQueueCapacityChanged(originalProperties, remoteProperties, executor)) {
        BlockingQueue<Runnable> queue = executor.getQueue();
        ResizableCapacityLinkedBlockingQueue<?> resizableQueue = (ResizableCapacityLinkedBlockingQueue<?>) queue;
        resizableQueue.setCapacity(remoteProperties.getQueueCapacity());
    }
              
### 4. åˆ·æ–°å…ƒæ•°æ®ã€å‘é€é€šçŸ¥ã€æ‰“å°å®¡è®¡æ—¥å¿— {#4}

çº¿ç¨‹æ± è¿è¡Œæ—¶å‚æ•°å˜æ›´åï¼Œè¿˜æœ‰ä¸€äº›åç½®é€»è¾‘éœ€è¦å¤„ç†ï¼š

* 1.  
æŠŠæœ€æ–°é…ç½®å†™å›æ³¨å†Œè¡¨ï¼Œä¿è¯åç»­å†è¯»å–æ—¶å°±æ˜¯æ–°çš„å€¼ï¼›  
* 2.  
ç„¶åä¼šæŠŠ"æ—§å€¼ â†’ æ–°å€¼"çš„æ˜ å°„å°è£…æˆ DTOï¼Œé€šè¿‡é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é‚®ä»¶ç­‰æ¸ é“æ¨é€ç»™å¼€å‘ / è¿ç»´ï¼Œåšåˆ°å³æ—¶å¯è§ã€‚  
* 3.  
  ä¸ºå®ç°æ—¥å¿—ç•™ç—•ï¼Œä¼šé€šè¿‡ `log.info` ç»Ÿä¸€æ‰“å°æ‰€æœ‰å…³é”®å­—æ®µçš„ **"æ—§å€¼-\>æ–°å€¼"** ã€‚

ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    // çº¿ç¨‹æ± å‚æ•°å˜æ›´åè¿›è¡Œæ—¥å¿—æ‰“å°
    String threadPoolId = remoteProperties.getThreadPoolId();
    ThreadPoolExecutorHolder holder = OneThreadRegistry.getHolder(threadPoolId);
    ThreadPoolExecutorProperties originalProperties = holder.getExecutorProperties();
    holder.setExecutorProperties(remoteProperties);
    â€‹
    // å‘é€çº¿ç¨‹æ± é…ç½®å˜æ›´æ¶ˆæ¯é€šçŸ¥
    sendThreadPoolConfigChangeMessage(originalProperties, remoteProperties);
    â€‹
    // æ‰“å°çº¿ç¨‹æ± é…ç½®å˜æ›´æ—¥å¿—
    log.info(CHANGE_THREAD_POOL_TEXT,
            threadPoolId,
            String.format(CHANGE_DELIMITER, originalProperties.getCorePoolSize(), remoteProperties.getCorePoolSize()),
            String.format(CHANGE_DELIMITER, originalProperties.getMaximumPoolSize(), remoteProperties.getMaximumPoolSize()),
            String.format(CHANGE_DELIMITER, originalProperties.getQueueCapacity(), remoteProperties.getQueueCapacity()),
            String.format(CHANGE_DELIMITER, originalProperties.getKeepAliveTime(), remoteProperties.getKeepAliveTime()),
            String.format(CHANGE_DELIMITER, originalProperties.getRejectedHandler(), remoteProperties.getRejectedHandler()),
            String.format(CHANGE_DELIMITER, originalProperties.getAllowCoreThreadTimeOut(), remoteProperties.getAllowCoreThreadTimeOut()));
              
å¦‚ä½•ä¿éšœçº¿ç¨‹æ± é…ç½®åˆ·æ–°çš„å¹¶å‘å®‰å…¨ï¼Ÿ
-----------------

åœ¨åŠ¨æ€çº¿ç¨‹æ± çš„é…ç½®åˆ·æ–°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è§¦å‘é…ç½®å˜æ›´ï¼ˆæ¯”å¦‚é…ç½®ä¸­å¿ƒæ¨é€å—ç½‘ç»œå½±å“é‡å¤æ¨é€ã€å¤šç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨é‡å¤ã€å®šæ—¶æ ¡éªŒç­‰ï¼‰ï¼Œä½†å¿…é¡»**ä¿è¯åŒä¸€ä¸ªçº¿ç¨‹æ± çš„å‚æ•°åˆ·æ–°æ˜¯ä¸²è¡Œã€åŸå­ã€å®‰å…¨çš„** ã€‚

å¦åˆ™å°±å¯èƒ½å¯¼è‡´ï¼š

*  
å‚æ•°é”™ä¹±ï¼šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ corePoolSize å’Œ maximumPoolSizeï¼Œæœ€ç»ˆå€¼ä¸å¯é¢„æœŸï¼›  
*  
æ—¥å¿—æ··ä¹±ï¼šåŸå§‹å€¼å’Œæ–°å€¼æ‰“å°é”™ä½ï¼›  
*  
é˜Ÿåˆ—æ‰©å®¹å¤±è´¥ï¼šå¹¶å‘ä¿®æ”¹ `ResizableCapacityLinkedBlockingQueue` ä¼šæŠ›å¼‚å¸¸ï¼›  
*  
  ä¸ä¸€è‡´æ€§ï¼šé€šçŸ¥å‘é€å’Œå®é™…çº¿ç¨‹æ± çŠ¶æ€ä¸ä¸€è‡´ã€‚

åœ¨å¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜æ—¶ï¼Œæˆ‘è€ƒè™‘äº†ä¸¤ç§æ–¹æ¡ˆï¼š

* 1.  
**å¯¹æ•´ä¸ªæ–¹æ³•åŠ é”** ï¼šå®ç°æœ€ç®€å•ï¼Œèƒ½å¿«é€Ÿè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›  
* 2.  
  **ä»…å¯¹æŒ‡å®šçš„çº¿ç¨‹æ± IDåŠ é”** ï¼šç²’åº¦æ›´ç»†ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚

è™½ç„¶ç¬¬ä¸€ç§æ–¹å¼å®ç°èµ·æ¥æœ€çœäº‹ï¼Œä½†**ç‹¬å±äºç¨‹åºå‘˜çš„"å¼ºè¿«ç—‡"è®©æˆ‘ä¸å¤ªèƒ½æ¥å—è¿™ç§å¤„ç†æ–¹å¼** ã€‚å› æ­¤ï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼Œå¯¹çº¿ç¨‹æ±  ID ç»´åº¦åŠ é”ã€‚

### 1. ä½¿ç”¨ synchronized (id) {#1-synchronized-id}

ä»£ç ç¤ºä¾‹ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    synchronized (threadPoolId) {
        // do refresh
    }
              
å­˜åœ¨çš„é—®é¢˜ï¼š

*  
å¦‚æœ `threadPoolId` æ˜¯ä»å¯¹è±¡å­—æ®µè·å–çš„ï¼ˆä¾‹å¦‚ `.getThreadPoolId()`ï¼‰ï¼Œå¤šä¸ªå¯¹è±¡å³ä½¿è¿”å›ç›¸åŒå†…å®¹ï¼Œä¹Ÿå¯èƒ½æ˜¯**ä¸åŒçš„Stringå®ä¾‹** ã€‚  
*  
  JVM ä¼šå¯¹ä¸åŒçš„å¼•ç”¨åˆ†é…ä¸åŒçš„é” â†’ **é”ä¸ç”Ÿæ•ˆ** ï¼Œå¹¶å‘å†²çªä¾ç„¶ä¼šå‘ç”Ÿã€‚

### 2. ä½¿ç”¨ ConcurrentHashMap\<String, ReentrantLock\> {#2-concurrent-hash-map-string-reentrant-lock}

ä»£ç ç¤ºä¾‹ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private static final ConcurrentMap<String, ReentrantLock> lockMap = new ConcurrentHashMap<>();
    â€‹
    ReentrantLock lock = lockMap.computeIfAbsent(threadPoolId, k -> new ReentrantLock());
    lock.lock();
    try {
        // do refresh
    } finally {
        lock.unlock();
    }
              
å­˜åœ¨çš„é—®é¢˜ï¼š

*  
éœ€è¦ç»´æŠ¤é”ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚ä»€ä¹ˆæ—¶å€™é‡Šæ”¾é”å†…å­˜ï¼Ÿ  
*  
  å¯¹äºä¸­å°é¡¹ç›®æˆ–è½»é‡ç»„ä»¶æ¥è¯´æœ‰ç‚¹"é‡"ã€‚

### 3. ä½¿ç”¨ .intern() åŸºäºå†…å®¹å€¼æ„å»ºé” {#3-intern}

ä»£ç ç¤ºä¾‹ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    String threadPoolId = remoteProperties.getThreadPoolId();
    synchronized (threadPoolId.intern()) {
        // do refresh
    }
              
ä¼˜åŠ¿ï¼š

*  
ä»»ä½•å†…å®¹ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œè°ƒç”¨ `.intern()` åéƒ½ä¼šè¿”å›**åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨** ï¼›  
*  
ä¸ä¾èµ–å¤–éƒ¨é”è¡¨ï¼Œ**é›¶ä¾èµ–ã€çº¿ç¨‹å®‰å…¨** ï¼›  
*  
  é”ç²’åº¦ä»¥çº¿ç¨‹æ±  ID ä¸ºå•ä½ï¼Œå¤©ç„¶æ”¯æŒå¹¶å‘åˆ·æ–°å¤šä¸ªçº¿ç¨‹æ± ã€‚

#### 3.1 .intern() åŸç† {#3-1-intern}

`.intern()` æ˜¯ Java æä¾›çš„**å­—ç¬¦ä¸²å¸¸é‡æ± æœºåˆ¶** çš„ä¸€éƒ¨åˆ†ã€‚

*  
å®ƒä¼šå°†å½“å‰å­—ç¬¦ä¸²åŠ å…¥ JVM çš„å­—ç¬¦ä¸²æ± ï¼ˆString Poolï¼‰ä¸­ï¼›  
*  
å¦‚æœå­—ç¬¦ä¸²æ± ä¸­å·²æœ‰ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥è¿”å›é‚£ä¸€ä»½å¯¹è±¡å¼•ç”¨ï¼›  
*  
  è¿™å°±ç¡®ä¿äº†**åŒå†…å®¹å­—ç¬¦ä¸²â†’åŒå¼•ç”¨å¯¹è±¡** ï¼Œä»è€Œè®© `synchronized` ç”Ÿæ•ˆã€‚

ä¸¾ä¸ªä¾‹å­ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    String s1 = new String("abc");
    String s2 = new String("abc");
    â€‹
    System.out.println(s1 == s2);                // falseï¼Œä¸åŒå¼•ç”¨
    System.out.println(s1.intern() == s2.intern());  // trueï¼Œintern åç›¸åŒå¼•ç”¨
              
æ‰€ä»¥ï¼Œåœ¨åšå­—ç¬¦ä¸²å†…å®¹çº§åˆ«çš„åŒæ­¥æ§åˆ¶æ—¶ï¼Œ**åªæœ‰`.intern()`èƒ½å¤Ÿåœ¨ä¸åŒå¯¹è±¡é—´å¤ç”¨åŒä¸€é”å¯¹è±¡** ã€‚

![image-20250718154039085.png](https://article-images.zsxq.com/FtPYd1R2h_PFdJxxfdAusRRqGAUp "image-20250718154039085.png")

#### 3.2 åˆ·æ–°ä»£ç å®æˆ˜ {#3-2}

å®é™…ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    // åˆ·æ–°åŠ¨æ€çº¿ç¨‹æ± å¯¹è±¡æ ¸å¿ƒå‚æ•°
    for (ThreadPoolExecutorProperties remoteProperties : refresherProperties.getExecutors()) {
        String threadPoolId = remoteProperties.getThreadPoolId();
        // ä»¥çº¿ç¨‹æ±  ID ä¸ºç²’åº¦åŠ é”ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ·æ–°åŒä¸€ä¸ªçº¿ç¨‹æ± 
        synchronized (threadPoolId.intern()) {
            // æ£€æŸ¥çº¿ç¨‹æ± é…ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼ˆä¸å½“å‰å†…å­˜ä¸­çš„é…ç½®å¯¹æ¯”ï¼‰
            boolean changed = hasThreadPoolConfigChanged(remoteProperties);
            if (!changed) {
                continue;
            }
            // ......
        }
    }
              
#### 3.3 å¹¶å‘å•å…ƒæµ‹è¯• {#3-3}

å¤§å®¶æ„Ÿå…´è¶£å¯ä»¥è¯•è¯•è¿™è¿™ä¸ªå•å…ƒæµ‹è¯•ï¼Œåˆ†åˆ«æ˜¯åŠ  `.intern()` å’Œä¸åŠ çš„æ–¹æ¡ˆã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    import java.util.concurrent.ExecutorService;
    import java.util.concurrent.Executors;

    public class InternFromObjectPropertyTest {

        public static void main(String[] args) {
            ExecutorService executor = Executors.newFixedThreadPool(5);

            for (int i = 0; i < 5; i++) {
                executor.submit(() -> {
                    // æ¯ä¸ªçº¿ç¨‹æ„é€ ä¸€ä¸ªç‹¬ç«‹å¯¹è±¡ï¼Œä½† threadPoolId å†…å®¹ç›¸åŒ
                    ThreadPoolExecutorProperties props = new ThreadPoolExecutorProperties("core-biz-pool");

                    // âŒ ä¸åŠ  internï¼šé”å¤±æ•ˆ
                    // Object lock = props.getThreadPoolId();

                    // âœ… åŠ  internï¼šåŒå†…å®¹ï¼ŒåŒé”å¯¹è±¡
                    Object lock = props.getThreadPoolId().intern();

                    synchronized (lock) {
                        String threadName = Thread.currentThread().getName();
                        System.out.printf("[%d] %s æ­£åœ¨åˆ·æ–°çº¿ç¨‹æ±  %s%n",
                                System.currentTimeMillis(), threadName, props.getThreadPoolId());

                        try {
                            Thread.sleep(1000);
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        }

                        System.out.printf("[%d] %s åˆ·æ–°å®Œæˆ%n",
                                System.currentTimeMillis(), threadName);
                    }
                });
            }

            executor.shutdown();
        }
    }

    @Data
    public class ThreadPoolExecutorProperties {

        private String threadPoolId;

        /**
         * å¦‚æœå¤§å®¶å¯¹æ‰‹åŠ¨ new Stringï¼ˆå¼ºåˆ¶åˆ›å»ºæ–°å¯¹è±¡ï¼‰æœ‰ç–‘æƒ‘
         * å¯ä»¥æŠŠè¿™è¡Œä»£ç åŠ åˆ°åŠ¨æ€çº¿ç¨‹æ± é…ç½®åˆ·æ–°çš„æµç¨‹é‡Œï¼ŒæŸ¥çœ‹æ¯ä¸€æ¬¡ç›¸åŒçš„ threadPoolId HashCode å€¼æ˜¯å¦ç›¸åŒ
         * System.out.println(System.identityHashCode(threadPoolId));
         * <p>
         * å› ä¸ºæ¯æ¬¡é…ç½®ä¸­å¿ƒçš„å­—ç¬¦ä¸²éƒ½æ˜¯é‡æ–°åˆ›å»ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†è´´åˆå®é™…åœºæ™¯ï¼Œæ‰€ä»¥æ˜¯ç›´æ¥ new String
         */
        public ThreadPoolExecutorProperties(String threadPoolId) {
            // æ¨¡æ‹Ÿå†…å®¹ç›¸åŒï¼Œä½†å¼•ç”¨ä¸åŒ
            this.threadPoolId = new String(threadPoolId);
        }
    }
              
æ–‡æœ«æ€»ç»“
----

åŠ¨æ€çº¿ç¨‹æ± ç»„ä»¶çš„å®ç°çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™æš—è—è¯¸å¤šç»†èŠ‚ä¸æŒ‘æˆ˜ã€‚ä»è¿œç¨‹é…ç½®æ„ŸçŸ¥ã€å·®å¼‚åŒ–æ¯”å¯¹ã€çº¿ç¨‹æ± å‚æ•°å®‰å…¨åˆ·æ–°ï¼Œåˆ°æ³¨å†Œä¸­å¿ƒçš„å…ƒæ•°æ®æ›´æ–°ä¸å¯è§‚æµ‹æ—¥å¿—è¾“å‡ºï¼Œæ¯ä¸€æ­¥éƒ½éœ€è¦ä¸¥è°¨è®¾è®¡ã€‚è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿˜å¿…é¡»è€ƒè™‘å¤šç§å› ç´ ï¼šä¸åŒç‰ˆæœ¬çš„ JDK å¯¹çº¿ç¨‹æ± è¡Œä¸ºçš„å·®å¼‚ã€é˜»å¡é˜Ÿåˆ—æ˜¯å¦æ”¯æŒæ‰©å®¹ã€æ‹’ç»ç­–ç•¥çš„å¯æ’æ‹”æ€§ã€é…ç½®å˜æ›´çš„å¹‚ç­‰æ€§ã€å¹¶å‘åœºæ™¯ä¸‹çš„çº¿ç¨‹å®‰å…¨ç­‰ã€‚

å†™ä¸€ä¸ª"èƒ½ç”¨"çš„ç»„ä»¶å¾ˆå®¹æ˜“ï¼Œä½†è¦å†™ä¸€ä¸ª"å¥å£®ã€é€šç”¨ã€å¯ç»´æŠ¤"çš„ç»„ä»¶ï¼Œå°±å¿…é¡»åœ¨è®¾è®¡å±‚é¢ä¸‹è¶³åŠŸå¤«ã€‚å¸Œæœ›æœ¬æ–‡çš„æ‹†è§£ï¼Œèƒ½ä¸ºå¤§å®¶å­¦ä¹ çº¿ç¨‹æ± æ²»ç†ä½“ç³»æä¾›ä¸€äº›ç»éªŒã€‚

å®Œç»“ï¼Œæ’’èŠ± ğŸ‰  
å¦‚ä½•å®ç°çº¿ç¨‹æ± å‚æ•°çš„å¹¶å‘å®‰å…¨åˆ·æ–°ï¼Ÿå…ƒæ•°æ®ä¿¡æ¯ï¼š

*  
ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± oneThreadï¼š<https://t.zsxq.com/5GfrN>  
*  
ä»£ç ä»“åº“ï¼š<https://gitcode.net/nageoffer/onethread> ------ ç”³è¯·é¡¹ç›®æƒé™å‚è€ƒä¸Šè¿°çº¿ç¨‹æ± é¡¹ç›®é“¾æ¥  
*  
ç« èŠ‚éš¾åº¦ï¼šâ˜…â˜…â˜†â˜†â˜† - ä¸­ç­‰  
*  
  è§†é¢‘åœ°å€ï¼šæœ¬ç« èŠ‚å†…å®¹ç®€å•ï¼Œæ— 



*** ** * ** ***

å†…å®¹æ‘˜è¦ï¼šæœ¬æ–‡èšç„¦ oneThread åŠ¨æ€çº¿ç¨‹æ± çš„å‚æ•°åˆ·æ–°æœºåˆ¶ï¼Œè¯¦ç»†æ‹†è§£"æ£€æµ‹å·®å¼‚ â†’ çƒ­æ›´æ–°å‚æ•° â†’ æ›´æ–°å…ƒæ•°æ® â†’ æ¶ˆæ¯é€šçŸ¥ä¸å®¡è®¡æ—¥å¿—"å…¨é“¾è·¯å®ç°ã€‚é€šè¿‡é€è¡Œè§£æå…³é”®ä»£ç ï¼Œå¸®åŠ©è¯»è€…ç†è§£å¦‚ä½•åœ¨è¿è¡ŒæœŸå®‰å…¨ã€æ— æ„ŸçŸ¥åœ°å°†è¿œç¨‹é…ç½®åŒæ­¥åˆ°çº¿ç¨‹æ± ã€‚

è¯¾ç¨‹ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š

*  
ä¸šåŠ¡æ—¶åº  
*  
é…ç½®å‰ç½®éªŒè¯  
*  
çº¿ç¨‹æ± é…ç½®å˜æ›´  
*  
å¦‚ä½•ä¿éšœçº¿ç¨‹æ± é…ç½®åˆ·æ–°çš„å¹¶å‘å®‰å…¨ï¼Ÿ  
*  
  æ–‡æœ«æ€»ç»“

åœ¨ä¸Šä¸€ç« èŠ‚ï¼Œå’±ä»¬å·²ç»å®ç°äº†ä»é…ç½®ä¸­å¿ƒè·å–æœ€æ–°çš„å˜æ›´å†…å®¹ï¼Œå¹¶å°†å¯¹åº”çš„å­—ç¬¦ä¸²åºåˆ—åŒ–ä¸º Java å¯¹è±¡ä¾›åç»­æµç¨‹ä½¿ç”¨ã€‚æ¥ä¸‹æ¥ä¼šä»æœ€æ–°é…ç½®å’Œå†…å­˜ä¸­çš„çº¿ç¨‹æ± é…ç½®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæœ‰å˜åŒ–åˆ™æ›´æ–°ï¼Œæ²¡æœ‰å˜åŒ–åˆ™è·³è¿‡ã€‚

ä¸šåŠ¡æ—¶åº
----

åŠ¨æ€çº¿ç¨‹æ± çš„æ ¸å¿ƒèƒ½åŠ›ä¹‹ä¸€ï¼Œå°±æ˜¯è¿è¡Œæ—¶å¯ä»¥è‡ªåŠ¨æ„ŸçŸ¥é…ç½®å˜åŒ–å¹¶çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚ä¸ºå®ç°è¿™ä¸€èƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

* 1.  
è·å–è¿œç¨‹æœ€æ–°çº¿ç¨‹æ± é…ç½®ï¼›  
* 2.  
å¯¹æ¯”å½“å‰å†…å­˜ä¸­å·²æœ‰çš„çº¿ç¨‹æ± é…ç½®ï¼›  
* 3.  
å¦‚æœæ£€æµ‹åˆ°é…ç½®å‘ç”Ÿå˜æ›´ï¼Œåˆ™æ‰§è¡Œæ›´æ–°ï¼›  
* 4.  
å­˜å‚¨æœ€æ–°é…ç½®ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é…ç½®æ›´æ–°æ—¶æ¯”å¯¹ï¼›  
* 5.  
  é€šçŸ¥å„æ–¹é…ç½®å·²å˜æ›´ï¼Œå¹¶æ‰“å°å˜æ›´æ—¥å¿—ã€‚

![iShot_2025-07-17_19.45.60.png](https://article-images.zsxq.com/Fk88zLZ1HELu4EnKh0in2pgvGGB8 "iShot_2025-07-17_19.45.60.png")

é…ç½®å‰ç½®éªŒè¯
------

### 1. åˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹æ± é…ç½® {#1}

ä»£ç é¦–å…ˆä½¿ç”¨æ£€æŸ¥è¿œç¨‹é…ç½®æ˜¯å¦åŒ…å«çº¿ç¨‹æ± è®¾ç½®ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œè·³è¿‡åç»­å¤„ç†ã€‚è¿™ç¡®ä¿äº†åªæœ‰å½“æœ‰æœ‰æ•ˆçš„çº¿ç¨‹æ± é…ç½®æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    if (CollUtil.isEmpty(refresherProperties.getExecutors())) {
        return;
    }
              
### 2. åˆ¤æ–­çº¿ç¨‹æ± é…ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ– {#2}

æˆ‘ä»¬é€ä¸ªéå†çº¿ç¨‹æ±  IDï¼Œå¹¶é€šè¿‡ `hasThreadPoolConfigChanged()` è¿›è¡Œå¯¹æ¯”ã€‚è¯¥æ–¹æ³•ä¼šæ£€æŸ¥æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€æ‹’ç»ç­–ç•¥ã€é˜Ÿåˆ—å®¹é‡ç­‰å¤šä¸ªå…³é”®å‚æ•°æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    for (ThreadPoolExecutorProperties remoteProperties : refresherProperties.getExecutors()) {
        boolean changed = hasThreadPoolConfigChanged(remoteProperties);
        if (!changed) {
            continue;
        }
        ...
    }
              
æ ¹æ®çº¿ç¨‹æ±  ID è·å–æ³¨å†Œä¸­å¿ƒä¸­çš„ `ThreadPoolExecutorHolder`ã€‚å¦‚æœæœªæ‰¾åˆ°çº¿ç¨‹æ± å®ä¾‹ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—å¹¶è¿”å› `false`ã€‚è‹¥æ‰¾åˆ°å®ä¾‹ï¼Œè°ƒç”¨ `hasDifference` å¯¹æ¯”æ–°æ—§é…ç½®ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private boolean hasThreadPoolConfigChanged(ThreadPoolExecutorProperties remoteProperties) {
        String threadPoolId = remoteProperties.getThreadPoolId();
        ThreadPoolExecutorHolder holder = OneThreadRegistry.getHolder(threadPoolId);
        if (holder == null) {
            log.warn("No thread pool found for thread pool id: {}", threadPoolId);
            return false;
        }
        ThreadPoolExecutor executor = holder.getExecutor();
        ThreadPoolExecutorProperties originalProperties = holder.getExecutorProperties();
    â€‹
        return hasDifference(originalProperties, remoteProperties, executor);
    }
              
è¯¥æ–¹æ³•é€å­—æ®µæ¯”è¾ƒå…³é”®å±æ€§æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œåˆ¤æ–­é€»è¾‘ä¸ºï¼š

*  
åªè¦æœ‰ä¸€ä¸ªå­—æ®µä¸ç›¸ç­‰ï¼Œåˆ™è®¤ä¸ºé…ç½®å·²å˜æ›´ã€‚  
*  
  å­—æ®µåŒ…æ‹¬ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€æ˜¯å¦å…è®¸è¶…æ—¶ã€å­˜æ´»æ—¶é—´ã€æ‹’ç»ç­–ç•¥ã€é˜Ÿåˆ—å®¹é‡ç­‰ã€‚

textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private boolean hasDifference(ThreadPoolExecutorProperties original,
                                  ThreadPoolExecutorProperties remote,
                                  ThreadPoolExecutor executor) {
        return isChanged(original.getCorePoolSize(), remote.getCorePoolSize())
            || isChanged(original.getMaximumPoolSize(), remote.getMaximumPoolSize())
            || isChanged(original.getAllowCoreThreadTimeOut(), remote.getAllowCoreThreadTimeOut())
            || isChanged(original.getKeepAliveTime(), remote.getKeepAliveTime())
            || isChanged(original.getRejectedHandler(), remote.getRejectedHandler())
            || isQueueCapacityChanged(original, remote, executor);
    }
              
`isChanged` æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œç”¨äºæ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ä¸åŒï¼š

*  
å¿½ç•¥ç©ºå€¼ï¼Œä»…å¯¹é null å­—æ®µè¿›è¡Œåˆ¤æ–­ï¼›  
*  
  ä½¿ç”¨ `Objects.equals()` ä¿è¯æ³›å‹ç±»å‹å®‰å…¨æ¯”è¾ƒã€‚

textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private <T> boolean isChanged(T before, T after) {
        return after != null && !Objects.equals(before, after);
    }
              
> ç½‘ä¸Šä¹Ÿæœ‰ä¸€äº›ä¸“ä¸šåš Java å¯¹è±¡æ¯”å¯¹æ˜¯å¦ä¸€è‡´çš„æ¡†æ¶ï¼š[dadiyang/equator](https://github.com/dadiyang/equator)ï¼Œå› ä¸ºæˆ‘æ‡’å¾—å»çœ‹é‡Œé¢çš„ APIï¼Œæ‰€ä»¥å°±è‡ªå·±è¿›è¡Œçš„åˆ¤æ–­ã€‚å¦‚æœæœ‰å¤æ‚å¯¹è±¡ä¸”å­—æ®µå¤šçš„ï¼Œæ¨èä½¿ç”¨ç°æˆå·¥å…·ç±»ã€‚

å¯¹äºé˜Ÿåˆ—å®¹é‡ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„æ£€æŸ¥ `isQueueCapacityChanged`ï¼Œå› ä¸ºä¸æ˜¯æ‰€æœ‰é˜Ÿåˆ—éƒ½æ”¯æŒåŠ¨æ€è°ƒæ•´å®¹é‡ã€‚é˜Ÿåˆ—å®¹é‡ä»…æ”¯æŒæˆ‘ä»¬è‡ªå®šä¹‰çš„ `ResizableCapacityLinkedBlockingQueue`ï¼Œå¦åˆ™ä¸å¯åŠ¨æ€è°ƒæ•´ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private boolean isQueueCapacityChanged(...){
        Integer remoteCapacity = remoteProperties.getQueueCapacity();
        Integer originalCapacity = originalProperties.getQueueCapacity();
        BlockingQueue<?> queue = executor.getQueue();
    â€‹
        return remoteCapacity != null
            && !Objects.equals(remoteCapacity, originalCapacity)
            && Objects.equals("ResizableCapacityLinkedBlockingQueue", queue.getClass().getSimpleName());
    }
    â€‹
              
åªæœ‰è¿œç¨‹é…ç½®ä¸­çš„é˜Ÿåˆ—å®¹é‡ä¸ä¸ºç©ºï¼Œå¹¶ä¸”ä¸å½“å‰å†…å­˜ä¸­çš„é…ç½®ä¸ä¸€è‡´ï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹æ± ä½¿ç”¨çš„æ˜¯æ”¯æŒåŠ¨æ€æ‰©å®¹çš„é˜Ÿåˆ—ï¼ˆå¦‚`ResizableCapacityLinkedBlockingQueue`ï¼‰ï¼Œæ‰è®¤ä¸ºå®¹é‡ç¡®å®å‘ç”Ÿäº†å˜åŒ–ã€‚
> é»˜è®¤çš„ ArrayBlockingQueue å’Œ LinkedBlockingQueue ä¸ºä»€ä¹ˆä¸èƒ½æ”¹å˜å®¹é‡ï¼Œä¸‹ä¸€ç« èŠ‚ä¼šè¯¦ç»†è¯´æ˜ã€‚

çº¿ç¨‹æ± é…ç½®å˜æ›´
-------

å¦‚æœæ£€æµ‹åˆ°å˜åŒ–ï¼Œè°ƒç”¨çº¿ç¨‹æ± åˆ·æ–°æ–¹æ³•åº”ç”¨æ–°çš„é…ç½®ï¼š

### 1. æ ¸å¿ƒ / æœ€å¤§çº¿ç¨‹æ•° {#1}

çº¿ç¨‹æ•°æ›´æ–°çš„åŸåˆ™æ˜¯ï¼š**å…ˆæœ€å¤§åæ ¸å¿ƒ** ã€‚å¦‚æœæ–°æ ¸å¿ƒçº¿ç¨‹æ•°å¤§äºå½“å‰æœ€å¤§çº¿ç¨‹æ•°ï¼Œå¿…é¡»å…ˆè°ƒå¤§ `maximumPoolSize`ï¼Œå¦åˆ™ JDK ä¼šæŠ› `IllegalArgumentException`ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    Integer remoteCorePoolSize = remoteProperties.getCorePoolSize();
    Integer remoteMaximumPoolSize = remoteProperties.getMaximumPoolSize();
    if (remoteCorePoolSize != null && remoteMaximumPoolSize != null) {
        int originalMaximumPoolSize = executor.getMaximumPoolSize();
        if (remoteCorePoolSize > originalMaximumPoolSize) {
            executor.setMaximumPoolSize(remoteMaximumPoolSize);
            executor.setCorePoolSize(remoteCorePoolSize);
        } else {
            executor.setCorePoolSize(remoteCorePoolSize);
            executor.setMaximumPoolSize(remoteMaximumPoolSize);
        }
    } else {
        if (remoteMaximumPoolSize != null) {
            executor.setMaximumPoolSize(remoteMaximumPoolSize);
        }
        if (remoteCorePoolSize != null) {
            executor.setCorePoolSize(remoteCorePoolSize);
        }
    }
              
ä¹‹æ‰€ä»¥ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæ˜¯å› ä¸º JDK17 **çº¿ç¨‹æ± åº•å±‚åœ¨è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶åšäº†å‚æ•°é™åˆ¶æ ¡éªŒ** ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public void setCorePoolSize(int corePoolSize) {
        if (corePoolSize < 0 || maximumPoolSize < corePoolSize)
            throw new IllegalArgumentException();
        int delta = corePoolSize - this.corePoolSize;
        this.corePoolSize = corePoolSize;
        if (workerCountOf(ctl.get()) > corePoolSize)
            interruptIdleWorkers();
        else if (delta > 0) {
            // We don't really know how many new threads are "needed".
            // As a heuristic, prestart enough new workers (up to new
            // core size) to handle the current number of tasks in
            // queue, but stop if queue becomes empty while doing so.
            int k = Math.min(delta, workQueue.size());
            while (k-- > 0 && addWorker(null, true)) {
                if (workQueue.isEmpty())
                    break;
            }
        }
    }
              
æœ‰äº›åŒå­¦å¯èƒ½æ‰“å¼€è‡ªå·±é¡¹ç›®ä¸€çœ‹ï¼Œå‘ç°ä»£ç é‡Œå¹¶æ²¡æœ‰ç›¸å…³æ ¡éªŒé€»è¾‘ï¼Œè¿™æ˜¯å› ä¸º **JDK8å¹¶æœªå¼•å…¥è¿™æ®µçº¿ç¨‹æ•°çš„æ ¡éªŒæœºåˆ¶** ã€‚æˆ‘åœ¨å¼€å‘ Hippo4j çš„è¿‡ç¨‹ä¸­ä¹Ÿæ›¾è¸©è¿‡è¿™ä¸ªå‘ï¼Œæ„ŸåŒèº«å—ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public void setCorePoolSize(int corePoolSize) {
        if (corePoolSize < 0)
            throw new IllegalArgumentException();
        int delta = corePoolSize - this.corePoolSize;
        this.corePoolSize = corePoolSize;
        if (workerCountOf(ctl.get()) > corePoolSize)
            interruptIdleWorkers();
        else if (delta > 0) {
            // We don't really know how many new threads are "needed".
            // As a heuristic, prestart enough new workers (up to new
            // core size) to handle the current number of tasks in
            // queue, but stop if queue becomes empty while doing so.
            int k = Math.min(delta, workQueue.size());
            while (k-- > 0 && addWorker(null, true)) {
                if (workQueue.isEmpty())
                    break;
            }
        }
    }
              
å…·ä½“å¯ä»¥å‚è€ƒè¿™ä¸ª Issue ğŸ‘‰ [Hippo4j Issue#1063](https://github.com/opengoofy/hippo4j/issues/1063)ï¼Œé‡Œé¢æœ‰è¯¦ç»†çš„åˆ†æè¿‡ç¨‹å’Œå¤ç°åœºæ™¯ã€‚

### 2. æ‹’ç»ç­–ç•¥ {#2}

å€ŸåŠ©æšä¸¾å·¥å‚æ–¹æ³•æŠŠå­—ç¬¦ä¸²ç­–ç•¥åè½¬æ¢ä¸ºçœŸæ­£çš„ `RejectedExecutionHandler` å®ä¾‹ï¼Œä¿è¯å¯æ’æ‹”ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    if (remoteProperties.getRejectedHandler() != null &&
            !Objects.equals(remoteProperties.getRejectedHandler(), originalProperties.getRejectedHandler())) {
        RejectedExecutionHandler handler = RejectedPolicyTypeEnum.createPolicy(remoteProperties.getRejectedHandler());
        executor.setRejectedExecutionHandler(handler);
    }
              
### 3. é˜Ÿåˆ—å®¹é‡åŠ¨æ€æ‰©å®¹ {#3}

åªæœ‰å½“é˜Ÿåˆ—å®ä¾‹å®ç°äº†å¯æ‰©å®¹æ¥å£æ—¶æ‰å¯ä»¥ä¿®æ”¹å®¹é‡ï¼Œé¿å… `LinkedBlockingQueue` ç­‰ JDK åŸç”Ÿé˜Ÿåˆ—ä¸æ”¯æŒå®¹é‡å˜åŒ–å¯¼è‡´çš„é£é™©ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    if (isQueueCapacityChanged(originalProperties, remoteProperties, executor)) {
        BlockingQueue<Runnable> queue = executor.getQueue();
        ResizableCapacityLinkedBlockingQueue<?> resizableQueue = (ResizableCapacityLinkedBlockingQueue<?>) queue;
        resizableQueue.setCapacity(remoteProperties.getQueueCapacity());
    }
              
### 4. åˆ·æ–°å…ƒæ•°æ®ã€å‘é€é€šçŸ¥ã€æ‰“å°å®¡è®¡æ—¥å¿— {#4}

çº¿ç¨‹æ± è¿è¡Œæ—¶å‚æ•°å˜æ›´åï¼Œè¿˜æœ‰ä¸€äº›åç½®é€»è¾‘éœ€è¦å¤„ç†ï¼š

* 1.  
æŠŠæœ€æ–°é…ç½®å†™å›æ³¨å†Œè¡¨ï¼Œä¿è¯åç»­å†è¯»å–æ—¶å°±æ˜¯æ–°çš„å€¼ï¼›  
* 2.  
ç„¶åä¼šæŠŠ"æ—§å€¼ â†’ æ–°å€¼"çš„æ˜ å°„å°è£…æˆ DTOï¼Œé€šè¿‡é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é‚®ä»¶ç­‰æ¸ é“æ¨é€ç»™å¼€å‘ / è¿ç»´ï¼Œåšåˆ°å³æ—¶å¯è§ã€‚  
* 3.  
  ä¸ºå®ç°æ—¥å¿—ç•™ç—•ï¼Œä¼šé€šè¿‡ `log.info` ç»Ÿä¸€æ‰“å°æ‰€æœ‰å…³é”®å­—æ®µçš„ **"æ—§å€¼-\>æ–°å€¼"** ã€‚

ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    // çº¿ç¨‹æ± å‚æ•°å˜æ›´åè¿›è¡Œæ—¥å¿—æ‰“å°
    String threadPoolId = remoteProperties.getThreadPoolId();
    ThreadPoolExecutorHolder holder = OneThreadRegistry.getHolder(threadPoolId);
    ThreadPoolExecutorProperties originalProperties = holder.getExecutorProperties();
    holder.setExecutorProperties(remoteProperties);
    â€‹
    // å‘é€çº¿ç¨‹æ± é…ç½®å˜æ›´æ¶ˆæ¯é€šçŸ¥
    sendThreadPoolConfigChangeMessage(originalProperties, remoteProperties);
    â€‹
    // æ‰“å°çº¿ç¨‹æ± é…ç½®å˜æ›´æ—¥å¿—
    log.info(CHANGE_THREAD_POOL_TEXT,
            threadPoolId,
            String.format(CHANGE_DELIMITER, originalProperties.getCorePoolSize(), remoteProperties.getCorePoolSize()),
            String.format(CHANGE_DELIMITER, originalProperties.getMaximumPoolSize(), remoteProperties.getMaximumPoolSize()),
            String.format(CHANGE_DELIMITER, originalProperties.getQueueCapacity(), remoteProperties.getQueueCapacity()),
            String.format(CHANGE_DELIMITER, originalProperties.getKeepAliveTime(), remoteProperties.getKeepAliveTime()),
            String.format(CHANGE_DELIMITER, originalProperties.getRejectedHandler(), remoteProperties.getRejectedHandler()),
            String.format(CHANGE_DELIMITER, originalProperties.getAllowCoreThreadTimeOut(), remoteProperties.getAllowCoreThreadTimeOut()));
              
å¦‚ä½•ä¿éšœçº¿ç¨‹æ± é…ç½®åˆ·æ–°çš„å¹¶å‘å®‰å…¨ï¼Ÿ
-----------------

åœ¨åŠ¨æ€çº¿ç¨‹æ± çš„é…ç½®åˆ·æ–°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶è§¦å‘é…ç½®å˜æ›´ï¼ˆæ¯”å¦‚é…ç½®ä¸­å¿ƒæ¨é€å—ç½‘ç»œå½±å“é‡å¤æ¨é€ã€å¤šç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨é‡å¤ã€å®šæ—¶æ ¡éªŒç­‰ï¼‰ï¼Œä½†å¿…é¡»**ä¿è¯åŒä¸€ä¸ªçº¿ç¨‹æ± çš„å‚æ•°åˆ·æ–°æ˜¯ä¸²è¡Œã€åŸå­ã€å®‰å…¨çš„** ã€‚

å¦åˆ™å°±å¯èƒ½å¯¼è‡´ï¼š

*  
å‚æ•°é”™ä¹±ï¼šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ corePoolSize å’Œ maximumPoolSizeï¼Œæœ€ç»ˆå€¼ä¸å¯é¢„æœŸï¼›  
*  
æ—¥å¿—æ··ä¹±ï¼šåŸå§‹å€¼å’Œæ–°å€¼æ‰“å°é”™ä½ï¼›  
*  
é˜Ÿåˆ—æ‰©å®¹å¤±è´¥ï¼šå¹¶å‘ä¿®æ”¹ `ResizableCapacityLinkedBlockingQueue` ä¼šæŠ›å¼‚å¸¸ï¼›  
*  
  ä¸ä¸€è‡´æ€§ï¼šé€šçŸ¥å‘é€å’Œå®é™…çº¿ç¨‹æ± çŠ¶æ€ä¸ä¸€è‡´ã€‚

åœ¨å¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜æ—¶ï¼Œæˆ‘è€ƒè™‘äº†ä¸¤ç§æ–¹æ¡ˆï¼š

* 1.  
**å¯¹æ•´ä¸ªæ–¹æ³•åŠ é”** ï¼šå®ç°æœ€ç®€å•ï¼Œèƒ½å¿«é€Ÿè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›  
* 2.  
  **ä»…å¯¹æŒ‡å®šçš„çº¿ç¨‹æ± IDåŠ é”** ï¼šç²’åº¦æ›´ç»†ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚

è™½ç„¶ç¬¬ä¸€ç§æ–¹å¼å®ç°èµ·æ¥æœ€çœäº‹ï¼Œä½†**ç‹¬å±äºç¨‹åºå‘˜çš„"å¼ºè¿«ç—‡"è®©æˆ‘ä¸å¤ªèƒ½æ¥å—è¿™ç§å¤„ç†æ–¹å¼** ã€‚å› æ­¤ï¼Œæœ€ç»ˆæˆ‘é€‰æ‹©äº†ç¬¬äºŒç§æ–¹æ¡ˆï¼Œå¯¹çº¿ç¨‹æ±  ID ç»´åº¦åŠ é”ã€‚

### 1. ä½¿ç”¨ synchronized (id) {#1-synchronized-id}

ä»£ç ç¤ºä¾‹ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    synchronized (threadPoolId) {
        // do refresh
    }
              
å­˜åœ¨çš„é—®é¢˜ï¼š

*  
å¦‚æœ `threadPoolId` æ˜¯ä»å¯¹è±¡å­—æ®µè·å–çš„ï¼ˆä¾‹å¦‚ `.getThreadPoolId()`ï¼‰ï¼Œå¤šä¸ªå¯¹è±¡å³ä½¿è¿”å›ç›¸åŒå†…å®¹ï¼Œä¹Ÿå¯èƒ½æ˜¯**ä¸åŒçš„Stringå®ä¾‹** ã€‚  
*  
  JVM ä¼šå¯¹ä¸åŒçš„å¼•ç”¨åˆ†é…ä¸åŒçš„é” â†’ **é”ä¸ç”Ÿæ•ˆ** ï¼Œå¹¶å‘å†²çªä¾ç„¶ä¼šå‘ç”Ÿã€‚

### 2. ä½¿ç”¨ ConcurrentHashMap\<String, ReentrantLock\> {#2-concurrent-hash-map-string-reentrant-lock}

ä»£ç ç¤ºä¾‹ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    private static final ConcurrentMap<String, ReentrantLock> lockMap = new ConcurrentHashMap<>();
    â€‹
    ReentrantLock lock = lockMap.computeIfAbsent(threadPoolId, k -> new ReentrantLock());
    lock.lock();
    try {
        // do refresh
    } finally {
        lock.unlock();
    }
              
å­˜åœ¨çš„é—®é¢˜ï¼š

*  
éœ€è¦ç»´æŠ¤é”ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚ä»€ä¹ˆæ—¶å€™é‡Šæ”¾é”å†…å­˜ï¼Ÿ  
*  
  å¯¹äºä¸­å°é¡¹ç›®æˆ–è½»é‡ç»„ä»¶æ¥è¯´æœ‰ç‚¹"é‡"ã€‚

### 3. ä½¿ç”¨ .intern() åŸºäºå†…å®¹å€¼æ„å»ºé” {#3-intern}

ä»£ç ç¤ºä¾‹ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    String threadPoolId = remoteProperties.getThreadPoolId();
    synchronized (threadPoolId.intern()) {
        // do refresh
    }
              
ä¼˜åŠ¿ï¼š

*  
ä»»ä½•å†…å®¹ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œè°ƒç”¨ `.intern()` åéƒ½ä¼šè¿”å›**åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨** ï¼›  
*  
ä¸ä¾èµ–å¤–éƒ¨é”è¡¨ï¼Œ**é›¶ä¾èµ–ã€çº¿ç¨‹å®‰å…¨** ï¼›  
*  
  é”ç²’åº¦ä»¥çº¿ç¨‹æ±  ID ä¸ºå•ä½ï¼Œå¤©ç„¶æ”¯æŒå¹¶å‘åˆ·æ–°å¤šä¸ªçº¿ç¨‹æ± ã€‚

#### 3.1 .intern() åŸç† {#3-1-intern}

`.intern()` æ˜¯ Java æä¾›çš„**å­—ç¬¦ä¸²å¸¸é‡æ± æœºåˆ¶** çš„ä¸€éƒ¨åˆ†ã€‚

*  
å®ƒä¼šå°†å½“å‰å­—ç¬¦ä¸²åŠ å…¥ JVM çš„å­—ç¬¦ä¸²æ± ï¼ˆString Poolï¼‰ä¸­ï¼›  
*  
å¦‚æœå­—ç¬¦ä¸²æ± ä¸­å·²æœ‰ç›¸åŒå†…å®¹çš„å­—ç¬¦ä¸²ï¼Œåˆ™ç›´æ¥è¿”å›é‚£ä¸€ä»½å¯¹è±¡å¼•ç”¨ï¼›  
*  
  è¿™å°±ç¡®ä¿äº†**åŒå†…å®¹å­—ç¬¦ä¸²â†’åŒå¼•ç”¨å¯¹è±¡** ï¼Œä»è€Œè®© `synchronized` ç”Ÿæ•ˆã€‚

ä¸¾ä¸ªä¾‹å­ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    String s1 = new String("abc");
    String s2 = new String("abc");
    â€‹
    System.out.println(s1 == s2);                // falseï¼Œä¸åŒå¼•ç”¨
    System.out.println(s1.intern() == s2.intern());  // trueï¼Œintern åç›¸åŒå¼•ç”¨
              
æ‰€ä»¥ï¼Œåœ¨åšå­—ç¬¦ä¸²å†…å®¹çº§åˆ«çš„åŒæ­¥æ§åˆ¶æ—¶ï¼Œ**åªæœ‰`.intern()`èƒ½å¤Ÿåœ¨ä¸åŒå¯¹è±¡é—´å¤ç”¨åŒä¸€é”å¯¹è±¡** ã€‚

![image-20250718154039085.png](https://article-images.zsxq.com/FtPYd1R2h_PFdJxxfdAusRRqGAUp "image-20250718154039085.png")

#### 3.2 åˆ·æ–°ä»£ç å®æˆ˜ {#3-2}

å®é™…ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    // åˆ·æ–°åŠ¨æ€çº¿ç¨‹æ± å¯¹è±¡æ ¸å¿ƒå‚æ•°
    for (ThreadPoolExecutorProperties remoteProperties : refresherProperties.getExecutors()) {
        String threadPoolId = remoteProperties.getThreadPoolId();
        // ä»¥çº¿ç¨‹æ±  ID ä¸ºç²’åº¦åŠ é”ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ·æ–°åŒä¸€ä¸ªçº¿ç¨‹æ± 
        synchronized (threadPoolId.intern()) {
            // æ£€æŸ¥çº¿ç¨‹æ± é…ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼ˆä¸å½“å‰å†…å­˜ä¸­çš„é…ç½®å¯¹æ¯”ï¼‰
            boolean changed = hasThreadPoolConfigChanged(remoteProperties);
            if (!changed) {
                continue;
            }
            // ......
        }
    }
              
#### 3.3 å¹¶å‘å•å…ƒæµ‹è¯• {#3-3}

å¤§å®¶æ„Ÿå…´è¶£å¯ä»¥è¯•è¯•è¿™è¿™ä¸ªå•å…ƒæµ‹è¯•ï¼Œåˆ†åˆ«æ˜¯åŠ  `.intern()` å’Œä¸åŠ çš„æ–¹æ¡ˆã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    import java.util.concurrent.ExecutorService;
    import java.util.concurrent.Executors;

    public class InternFromObjectPropertyTest {

        public static void main(String[] args) {
            ExecutorService executor = Executors.newFixedThreadPool(5);

            for (int i = 0; i < 5; i++) {
                executor.submit(() -> {
                    // æ¯ä¸ªçº¿ç¨‹æ„é€ ä¸€ä¸ªç‹¬ç«‹å¯¹è±¡ï¼Œä½† threadPoolId å†…å®¹ç›¸åŒ
                    ThreadPoolExecutorProperties props = new ThreadPoolExecutorProperties("core-biz-pool");

                    // âŒ ä¸åŠ  internï¼šé”å¤±æ•ˆ
                    // Object lock = props.getThreadPoolId();

                    // âœ… åŠ  internï¼šåŒå†…å®¹ï¼ŒåŒé”å¯¹è±¡
                    Object lock = props.getThreadPoolId().intern();

                    synchronized (lock) {
                        String threadName = Thread.currentThread().getName();
                        System.out.printf("[%d] %s æ­£åœ¨åˆ·æ–°çº¿ç¨‹æ±  %s%n",
                                System.currentTimeMillis(), threadName, props.getThreadPoolId());

                        try {
                            Thread.sleep(1000);
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                        }

                        System.out.printf("[%d] %s åˆ·æ–°å®Œæˆ%n",
                                System.currentTimeMillis(), threadName);
                    }
                });
            }

            executor.shutdown();
        }
    }

    @Data
    public class ThreadPoolExecutorProperties {

        private String threadPoolId;

        /**
         * å¦‚æœå¤§å®¶å¯¹æ‰‹åŠ¨ new Stringï¼ˆå¼ºåˆ¶åˆ›å»ºæ–°å¯¹è±¡ï¼‰æœ‰ç–‘æƒ‘
         * å¯ä»¥æŠŠè¿™è¡Œä»£ç åŠ åˆ°åŠ¨æ€çº¿ç¨‹æ± é…ç½®åˆ·æ–°çš„æµç¨‹é‡Œï¼ŒæŸ¥çœ‹æ¯ä¸€æ¬¡ç›¸åŒçš„ threadPoolId HashCode å€¼æ˜¯å¦ç›¸åŒ
         * System.out.println(System.identityHashCode(threadPoolId));
         * <p>
         * å› ä¸ºæ¯æ¬¡é…ç½®ä¸­å¿ƒçš„å­—ç¬¦ä¸²éƒ½æ˜¯é‡æ–°åˆ›å»ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†è´´åˆå®é™…åœºæ™¯ï¼Œæ‰€ä»¥æ˜¯ç›´æ¥ new String
         */
        public ThreadPoolExecutorProperties(String threadPoolId) {
            // æ¨¡æ‹Ÿå†…å®¹ç›¸åŒï¼Œä½†å¼•ç”¨ä¸åŒ
            this.threadPoolId = new String(threadPoolId);
        }
    }
              
æ–‡æœ«æ€»ç»“
----

åŠ¨æ€çº¿ç¨‹æ± ç»„ä»¶çš„å®ç°çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™æš—è—è¯¸å¤šç»†èŠ‚ä¸æŒ‘æˆ˜ã€‚ä»è¿œç¨‹é…ç½®æ„ŸçŸ¥ã€å·®å¼‚åŒ–æ¯”å¯¹ã€çº¿ç¨‹æ± å‚æ•°å®‰å…¨åˆ·æ–°ï¼Œåˆ°æ³¨å†Œä¸­å¿ƒçš„å…ƒæ•°æ®æ›´æ–°ä¸å¯è§‚æµ‹æ—¥å¿—è¾“å‡ºï¼Œæ¯ä¸€æ­¥éƒ½éœ€è¦ä¸¥è°¨è®¾è®¡ã€‚è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿˜å¿…é¡»è€ƒè™‘å¤šç§å› ç´ ï¼šä¸åŒç‰ˆæœ¬çš„ JDK å¯¹çº¿ç¨‹æ± è¡Œä¸ºçš„å·®å¼‚ã€é˜»å¡é˜Ÿåˆ—æ˜¯å¦æ”¯æŒæ‰©å®¹ã€æ‹’ç»ç­–ç•¥çš„å¯æ’æ‹”æ€§ã€é…ç½®å˜æ›´çš„å¹‚ç­‰æ€§ã€å¹¶å‘åœºæ™¯ä¸‹çš„çº¿ç¨‹å®‰å…¨ç­‰ã€‚

å†™ä¸€ä¸ª"èƒ½ç”¨"çš„ç»„ä»¶å¾ˆå®¹æ˜“ï¼Œä½†è¦å†™ä¸€ä¸ª"å¥å£®ã€é€šç”¨ã€å¯ç»´æŠ¤"çš„ç»„ä»¶ï¼Œå°±å¿…é¡»åœ¨è®¾è®¡å±‚é¢ä¸‹è¶³åŠŸå¤«ã€‚å¸Œæœ›æœ¬æ–‡çš„æ‹†è§£ï¼Œèƒ½ä¸ºå¤§å®¶å­¦ä¹ çº¿ç¨‹æ± æ²»ç†ä½“ç³»æä¾›ä¸€äº›ç»éªŒã€‚

å®Œç»“ï¼Œæ’’èŠ± ğŸ‰

