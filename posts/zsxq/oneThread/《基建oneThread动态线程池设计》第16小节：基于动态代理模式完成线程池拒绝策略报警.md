2025å¹´07æœˆ23æ—¥ 20:11  
åŸºäºåŠ¨æ€ä»£ç†æ¨¡å¼å®Œæˆçº¿ç¨‹æ± æ‹’ç»ç­–ç•¥æŠ¥è­¦ï¼Œå…ƒæ•°æ®ä¿¡æ¯ï¼š

*  
ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± oneThreadï¼š<https://t.zsxq.com/5GfrN>  
*  
ä»£ç ä»“åº“ï¼š<https://gitcode.net/nageoffer/onethread> ------ ç”³è¯·é¡¹ç›®æƒé™å‚è€ƒä¸Šè¿°çº¿ç¨‹æ± é¡¹ç›®é“¾æ¥  
*  
ç« èŠ‚éš¾åº¦ï¼šâ˜…â˜…â˜†â˜†â˜† - ä¸­ç­‰  
*  
  è§†é¢‘åœ°å€ï¼šæœ¬ç« èŠ‚å†…å®¹ç®€å•ï¼Œæ— 



\***å†…å®¹æ‘˜è¦ï¼šæœ¬æ–‡ä»‹ç»å¦‚ä½•åŸºäº** JDK åŠ¨æ€ä»£ç†\*\*å’Œ Lambda è½»é‡çº§é™æ€ä»£ç†ï¼Œä¼˜é›…åœ°æ‰©å±•çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥è¡Œä¸ºï¼Œå®ç°æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ä¸å‡†å®æ—¶å‘Šè­¦ã€‚

è¯¾ç¨‹ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š

*  
å‰è¨€  
*  
çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡åœºæ™¯  
*  
ä»£ç†æ¨¡å¼  
*  
åŠ¨æ€ä»£ç†  
*  
Lambda è½»é‡çº§é™æ€ä»£ç†  
*  
  æ–‡æœ«æ€»ç»“

> åœ¨é˜…è¯»æœ¬ç« èŠ‚å‰ï¼Œå¤§å®¶å…ˆé€šè¿‡Breatheå…¬ä¼—å·çš„ä¸€ç¯‡æ–‡ç«  [MyBatisåŠ¨æ€ä»£ç†æ ¸å¿ƒåŸç†](https://mp.weixin.qq.com/s/_7NHd5asmo8DbGANyQM4Vw) å­¦ä¹ åŠ¨æ€ä»£ç†ï¼Œä¸‹é¢æ–‡ç« å°†ä¸å†èµ˜è¿°ã€‚

å‰è¨€
---

çº¿ç¨‹æ± ä½œä¸ºä»»åŠ¡å¹¶å‘å¤„ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…¶ç¨³å®šæ€§ç›´æ¥å½±å“ç³»ç»Ÿæ•´ä½“ååä¸å“åº”èƒ½åŠ›ã€‚è€Œçº¿ç¨‹æ± ä¸­çš„**æ‹’ç»ç­–ç•¥** ï¼Œä½œä¸ºæœ€åä¸€é“é˜²çº¿ï¼Œå¾€å¾€ä»£è¡¨äº†ç³»ç»Ÿå·²å‡ºç°çŸ­æ—¶ç“¶é¢ˆæˆ–é…ç½®ä¸åˆç†ç­‰é—®é¢˜ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ‹’ç»ä»»åŠ¡å‘ç”Ÿçš„ç¬¬ä¸€æ—¶é—´ï¼š

*  
ä¸ŠæŠ¥æŠ¥è­¦ï¼Œå‘ŠçŸ¥ç³»ç»Ÿç»´æŠ¤äººå‘˜ï¼›  
*  
è®°å½•å…³é”®æŒ‡æ ‡ï¼Œä¾¿äºäº‹ååˆ†æä¸æ‰©å®¹è°ƒä¼˜ï¼›  
*  
  ......

ç°å®æ¯”è¾ƒéª¨æ„Ÿï¼ŒJDK çº¿ç¨‹æ± ä»…èƒ½å®Œæˆæ‹’ç»åŸºç¡€é€»è¾‘ï¼Œæ— æ³•æ»¡è¶³ç³»ç»Ÿè¦æ±‚ã€‚ä¸‹æ–‡å°†ä»‹ç»å¦‚ä½•ä¼˜é›…åœ°ä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œä»é™æ€ä»£ç†é€æ­¥ä¼˜åŒ–åˆ°åŠ¨æ€ä»£ç†ï¼Œå®ç°çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡çš„ç»Ÿè®¡ä¸å®æ—¶å‘Šè­¦åŠŸèƒ½ã€‚

çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡åœºæ™¯
---------

çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡æœ‰ä¸¤ä¸ªä¸»è¦è§¦å‘æ¡ä»¶ï¼š

* 1.  
çº¿ç¨‹æ± çŠ¶æ€éè¿è¡ŒçŠ¶æ€ã€‚  
* 2.  
  é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼Œä¸”çº¿ç¨‹æ± çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼ã€‚

textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    final void reject(Runnable command) {
        handler.rejectedExecution(command, this);
    }
              
æ³¨æ„åˆ°ä¸Šè¿°æ–¹æ³•ä¸ºé»˜è®¤æƒé™ä¸”è¢« `final` ä¿®é¥°ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥æ‰©å±•ã€‚

ä»£ç†æ¨¡å¼
----

å°½ç®¡çº¿ç¨‹æ± çš„æ‹’ç»ä»»åŠ¡æ–¹æ³•è¢«è®¾ç½®ä¸º `final` ä¸”å…·æœ‰é»˜è®¤è®¿é—®æƒé™ï¼Œå¯¼è‡´æˆ‘ä»¬**æ— æ³•ç»§æ‰¿æˆ–é‡å†™è¯¥æ–¹æ³•** ï¼Œä½†æˆ‘ä»¬ä»å¯ä»¥é€šè¿‡ **ä»£ç†æ¨¡å¼** å®ç°æ‰©å±•åŠŸèƒ½ã€‚

**ä»£ç†æ¨¡å¼** ï¼ˆProxy Design Patternï¼‰æ˜¯ä¸€ç§åœ¨**ä¸ä¿®æ”¹åŸå§‹ç±»ä»£ç çš„å‰æä¸‹** ï¼Œé€šè¿‡å¼•å…¥ä»£ç†å¯¹è±¡å¯¹å…¶è¡Œä¸ºè¿›è¡Œå¢å¼ºçš„è®¾è®¡æ‰‹æ®µï¼Œéå¸¸é€‚åˆç”¨äºåŠŸèƒ½å¢å¼ºã€æƒé™æ§åˆ¶ã€å»¶è¿ŸåŠ è½½ç­‰åœºæ™¯ã€‚

![iShot_2025-07-19_13.07.31.png](https://article-images.zsxq.com/Fkg9PO-tIsoCBGRmPCOG--LP1SUj "iShot_2025-07-19_13.07.31.png")

æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€æ­¥å®ç° **åŸºäºä»£ç†æ¨¡å¼çš„æ‹’ç»ç­–ç•¥æ‰©å±•** ï¼ŒåŒ…æ‹¬æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ä¸å‘Šè­¦è§¦å‘ä¸¤ä¸ªæ ¸å¿ƒèƒ½åŠ›ã€‚

### 1. æ‰©å±•çº¿ç¨‹æ±  {#1}

é™æ€ä»£ç†æ¨¡å¼éœ€è¦åˆ›å»ºå¤šä¸ªå…·ä½“å®ç°ç±»æ¥å¢å¼ºåŸå§‹æ‹’ç»ç­–ç•¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public class SupportThreadPoolExecutor extends ThreadPoolExecutor {
    â€‹
        /** æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ */
        private final AtomicInteger rejectCount = new AtomicInteger();
    â€‹
        public SupportThreadPoolExecutor(...) {
            super(...);
        }
    â€‹
        /** æ‹’ç»æ¬¡æ•°è‡ªå¢ */
        public void incrementRejectCount() {
            rejectCount.incrementAndGet();
        }
    â€‹
        /** è·å–å½“å‰æ‹’ç»æ¬¡æ•° */
        public int getRejectCount() {
            return rejectCount.get();
        }
    }
              
### 2. æ‰©å±•æ‹’ç»ç­–ç•¥ {#2}

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡å®šä¹‰ä¸€ä¸ªé€šç”¨çš„æ‹’ç»ç­–ç•¥æ‰©å±•æ¥å£ï¼Œä¸ºåç»­å…·ä½“ç­–ç•¥æä¾›ç»Ÿä¸€çš„å¢å¼ºèƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼š

*  
**æ‹’ç»æ¬¡æ•°ç»Ÿè®¡** ï¼›  
*  
  **æŠ¥è­¦é€šçŸ¥è§¦å‘** ã€‚

ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public interface SupportRejectedExecutionHandler extends RejectedExecutionHandler {
    â€‹
        /**
         * æ‹’ç»ç­–ç•¥å‰ç½®å¤„ç†é€»è¾‘ï¼šç»Ÿè®¡ä¸å‘Šè­¦ã€‚
         */
        default void beforeReject(ThreadPoolExecutor executor) {
            if (executor instanceof SupportThreadPoolExecutor) {
                SupportThreadPoolExecutor supportExecutor = (SupportThreadPoolExecutor) executor;
                // æ‹’ç»æ¬¡æ•°è‡ªå¢
                supportExecutor.incrementRejectCount();
                // æ‰§è¡Œå‘Šè­¦é€»è¾‘ï¼ˆå¯æ›¿æ¢ä¸ºå®é™…æ¨é€æ¸ é“ï¼‰
                System.out.println("çº¿ç¨‹æ± è§¦å‘äº†ä»»åŠ¡æ‹’ç»...");
            }
        }
    }
              
ç„¶åä»¥ `AbortPolicy` ä¸ºä¾‹ï¼Œå®ç°ä¸€ä¸ªå…·å¤‡æ‰©å±•èƒ½åŠ›çš„æ‹’ç»ç­–ç•¥ç±»ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public class SupportAbortPolicyRejected extends ThreadPoolExecutor.AbortPolicy
            implements SupportRejectedExecutionHandler {
    â€‹
        @Override
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            beforeReject(e); // æ‹’ç»å‰æ‰§è¡Œæ‰©å±•é€»è¾‘
            super.rejectedExecution(r, e); // è°ƒç”¨åŸå§‹ç­–ç•¥è¡Œä¸º
        }
    }
              
### 3. åŠŸèƒ½éªŒè¯ {#3}

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ä¸Šè¿°æ‰©å±•æ‹’ç»ç­–ç•¥æ˜¯å¦èƒ½å®ç°**æ‹’ç»ç»Ÿè®¡+å‘Šè­¦è¾“å‡º** çš„é¢„æœŸåŠŸèƒ½ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @SneakyThrows
    public static void main(String[] args) {
        SupportThreadPoolExecutor executor = new SupportThreadPoolExecutor(
                1,
                1,
                1024,
                TimeUnit.SECONDS,
                new LinkedBlockingQueue<>(1),
                // ä½¿ç”¨è‡ªå®šä¹‰çš„å¢å¼ºå‹æ‹’ç»ç­–ç•¥
                new SupportAbortPolicyRejected()
        );
    â€‹
        // æäº¤ 3 ä¸ªä»»åŠ¡ï¼Œè¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°å’Œé˜Ÿåˆ—å®¹é‡ï¼Œè§¦å‘æ‹’ç»
        for (int i = 0; i < 3; i++) {
            try {
                executor.execute(() -> Thread.sleep(Integer.MAX_VALUE));
            } catch (Exception ex) {
                // å¿½ç•¥æ‹’ç»å¼‚å¸¸ï¼Œä¸“æ³¨éªŒè¯ç»Ÿè®¡ä¸å‘Šè­¦é€»è¾‘
            }
        }
    â€‹
        Thread.sleep(50);
        System.out.println(String.format("çº¿ç¨‹æ± æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ :: %d", executor.getRejectCount()));
    }
    â€‹
    // æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹ï¼š
    çº¿ç¨‹æ± è§¦å‘äº†ä»»åŠ¡æ‹’ç»...
    çº¿ç¨‹æ± æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ :: 1
              
ä»æ—¥å¿—å¯ä»¥ç¡®è®¤ï¼Œ**æˆ‘ä»¬çš„æ‰©å±•é€»è¾‘å·²æˆåŠŸç”Ÿæ•ˆ** ï¼š

*  
æ‹’ç»ç­–ç•¥è§¦å‘æ—¶ï¼Œæ‰§è¡Œäº† `beforeReject()` ä¸­çš„ç»Ÿè®¡ä¸æ—¥å¿—è¾“å‡ºã€‚  
*  
  çº¿ç¨‹æ± å‡†ç¡®è®°å½•äº†è¢«æ‹’ç»ä»»åŠ¡çš„æ¬¡æ•°ã€‚

### 4. æ¨¡å¼å°ç»“ {#4}

ä¸Šè¿°æ‰©å±•æ–¹æ¡ˆé‡‡ç”¨çš„æ˜¯ä¸€ç§ç»å…¸çš„è®¾è®¡æ¨¡å¼ï¼š**é™æ€ä»£ç†** ã€‚å»ºè®®å¤§å®¶åœ¨ç»§ç»­é˜…è¯»ä¹‹å‰ï¼Œå…ˆåœ¨æœ¬åœ°è¿è¡Œä¸€éç¤ºä¾‹ä»£ç ï¼Œé€šè¿‡å®è·µåŠ æ·±ç†è§£ã€‚

å®Œæˆè¿è¡Œåï¼Œæˆ‘ä»¬æ€»ç»“å‡ºä¸€å¼ å›¾ï¼Œå¸®åŠ©å¤§å®¶æ›´ç›´è§‚åœ°ç†è§£**é™æ€ä»£ç†çš„å·¥ä½œæœºåˆ¶** ï¼š

![iShot_2025-07-19_13.07.30.png](https://article-images.zsxq.com/FvtZIbjLfRueIB3hleGfdIK0M5xZ "iShot_2025-07-19_13.07.30.png")

é€šè¿‡æ‹’ç»ç­–ç•¥çš„å®æˆ˜æ¼”ç»ƒï¼Œå¤§å®¶å¯¹**é™æ€ä»£ç†çš„å®ç°æ–¹å¼** å·²ç»æœ‰äº†åˆæ­¥è®¤è¯†ã€‚ä½†é™æ€ä»£ç†çœŸçš„è¶³å¤Ÿä¼˜é›…å—ï¼Ÿæˆ‘ä»¬ä¸å¦¨å†·é™åˆ†æä¸€ä¸‹å…¶å±€é™æ€§ï¼š

*  
**ç±»çˆ†ç‚¸é—®é¢˜** ï¼šæ¯ä¸€ç§æ‹’ç»ç­–ç•¥éƒ½éœ€è¦æ‰‹åŠ¨åˆ›å»ºå¯¹åº”çš„ä»£ç†ç±»æ¥å®ç°å¢å¼ºé€»è¾‘ã€‚ä»¥ JDK æä¾›çš„å››ç§é»˜è®¤ç­–ç•¥ä¸ºä¾‹ï¼Œè‹¥éƒ½éœ€è¦æ‰©å±•ï¼Œå°±å¾—åˆ›å»ºå››ä¸ªé¢å¤–ç±»ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆ**å¼€é—­åŸåˆ™** ï¼Œä¹Ÿä¸åˆ©äºç»´æŠ¤ã€‚  
*  
  **ä¾µå…¥æ€§è¾ƒé«˜ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚åº¦** ï¼šæ‰€æœ‰çº¿ç¨‹æ± éƒ½å¿…é¡»æ˜¾å¼ä½¿ç”¨è¿™äº›å¢å¼ºåçš„æ‹’ç»ç­–ç•¥ï¼Œä¸€æ—¦é¡¹ç›®è§„æ¨¡æ‰©å¤§æˆ–å¼€å‘äººå‘˜æ›´æ›¿ï¼Œå®¹æ˜“é—æ¼ä»£ç†é€»è¾‘æˆ–å‡ºç°ä¸ä¸€è‡´å®ç°ï¼Œé€ æˆæ½œåœ¨çš„ç³»ç»Ÿé£é™©ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨ä¿è¯åŠŸèƒ½æ‰©å±•çš„åŒæ—¶é¿å…è¿™äº›é—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š**ä½¿ç”¨åŠ¨æ€ä»£ç†** ã€‚

åŠ¨æ€ä»£ç†
----

**åŠ¨æ€ä»£ç†** é€šè¿‡åœ¨**è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»** ï¼Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡è¡Œä¸ºçš„å¢å¼ºï¼Œé¿å…äº†å¯¹åŸå§‹ç±»çš„ä¾µå…¥å¼ä¿®æ”¹ï¼Œä»è€Œæ›´å¥½åœ°éµå¾ªäº†**å¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰** ã€‚

### 1. åˆ›å»ºåŠ¨æ€ä»£ç†ç±» {#1}

å®ç°äº† `java.lang.reflect.InvocationHandler` æ¥å£ï¼Œæ˜¯ JDK åŠ¨æ€ä»£ç†æœºåˆ¶çš„æ ¸å¿ƒæ¥å£ï¼Œç”¨äºå®šä¹‰ä»£ç†æ–¹æ³•çš„å¢å¼ºé€»è¾‘ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @AllArgsConstructor
    public class RejectedProxyInvocationHandler implements InvocationHandler {
    â€‹
        private final Object target;
        private final AtomicLong rejectCount;
    â€‹
        private static final String REJECT_METHOD = "rejectedExecution";
    â€‹
        @Override
        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
            if (REJECT_METHOD.equals(method.getName()) &&
                    args != null &&
                    args.length == 2 &&
                    args[0] instanceof Runnable &&
                    args[1] instanceof ThreadPoolExecutor) {
                rejectCount.incrementAndGet();
            }
    â€‹
            if ("toString".equals(method.getName()) && method.getParameterCount() == 0) {
                return target.getClass().getSimpleName();
            }
    â€‹
            try {
                return method.invoke(target, args);
            } catch (InvocationTargetException ex) {
                throw ex.getCause();
            }
        }
    }
              
æˆå‘˜å˜é‡ï¼š

*  
`target`ï¼šè¢«ä»£ç†çš„å¯¹è±¡ï¼Œé€šå¸¸æ˜¯æŸä¸ªå…·ä½“çš„ `RejectedExecutionHandler` å®ä¾‹ã€‚  
*  
`rejectCount`ï¼šçº¿ç¨‹å®‰å…¨çš„æ‹’ç»æ¬¡æ•°ç»Ÿè®¡å™¨ï¼Œä»£ç†ä¸­æ¯æ¬¡æ‹’ç»éƒ½ä¼šè‡ªå¢ã€‚  
*  
  `REJECT_METHOD`ï¼šå¸¸é‡ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­æ˜¯å¦æ˜¯ `rejectedExecution` æ–¹æ³•ã€‚

æ ¸å¿ƒæ–¹æ³• `invoke`ï¼š

* 1.  
  åˆ¤æ–­æ˜¯å¦æ˜¯æ‹’ç»æ–¹æ³•ï¼š
  * 1.  
  åˆ¤æ–­å½“å‰è°ƒç”¨çš„æ–¹æ³•æ˜¯å¦ä¸º `rejectedExecution`ï¼›  
  * 2.  
  æ ¡éªŒå‚æ•°åˆæ³•æ€§ï¼šä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ `Runnable` å’Œ `ThreadPoolExecutor`ï¼›  
  * 3.  
å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œè¡¨ç¤ºçº¿ç¨‹æ± æ‹’ç»äº†ä¸€ä¸ªä»»åŠ¡ï¼Œè°ƒç”¨ `rejectCount.incrementAndGet()` å®ç°æ‹’ç»æ¬¡æ•°ç´¯åŠ ã€‚  
* 2.  
  ç‰¹æ®Šå¤„ç† `toString` æ–¹æ³•ï¼š
  * 1.  
  ä¸ºäº†é¿å…åŠ¨æ€ä»£ç†å¯¹è±¡æ‰“å°å‡ºæ¥æ˜¯ä¸€å †ä»£ç†ç±»åï¼Œå•ç‹¬å¤„ç†äº† `toString()` æ–¹æ³•ï¼›  
  * 2.  
è¿”å›çš„æ˜¯è¢«ä»£ç†å¯¹è±¡çš„ç±»åï¼Œä¾¿äºæ—¥å¿—æˆ–è°ƒè¯•æ—¶è¯†åˆ«åŸå§‹æ‹’ç»ç­–ç•¥ç±»å‹ã€‚  
* 3.  
  åå°„è°ƒç”¨åŸå§‹é€»è¾‘ï¼š
  * 1.  
  æœ€ç»ˆé€šè¿‡åå°„è°ƒç”¨åŸå§‹ `RejectedExecutionHandler` çš„æ–¹æ³•ï¼Œç¡®ä¿åŸæœ‰é€»è¾‘ä¸è¢«ç ´åï¼›  
  * 2.  
    å¦‚æœç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™æŠ›å‡ºå…¶åŸå§‹å¼‚å¸¸ï¼ˆ`getCause()`ï¼‰ï¼Œä¿æŒè¡Œä¸ºä¸€è‡´ã€‚

å¦‚æœä½¿ç”¨äº†ä¸Šè¿°æ‹’ç»ç­–ç•¥åŠ¨æ€ä»£ç†ç±»ï¼Œæ‰€æœ‰å¯¹ `rejectedExecution()` çš„è°ƒç”¨éƒ½è¢«åŠ¨æ€ä»£ç†æ‹¦æˆªï¼Œæ‰§è¡Œäº†é¢å¤–çš„ç»Ÿè®¡ä¸å‘Šè­¦é€»è¾‘ã€‚åŒæ—¶**ä¿æŒäº†åŸç”Ÿè¯­ä¹‰** ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨åŸå§‹ç­–ç•¥çš„é€»è¾‘ï¼ˆå¦‚ `AbortPolicy` æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œä¸å½±å“çº¿ç¨‹æ± åŸæœ‰è¡Œä¸ºã€‚

![iShot_2025-07-19_13.07.28.png](https://article-images.zsxq.com/FsXLrnU6eyA_amgbwFUu5MUptcbw "iShot_2025-07-19_13.07.28.png")

### 2. oneThread çº¿ç¨‹æ± ä»£ç† {#2-one-thread}

åœ¨æ„å»ºçº¿ç¨‹æ± æ—¶ï¼Œæˆ‘ä»¬ä¾ç„¶ä¿ç•™ç”¨æˆ·è‡ªå®šä¹‰çš„åŸå§‹æ‹’ç»ç­–ç•¥ï¼Œ**ä¸ç ´åå…¶åŸæœ‰ä½¿ç”¨ä¹ æƒ¯** ã€‚ç„¶ååœ¨ `oneThread` çš„æ„é€ æ–¹æ³•ä¸­ï¼Œé€šè¿‡ **åŠ¨æ€ä»£ç†æ–¹å¼å¯¹æ‹’ç»ç­–ç•¥è¿›è¡Œå¢å¼ºå¤„ç†** ï¼Œå®ç°åŠŸèƒ½æ³¨å…¥ã€‚

è¿™ç§è®¾è®¡æ—¢ä¿æŒäº†**ç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§** ï¼Œåˆå®ç°äº†å¯¹çº¿ç¨‹æ± æ‹’ç»è¡Œä¸ºçš„**é€æ˜å¢å¼º** ï¼Œå…¼é¡¾äº†**å…¼å®¹æ€§ä¸å¯æ‰©å±•æ€§** ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    /**
     * å¢å¼ºçš„åŠ¨æ€ã€æŠ¥è­¦å’Œå—ç›‘æ§çš„çº¿ç¨‹æ±  oneThread
     * <p>
     * ä½œè€…ï¼šé©¬ä¸
     * åŠ é¡¹ç›®ç¾¤ï¼šæ—©åŠ å…¥å°±æ˜¯ä¼˜åŠ¿ï¼500äººå†…éƒ¨é¡¹ç›®ç¾¤ï¼Œåˆ†äº«çš„çŸ¥è¯†æ€»æœ‰ä½ éœ€è¦çš„ <a href="https://t.zsxq.com/cw7b9" />
     * å¼€å‘æ—¶é—´ï¼š2025-04-20
     */
    @Slf4j
    public class OneThreadExecutor extends ThreadPoolExecutor {
    â€‹
        // ......
    â€‹
        /**
         * çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
         */
        @Getter
        private final AtomicLong rejectCount = new AtomicLong();
    â€‹
        // ......
    â€‹
        public OneThreadExecutor(
                @NonNull String threadPoolId,
                int corePoolSize,
                int maximumPoolSize,
                long keepAliveTime,
                @NonNull TimeUnit unit,
                @NonNull BlockingQueue<Runnable> workQueue,
                @NonNull ThreadFactory threadFactory,
                @NonNull RejectedExecutionHandler handler,
                long awaitTerminationMillis) {
            super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);
    â€‹
            // é€šè¿‡åŠ¨æ€ä»£ç†è®¾ç½®æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
            setRejectedExecutionHandler(handler);
    â€‹
            // ......
        }
    â€‹
        @Override
        public void setRejectedExecutionHandler(RejectedExecutionHandler handler) {
            RejectedExecutionHandler rejectedProxy = (RejectedExecutionHandler) Proxy
                    .newProxyInstance(
                            handler.getClass().getClassLoader(),
                            new Class[]{RejectedExecutionHandler.class},
                            new RejectedProxyInvocationHandler(handler, rejectCount)
                    );
            super.setRejectedExecutionHandler(rejectedProxy);
        }
    }
              
ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![iShot_2025-07-19_13.07.29.png](https://article-images.zsxq.com/FpQc5Tah6WRWXLmXB5S073zPtdrN "iShot_2025-07-19_13.07.29.png")

### 3. æ‹’ç»ç­–ç•¥å‘Šè­¦æ£€æŸ¥ {#3}

ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼šå‰é¢çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯**ç»Ÿè®¡äº†æ‹’ç»ç­–ç•¥çš„æ‰§è¡Œæ¬¡æ•°** ï¼Œé‚£ä¹ˆ------**å‘Šè­¦åˆ°åº•æ˜¯åœ¨å“ªè§¦å‘çš„å‘¢** ï¼Ÿ

åœ¨æˆ‘æœ€åˆè®¾è®¡ Hippo4j æ—¶ï¼Œé‡‡å–çš„æ˜¯ä¸€ç§"å³æ—¶å‘Šè­¦"çš„æ€è·¯ï¼š**åœ¨æ‹’ç»ç­–ç•¥è¢«è§¦å‘çš„é‚£ä¸€åˆ»ï¼Œç«‹å³æ‰§è¡Œå‘Šè­¦é€»è¾‘** ã€‚

æ„æ€ oneThread æ—¶ï¼Œæˆ‘å¼€å§‹åæ€ï¼š**çœŸçš„éœ€è¦è¿™ä¹ˆé«˜çš„å®æ—¶æ€§å—ï¼Ÿ** ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯\*\*"æœ‰æ²¡æœ‰æ‹’ç»å‘ç”Ÿ"\*\* ï¼Œè€Œä¸æ˜¯å®ƒå‘ç”Ÿçš„**ç²¾ç¡®æ—¶åˆ»** ã€‚

äºæ˜¯ï¼Œæˆ‘é‡‡ç”¨äº†å¦ä¸€ç§å®ç°æ€è·¯ ------**é€šè¿‡å®šæ—¶ä»»åŠ¡å®šæœŸæ‰«ææ‹’ç»æ¬¡æ•°** ï¼šå¦‚æœæŸä¸ªçº¿ç¨‹æ± çš„æ‹’ç»æ¬¡æ•°ä¸ä¸Šä¸€æ¬¡è®°å½•ä¸ä¸€è‡´ï¼Œå³è§†ä¸ºå‡ºç°äº†æ–°çš„æ‹’ç»è¡Œä¸ºï¼Œå†è§¦å‘å‘Šè­¦é€»è¾‘ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    /**
     * çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€æŠ¥è­¦æ£€æŸ¥å™¨
     * <p>
     * ä½œè€…ï¼šé©¬ä¸
     * åŠ é¡¹ç›®ç¾¤ï¼šæ—©åŠ å…¥å°±æ˜¯ä¼˜åŠ¿ï¼500äººå†…éƒ¨é¡¹ç›®ç¾¤ï¼Œåˆ†äº«çš„çŸ¥è¯†æ€»æœ‰ä½ éœ€è¦çš„ <a href="https://t.zsxq.com/cw7b9" />
     * å¼€å‘æ—¶é—´ï¼š2025-05-04
     */
    @Slf4j
    @RequiredArgsConstructor
    public class ThreadPoolAlarmChecker {
    â€‹
        private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(
                1,
                ThreadFactoryBuilder.builder()
                        .namePrefix("scheduler_thread-pool_alarm_checker")
                        .build()
        );
        private final Map<String, Long> lastRejectCountMap = new ConcurrentHashMap<>();
    â€‹
        // ......  
    â€‹
        /**
         * æŠ¥è­¦æ£€æŸ¥æ ¸å¿ƒé€»è¾‘
         */
        private void checkAlarm() {
            Collection<ThreadPoolExecutorHolder> holders = OneThreadRegistry.getAllHolders();
            for (ThreadPoolExecutorHolder holder : holders) {
                if (holder.getExecutorProperties().getAlarm().getEnable()) {
                    // ......
                    checkRejectCount(holder);
                }
            }
        }
    â€‹
        /**
         * æ£€æŸ¥æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
         */
        private void checkRejectCount(ThreadPoolExecutorHolder holder) {
            ThreadPoolExecutor executor = holder.getExecutor();
            String threadPoolId = holder.getThreadPoolId();
    â€‹
            // åªå¤„ç†è‡ªå®šä¹‰çº¿ç¨‹æ± ç±»å‹
            if (!(executor instanceof OneThreadExecutor)) {
                return;
            }
    â€‹
            OneThreadExecutor oneThreadExecutor = (OneThreadExecutor) executor;
            long currentRejectCount = oneThreadExecutor.getRejectCount().get();
            long lastRejectCount = lastRejectCountMap.getOrDefault(threadPoolId, 0L);
    â€‹
            // é¦–æ¬¡åˆå§‹åŒ–æˆ–æ‹’ç»æ¬¡æ•°å¢åŠ æ—¶è§¦å‘
            if (currentRejectCount > lastRejectCount) {
                sendAlarmMessage("Reject", holder);
                // æ›´æ–°æœ€åè®°å½•å€¼
                lastRejectCountMap.put(threadPoolId, currentRejectCount);
            }
        }
    â€‹
        // ......
    }
              
Lambda è½»é‡çº§é™æ€ä»£ç† {#lambda}
------------------------

### 1. æ‰©å±•å®ç° {#1}

ä¸Šé¢çš„åŠ¨æ€ä»£ç†å®ç°ç›¸ä¿¡å¤§å®¶å·²ç»çœ‹æ‡‚äº†ã€‚åœ¨å®ç°å®Œæˆåï¼Œæˆ‘ä¹Ÿåœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š
> æˆ‘ä»¬çš„åœºæ™¯å…¶å®éå¸¸ç®€å•ï¼Œè¿œä¸å¦‚ MyBatis é‚£æ ·éœ€è¦æ”¯æŒç”¨æˆ·å®šä¹‰å¤šç§ Mapper æ¥å£ã€é›†æˆ Spring ç­‰å¤æ‚èƒ½åŠ›ï¼Œç¡®å®æœ‰å¿…è¦æåˆ°"åŠ¨æ€ä»£ç†"è¿™ä¹ˆé‡å—ï¼Ÿ

æ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯æƒ³å¯¹å›ºå®šçš„æ‹’ç»ç­–ç•¥åšä¸€å±‚å¢å¼ºé€»è¾‘ã€‚

äºæ˜¯æˆ‘å°è¯•ç”¨ Lambda å®ç°äº†ä¸€ä¸ªæ›´**è½»é‡çº§** çš„æ–¹æ¡ˆï¼Œä¸ä¾èµ–åå°„ï¼Œä¹Ÿä¸éœ€è¦é¢å¤–çš„ä»£ç†ç±»ï¼Œä»…é€šè¿‡ä¸€å±‚é™æ€åŒ…è£…å°±å®Œæˆäº†åŠŸèƒ½å¢å¼ºã€‚ä¸‹é¢æ˜¯å…·ä½“å®ç°ï¼Œä¾›å¤§å®¶å‚è€ƒï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @Slf4j
    public class OneThreadExecutor extends ThreadPoolExecutor {
    â€‹
        // ......
    â€‹
        /**
         * çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
         */
        @Getter
        private final AtomicLong rejectCount = new AtomicLong();
    â€‹
        // ......
    â€‹
        public OneThreadExecutor(
                @NonNull String threadPoolId,
                int corePoolSize,
                int maximumPoolSize,
                long keepAliveTime,
                @NonNull TimeUnit unit,
                @NonNull BlockingQueue<Runnable> workQueue,
                @NonNull ThreadFactory threadFactory,
                @NonNull RejectedExecutionHandler handler,
                long awaitTerminationMillis) {
            super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);
    â€‹
            // é€šè¿‡ Lambda é™æ€åŒ…è£…è®¾ç½®æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
            setRejectedExecutionHandler(handler);
    â€‹
            // ......
        }
    â€‹
        @Override
        public void setRejectedExecutionHandler(RejectedExecutionHandler handler) {
            super.setRejectedExecutionHandler((r, executor) -> {
                rejectCount.incrementAndGet();
                handler.rejectedExecution(r, executor);
            });
        }
    }
              
ä¸Šé¢è¿™ç§æ–¹æ¡ˆçœ‹ç€æ²¡é—®é¢˜ï¼Œå…¶å®è¿˜æœ‰ç‚¹å°ç‘•ç–µï¼Œé‚£å°±æ˜¯å‘Šè­¦æ—¶å€™è·å–æ‹’ç»ç­–ç•¥åç§°æ˜¯ä¸‹é¢è¿™ç§ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    com.nageoffer.onethread.core.executor.OneThreadExecutor$$Lambda$758/0x0000000801634fc0@54ceb23d
              
è¿˜éœ€è¦åšæ‹’ç»ç­–ç•¥çš„ toString æ–¹æ³•é‡å†™ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @Override
    public void setRejectedExecutionHandler(RejectedExecutionHandler handler) {
        RejectedExecutionHandler handlerWrapper = new RejectedExecutionHandler() {
            @Override
            public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
                rejectCount.incrementAndGet();
                handler.rejectedExecution(r, executor);
            }
    â€‹
            @Override
            public String toString() {
                return handler.getClass().getSimpleName();
            }
        };
    â€‹
        super.setRejectedExecutionHandler(handlerWrapper);
    }
              
### 2. Lambda vs åŠ¨æ€ä»£ç† {#2-lambda-vs}

åœ¨æœ¬åœºæ™¯ä¸­ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼æ˜¯åˆç†çš„ï¼Œå®ƒä¸ä»…æ»¡è¶³åŠŸèƒ½éœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå…·å¤‡ä¸€å®šçš„å®æˆ˜è®­ç»ƒä»·å€¼ï¼Œå±äº"å­¦ä¹ å±‚é¢ä¸Šçš„èŠ±æ´»"ã€‚ç„¶è€Œåœ¨å®é™…å·¥ç¨‹è½åœ°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å§‹ç»ˆåšæŒä¸€ä¸ªåŸåˆ™ï¼š**ç®€å•å³æ­£ä¹‰ï¼Œä¼˜å…ˆé€‰æ‹©å¯è¯»æ€§å¼ºã€ç»´æŠ¤æˆæœ¬ä½çš„å®ç°æ–¹å¼** ã€‚

å› æ­¤ï¼Œåœ¨ oneThread çš„æ ¸å¿ƒå®ç°ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†æ›´åŠ ç®€æ´ç›´è§‚çš„ **Lambdaé™æ€åŒ…è£…æ–¹æ¡ˆ** æ¥å¢å¼ºæ‹’ç»ç­–ç•¥é€»è¾‘ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬ä»ä¿ç•™äº†åŸºäºåŠ¨æ€ä»£ç†çš„å®ç°ä½œä¸ºå­¦ä¹ å‚è€ƒï¼Œé›†æˆåœ¨ `OneThreadExecutor` ç±»ä¸­ï¼Œä¾›æœ‰æ›´é«˜å®šåˆ¶éœ€æ±‚æˆ–å¯¹ä»£ç†æœºåˆ¶æ„Ÿå…´è¶£çš„å¼€å‘è€…æ·±å…¥ç ”ç©¶å’Œæ‹“å±•ã€‚

### 3. Lambda åŒ…è£…æ˜¯é™æ€ä»£ç†ä¹ˆï¼Ÿ {#3-lambda}

Lambda å’Œé™æ€ä»£ç†æœ¬è´¨ä¸Šéƒ½åšäº†**ç›¸åŒçš„äº‹æƒ…** ï¼šåœ¨è°ƒç”¨çœŸå®é€»è¾‘ï¼ˆå¦‚ `rejectedExecution`ï¼‰ä¹‹å‰æˆ–ä¹‹åï¼Œ**æ’å…¥ä¸€æ®µå¢å¼ºé€»è¾‘** ã€‚æ‰€ä»¥ä»è¡Œä¸ºè§’åº¦æ¥çœ‹ï¼ŒLambda å®ç°çš„åŒ…è£…å°±æ˜¯ä¸€ç§"é™æ€ä»£ç†"ã€‚

æœ‰ç›¸åŒç‚¹ä¹Ÿæœ‰ä¸åŒç‚¹ï¼š  

|  å¯¹æ¯”ç»´åº¦   |    ä¼ ç»Ÿé™æ€ä»£ç†     |               Lambda é™æ€åŒ…è£…               |
|---------|---------------|-----------------------------------------|
| æ˜¯å¦éœ€è¦ä»£ç†ç±» | âœ… æ˜¯ï¼ˆè¦å†™ä¸€ä¸ªå®ç°ç±»ï¼‰  | âŒ å¦ï¼ˆç”¨é—­åŒ…æˆ–åŒ¿åå‡½æ•°ç›´æ¥å®ç°ï¼‰                       |
| å¯å¤ç”¨æ€§    | âœ… é«˜ï¼ˆä»£ç†ç±»å¯ç”¨äºå¤šå¤„ï¼‰ | âš  é™äºä½œç”¨åŸŸï¼ˆé€‚åˆå±€éƒ¨åŒ…è£…ï¼‰                         |
| å¯è¯»æ€§     | âŒ å®¹æ˜“äº§ç”Ÿæ ·æ¿ä»£ç     | âœ… ç®€æ´æ¸…æ™°                                  |
| æ¥å£è¦æ±‚    | å¯ä»£ç†å¤šä¸ªæ–¹æ³•       | ä»…é€‚ç”¨äºå‡½æ•°å¼æ¥å£ï¼ˆå¦‚ `RejectedExecutionHandler`ï¼‰ |

å¤§å®¶å¯ä»¥è¿™ä¹ˆç†è§£ï¼šLambda å®ç°æœ¬è´¨ä¸Šæ˜¯ä¸€ç§"è½»é‡çº§çš„é™æ€ä»£ç†"ï¼Œç‰¹åˆ«é€‚ç”¨äºå‡½æ•°å¼æ¥å£çš„åŒ…è£…å¢å¼ºåœºæ™¯ã€‚

æ–‡æœ«æ€»ç»“
----

æœ¬æ–‡å›´ç»•çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥çš„æ‰©å±•éœ€æ±‚ï¼Œä» JDK é™åˆ¶å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨äº†é™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†ä¸ Lambda åŒ…è£…ä¸‰ç§ä¸åŒå®ç°è·¯å¾„ï¼Œé€æ­¥æ„å»ºå‡ºä¸€å¥—æ—¢å¯å¢å¼ºæ‹’ç»ç»Ÿè®¡ä¸å‘Šè­¦èƒ½åŠ›ã€åˆä¸ç ´ååŸæœ‰ç­–ç•¥è¡Œä¸ºçš„é€šç”¨æ–¹æ¡ˆã€‚

åœ¨å®è·µè¿‡ç¨‹ä¸­ï¼Œä¸ä»…è®²è¿°äº†ä»£ç†æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³ï¼Œä¹Ÿæ€è€ƒäº†è®¾è®¡å¤æ‚åº¦ä¸å·¥ç¨‹å¯ç»´æŠ¤æ€§çš„æƒè¡¡ï¼šåŠ¨æ€ä»£ç†é€‚åˆé€šç”¨å°è£…ä¸ç»Ÿä¸€æ‹¦æˆªï¼ŒLambda åˆ™åœ¨è½»é‡åœºæ™¯ä¸­å…·å¤‡æ›´é«˜æ€§ä»·æ¯”ã€‚æœ€ç»ˆï¼ŒoneThread é€‰æ‹©å°† Lambda ç”¨äºæ ¸å¿ƒé€»è¾‘å®ç°ï¼Œä¿ç•™åŠ¨æ€ä»£ç†ä½œä¸ºå­¦ä¹ æ–¹æ¡ˆï¼Œå®ç°åŠŸèƒ½ã€æ€§èƒ½ä¸å¼€å‘ä½“éªŒçš„å¹³è¡¡ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©å¤§å®¶ç†è§£ä»£ç†å¢å¼ºåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ä»·å€¼ã€‚

å®Œç»“ï¼Œæ’’èŠ± ğŸ‰  
åŸºäºåŠ¨æ€ä»£ç†æ¨¡å¼å®Œæˆçº¿ç¨‹æ± æ‹’ç»ç­–ç•¥æŠ¥è­¦ï¼Œå…ƒæ•°æ®ä¿¡æ¯ï¼š

*  
ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± oneThreadï¼š<https://t.zsxq.com/5GfrN>  
*  
ä»£ç ä»“åº“ï¼š<https://gitcode.net/nageoffer/onethread> ------ ç”³è¯·é¡¹ç›®æƒé™å‚è€ƒä¸Šè¿°çº¿ç¨‹æ± é¡¹ç›®é“¾æ¥  
*  
ç« èŠ‚éš¾åº¦ï¼šâ˜…â˜…â˜†â˜†â˜† - ä¸­ç­‰  
*  
  è§†é¢‘åœ°å€ï¼šæœ¬ç« èŠ‚å†…å®¹ç®€å•ï¼Œæ— 



\***å†…å®¹æ‘˜è¦ï¼šæœ¬æ–‡ä»‹ç»å¦‚ä½•åŸºäº** JDK åŠ¨æ€ä»£ç†\*\*å’Œ Lambda è½»é‡çº§é™æ€ä»£ç†ï¼Œä¼˜é›…åœ°æ‰©å±•çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥è¡Œä¸ºï¼Œå®ç°æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ä¸å‡†å®æ—¶å‘Šè­¦ã€‚

è¯¾ç¨‹ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š

*  
å‰è¨€  
*  
çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡åœºæ™¯  
*  
ä»£ç†æ¨¡å¼  
*  
åŠ¨æ€ä»£ç†  
*  
Lambda è½»é‡çº§é™æ€ä»£ç†  
*  
  æ–‡æœ«æ€»ç»“

> åœ¨é˜…è¯»æœ¬ç« èŠ‚å‰ï¼Œå¤§å®¶å…ˆé€šè¿‡Breatheå…¬ä¼—å·çš„ä¸€ç¯‡æ–‡ç«  [MyBatisåŠ¨æ€ä»£ç†æ ¸å¿ƒåŸç†](https://mp.weixin.qq.com/s/_7NHd5asmo8DbGANyQM4Vw) å­¦ä¹ åŠ¨æ€ä»£ç†ï¼Œä¸‹é¢æ–‡ç« å°†ä¸å†èµ˜è¿°ã€‚

å‰è¨€
---

çº¿ç¨‹æ± ä½œä¸ºä»»åŠ¡å¹¶å‘å¤„ç†çš„æ ¸å¿ƒç»„ä»¶ï¼Œå…¶ç¨³å®šæ€§ç›´æ¥å½±å“ç³»ç»Ÿæ•´ä½“ååä¸å“åº”èƒ½åŠ›ã€‚è€Œçº¿ç¨‹æ± ä¸­çš„**æ‹’ç»ç­–ç•¥** ï¼Œä½œä¸ºæœ€åä¸€é“é˜²çº¿ï¼Œå¾€å¾€ä»£è¡¨äº†ç³»ç»Ÿå·²å‡ºç°çŸ­æ—¶ç“¶é¢ˆæˆ–é…ç½®ä¸åˆç†ç­‰é—®é¢˜ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ‹’ç»ä»»åŠ¡å‘ç”Ÿçš„ç¬¬ä¸€æ—¶é—´ï¼š

*  
ä¸ŠæŠ¥æŠ¥è­¦ï¼Œå‘ŠçŸ¥ç³»ç»Ÿç»´æŠ¤äººå‘˜ï¼›  
*  
è®°å½•å…³é”®æŒ‡æ ‡ï¼Œä¾¿äºäº‹ååˆ†æä¸æ‰©å®¹è°ƒä¼˜ï¼›  
*  
  ......

ç°å®æ¯”è¾ƒéª¨æ„Ÿï¼ŒJDK çº¿ç¨‹æ± ä»…èƒ½å®Œæˆæ‹’ç»åŸºç¡€é€»è¾‘ï¼Œæ— æ³•æ»¡è¶³ç³»ç»Ÿè¦æ±‚ã€‚ä¸‹æ–‡å°†ä»‹ç»å¦‚ä½•ä¼˜é›…åœ°ä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œä»é™æ€ä»£ç†é€æ­¥ä¼˜åŒ–åˆ°åŠ¨æ€ä»£ç†ï¼Œå®ç°çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡çš„ç»Ÿè®¡ä¸å®æ—¶å‘Šè­¦åŠŸèƒ½ã€‚

çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡åœºæ™¯
---------

çº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡æœ‰ä¸¤ä¸ªä¸»è¦è§¦å‘æ¡ä»¶ï¼š

* 1.  
çº¿ç¨‹æ± çŠ¶æ€éè¿è¡ŒçŠ¶æ€ã€‚  
* 2.  
  é˜»å¡é˜Ÿåˆ—å·²æ»¡ï¼Œä¸”çº¿ç¨‹æ± çº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§å€¼ã€‚

textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    final void reject(Runnable command) {
        handler.rejectedExecution(command, this);
    }
              
æ³¨æ„åˆ°ä¸Šè¿°æ–¹æ³•ä¸ºé»˜è®¤æƒé™ä¸”è¢« `final` ä¿®é¥°ï¼Œå› æ­¤ä¸èƒ½ç›´æ¥æ‰©å±•ã€‚

ä»£ç†æ¨¡å¼
----

å°½ç®¡çº¿ç¨‹æ± çš„æ‹’ç»ä»»åŠ¡æ–¹æ³•è¢«è®¾ç½®ä¸º `final` ä¸”å…·æœ‰é»˜è®¤è®¿é—®æƒé™ï¼Œå¯¼è‡´æˆ‘ä»¬**æ— æ³•ç»§æ‰¿æˆ–é‡å†™è¯¥æ–¹æ³•** ï¼Œä½†æˆ‘ä»¬ä»å¯ä»¥é€šè¿‡ **ä»£ç†æ¨¡å¼** å®ç°æ‰©å±•åŠŸèƒ½ã€‚

**ä»£ç†æ¨¡å¼** ï¼ˆProxy Design Patternï¼‰æ˜¯ä¸€ç§åœ¨**ä¸ä¿®æ”¹åŸå§‹ç±»ä»£ç çš„å‰æä¸‹** ï¼Œé€šè¿‡å¼•å…¥ä»£ç†å¯¹è±¡å¯¹å…¶è¡Œä¸ºè¿›è¡Œå¢å¼ºçš„è®¾è®¡æ‰‹æ®µï¼Œéå¸¸é€‚åˆç”¨äºåŠŸèƒ½å¢å¼ºã€æƒé™æ§åˆ¶ã€å»¶è¿ŸåŠ è½½ç­‰åœºæ™¯ã€‚

![iShot_2025-07-19_13.07.31.png](https://article-images.zsxq.com/Fkg9PO-tIsoCBGRmPCOG--LP1SUj "iShot_2025-07-19_13.07.31.png")

æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€æ­¥å®ç° **åŸºäºä»£ç†æ¨¡å¼çš„æ‹’ç»ç­–ç•¥æ‰©å±•** ï¼ŒåŒ…æ‹¬æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ä¸å‘Šè­¦è§¦å‘ä¸¤ä¸ªæ ¸å¿ƒèƒ½åŠ›ã€‚

### 1. æ‰©å±•çº¿ç¨‹æ±  {#1}

é™æ€ä»£ç†æ¨¡å¼éœ€è¦åˆ›å»ºå¤šä¸ªå…·ä½“å®ç°ç±»æ¥å¢å¼ºåŸå§‹æ‹’ç»ç­–ç•¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public class SupportThreadPoolExecutor extends ThreadPoolExecutor {
    â€‹
        /** æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ */
        private final AtomicInteger rejectCount = new AtomicInteger();
    â€‹
        public SupportThreadPoolExecutor(...) {
            super(...);
        }
    â€‹
        /** æ‹’ç»æ¬¡æ•°è‡ªå¢ */
        public void incrementRejectCount() {
            rejectCount.incrementAndGet();
        }
    â€‹
        /** è·å–å½“å‰æ‹’ç»æ¬¡æ•° */
        public int getRejectCount() {
            return rejectCount.get();
        }
    }
              
### 2. æ‰©å±•æ‹’ç»ç­–ç•¥ {#2}

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡å®šä¹‰ä¸€ä¸ªé€šç”¨çš„æ‹’ç»ç­–ç•¥æ‰©å±•æ¥å£ï¼Œä¸ºåç»­å…·ä½“ç­–ç•¥æä¾›ç»Ÿä¸€çš„å¢å¼ºèƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼š

*  
**æ‹’ç»æ¬¡æ•°ç»Ÿè®¡** ï¼›  
*  
  **æŠ¥è­¦é€šçŸ¥è§¦å‘** ã€‚

ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public interface SupportRejectedExecutionHandler extends RejectedExecutionHandler {
    â€‹
        /**
         * æ‹’ç»ç­–ç•¥å‰ç½®å¤„ç†é€»è¾‘ï¼šç»Ÿè®¡ä¸å‘Šè­¦ã€‚
         */
        default void beforeReject(ThreadPoolExecutor executor) {
            if (executor instanceof SupportThreadPoolExecutor) {
                SupportThreadPoolExecutor supportExecutor = (SupportThreadPoolExecutor) executor;
                // æ‹’ç»æ¬¡æ•°è‡ªå¢
                supportExecutor.incrementRejectCount();
                // æ‰§è¡Œå‘Šè­¦é€»è¾‘ï¼ˆå¯æ›¿æ¢ä¸ºå®é™…æ¨é€æ¸ é“ï¼‰
                System.out.println("çº¿ç¨‹æ± è§¦å‘äº†ä»»åŠ¡æ‹’ç»...");
            }
        }
    }
              
ç„¶åä»¥ `AbortPolicy` ä¸ºä¾‹ï¼Œå®ç°ä¸€ä¸ªå…·å¤‡æ‰©å±•èƒ½åŠ›çš„æ‹’ç»ç­–ç•¥ç±»ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    public class SupportAbortPolicyRejected extends ThreadPoolExecutor.AbortPolicy
            implements SupportRejectedExecutionHandler {
    â€‹
        @Override
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            beforeReject(e); // æ‹’ç»å‰æ‰§è¡Œæ‰©å±•é€»è¾‘
            super.rejectedExecution(r, e); // è°ƒç”¨åŸå§‹ç­–ç•¥è¡Œä¸º
        }
    }
              
### 3. åŠŸèƒ½éªŒè¯ {#3}

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ä¸Šè¿°æ‰©å±•æ‹’ç»ç­–ç•¥æ˜¯å¦èƒ½å®ç°**æ‹’ç»ç»Ÿè®¡+å‘Šè­¦è¾“å‡º** çš„é¢„æœŸåŠŸèƒ½ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @SneakyThrows
    public static void main(String[] args) {
        SupportThreadPoolExecutor executor = new SupportThreadPoolExecutor(
                1,
                1,
                1024,
                TimeUnit.SECONDS,
                new LinkedBlockingQueue<>(1),
                // ä½¿ç”¨è‡ªå®šä¹‰çš„å¢å¼ºå‹æ‹’ç»ç­–ç•¥
                new SupportAbortPolicyRejected()
        );
    â€‹
        // æäº¤ 3 ä¸ªä»»åŠ¡ï¼Œè¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°å’Œé˜Ÿåˆ—å®¹é‡ï¼Œè§¦å‘æ‹’ç»
        for (int i = 0; i < 3; i++) {
            try {
                executor.execute(() -> Thread.sleep(Integer.MAX_VALUE));
            } catch (Exception ex) {
                // å¿½ç•¥æ‹’ç»å¼‚å¸¸ï¼Œä¸“æ³¨éªŒè¯ç»Ÿè®¡ä¸å‘Šè­¦é€»è¾‘
            }
        }
    â€‹
        Thread.sleep(50);
        System.out.println(String.format("çº¿ç¨‹æ± æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ :: %d", executor.getRejectCount()));
    }
    â€‹
    // æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹ï¼š
    çº¿ç¨‹æ± è§¦å‘äº†ä»»åŠ¡æ‹’ç»...
    çº¿ç¨‹æ± æ‹’ç»æ¬¡æ•°ç»Ÿè®¡ :: 1
              
ä»æ—¥å¿—å¯ä»¥ç¡®è®¤ï¼Œ**æˆ‘ä»¬çš„æ‰©å±•é€»è¾‘å·²æˆåŠŸç”Ÿæ•ˆ** ï¼š

*  
æ‹’ç»ç­–ç•¥è§¦å‘æ—¶ï¼Œæ‰§è¡Œäº† `beforeReject()` ä¸­çš„ç»Ÿè®¡ä¸æ—¥å¿—è¾“å‡ºã€‚  
*  
  çº¿ç¨‹æ± å‡†ç¡®è®°å½•äº†è¢«æ‹’ç»ä»»åŠ¡çš„æ¬¡æ•°ã€‚

### 4. æ¨¡å¼å°ç»“ {#4}

ä¸Šè¿°æ‰©å±•æ–¹æ¡ˆé‡‡ç”¨çš„æ˜¯ä¸€ç§ç»å…¸çš„è®¾è®¡æ¨¡å¼ï¼š**é™æ€ä»£ç†** ã€‚å»ºè®®å¤§å®¶åœ¨ç»§ç»­é˜…è¯»ä¹‹å‰ï¼Œå…ˆåœ¨æœ¬åœ°è¿è¡Œä¸€éç¤ºä¾‹ä»£ç ï¼Œé€šè¿‡å®è·µåŠ æ·±ç†è§£ã€‚

å®Œæˆè¿è¡Œåï¼Œæˆ‘ä»¬æ€»ç»“å‡ºä¸€å¼ å›¾ï¼Œå¸®åŠ©å¤§å®¶æ›´ç›´è§‚åœ°ç†è§£**é™æ€ä»£ç†çš„å·¥ä½œæœºåˆ¶** ï¼š

![iShot_2025-07-19_13.07.30.png](https://article-images.zsxq.com/FvtZIbjLfRueIB3hleGfdIK0M5xZ "iShot_2025-07-19_13.07.30.png")

é€šè¿‡æ‹’ç»ç­–ç•¥çš„å®æˆ˜æ¼”ç»ƒï¼Œå¤§å®¶å¯¹**é™æ€ä»£ç†çš„å®ç°æ–¹å¼** å·²ç»æœ‰äº†åˆæ­¥è®¤è¯†ã€‚ä½†é™æ€ä»£ç†çœŸçš„è¶³å¤Ÿä¼˜é›…å—ï¼Ÿæˆ‘ä»¬ä¸å¦¨å†·é™åˆ†æä¸€ä¸‹å…¶å±€é™æ€§ï¼š

*  
**ç±»çˆ†ç‚¸é—®é¢˜** ï¼šæ¯ä¸€ç§æ‹’ç»ç­–ç•¥éƒ½éœ€è¦æ‰‹åŠ¨åˆ›å»ºå¯¹åº”çš„ä»£ç†ç±»æ¥å®ç°å¢å¼ºé€»è¾‘ã€‚ä»¥ JDK æä¾›çš„å››ç§é»˜è®¤ç­–ç•¥ä¸ºä¾‹ï¼Œè‹¥éƒ½éœ€è¦æ‰©å±•ï¼Œå°±å¾—åˆ›å»ºå››ä¸ªé¢å¤–ç±»ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆ**å¼€é—­åŸåˆ™** ï¼Œä¹Ÿä¸åˆ©äºç»´æŠ¤ã€‚  
*  
  **ä¾µå…¥æ€§è¾ƒé«˜ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚åº¦** ï¼šæ‰€æœ‰çº¿ç¨‹æ± éƒ½å¿…é¡»æ˜¾å¼ä½¿ç”¨è¿™äº›å¢å¼ºåçš„æ‹’ç»ç­–ç•¥ï¼Œä¸€æ—¦é¡¹ç›®è§„æ¨¡æ‰©å¤§æˆ–å¼€å‘äººå‘˜æ›´æ›¿ï¼Œå®¹æ˜“é—æ¼ä»£ç†é€»è¾‘æˆ–å‡ºç°ä¸ä¸€è‡´å®ç°ï¼Œé€ æˆæ½œåœ¨çš„ç³»ç»Ÿé£é™©ã€‚

é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨ä¿è¯åŠŸèƒ½æ‰©å±•çš„åŒæ—¶é¿å…è¿™äº›é—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼š**ä½¿ç”¨åŠ¨æ€ä»£ç†** ã€‚

åŠ¨æ€ä»£ç†
----

**åŠ¨æ€ä»£ç†** é€šè¿‡åœ¨**è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»** ï¼Œå®ç°å¯¹ç›®æ ‡å¯¹è±¡è¡Œä¸ºçš„å¢å¼ºï¼Œé¿å…äº†å¯¹åŸå§‹ç±»çš„ä¾µå…¥å¼ä¿®æ”¹ï¼Œä»è€Œæ›´å¥½åœ°éµå¾ªäº†**å¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰** ã€‚

### 1. åˆ›å»ºåŠ¨æ€ä»£ç†ç±» {#1}

å®ç°äº† `java.lang.reflect.InvocationHandler` æ¥å£ï¼Œæ˜¯ JDK åŠ¨æ€ä»£ç†æœºåˆ¶çš„æ ¸å¿ƒæ¥å£ï¼Œç”¨äºå®šä¹‰ä»£ç†æ–¹æ³•çš„å¢å¼ºé€»è¾‘ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @AllArgsConstructor
    public class RejectedProxyInvocationHandler implements InvocationHandler {
    â€‹
        private final Object target;
        private final AtomicLong rejectCount;
    â€‹
        private static final String REJECT_METHOD = "rejectedExecution";
    â€‹
        @Override
        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
            if (REJECT_METHOD.equals(method.getName()) &&
                    args != null &&
                    args.length == 2 &&
                    args[0] instanceof Runnable &&
                    args[1] instanceof ThreadPoolExecutor) {
                rejectCount.incrementAndGet();
            }
    â€‹
            if ("toString".equals(method.getName()) && method.getParameterCount() == 0) {
                return target.getClass().getSimpleName();
            }
    â€‹
            try {
                return method.invoke(target, args);
            } catch (InvocationTargetException ex) {
                throw ex.getCause();
            }
        }
    }
              
æˆå‘˜å˜é‡ï¼š

*  
`target`ï¼šè¢«ä»£ç†çš„å¯¹è±¡ï¼Œé€šå¸¸æ˜¯æŸä¸ªå…·ä½“çš„ `RejectedExecutionHandler` å®ä¾‹ã€‚  
*  
`rejectCount`ï¼šçº¿ç¨‹å®‰å…¨çš„æ‹’ç»æ¬¡æ•°ç»Ÿè®¡å™¨ï¼Œä»£ç†ä¸­æ¯æ¬¡æ‹’ç»éƒ½ä¼šè‡ªå¢ã€‚  
*  
  `REJECT_METHOD`ï¼šå¸¸é‡ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­æ˜¯å¦æ˜¯ `rejectedExecution` æ–¹æ³•ã€‚

æ ¸å¿ƒæ–¹æ³• `invoke`ï¼š

* 1.  
  åˆ¤æ–­æ˜¯å¦æ˜¯æ‹’ç»æ–¹æ³•ï¼š
  * 1.  
  åˆ¤æ–­å½“å‰è°ƒç”¨çš„æ–¹æ³•æ˜¯å¦ä¸º `rejectedExecution`ï¼›  
  * 2.  
  æ ¡éªŒå‚æ•°åˆæ³•æ€§ï¼šä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ `Runnable` å’Œ `ThreadPoolExecutor`ï¼›  
  * 3.  
å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œè¡¨ç¤ºçº¿ç¨‹æ± æ‹’ç»äº†ä¸€ä¸ªä»»åŠ¡ï¼Œè°ƒç”¨ `rejectCount.incrementAndGet()` å®ç°æ‹’ç»æ¬¡æ•°ç´¯åŠ ã€‚  
* 2.  
  ç‰¹æ®Šå¤„ç† `toString` æ–¹æ³•ï¼š
  * 1.  
  ä¸ºäº†é¿å…åŠ¨æ€ä»£ç†å¯¹è±¡æ‰“å°å‡ºæ¥æ˜¯ä¸€å †ä»£ç†ç±»åï¼Œå•ç‹¬å¤„ç†äº† `toString()` æ–¹æ³•ï¼›  
  * 2.  
è¿”å›çš„æ˜¯è¢«ä»£ç†å¯¹è±¡çš„ç±»åï¼Œä¾¿äºæ—¥å¿—æˆ–è°ƒè¯•æ—¶è¯†åˆ«åŸå§‹æ‹’ç»ç­–ç•¥ç±»å‹ã€‚  
* 3.  
  åå°„è°ƒç”¨åŸå§‹é€»è¾‘ï¼š
  * 1.  
  æœ€ç»ˆé€šè¿‡åå°„è°ƒç”¨åŸå§‹ `RejectedExecutionHandler` çš„æ–¹æ³•ï¼Œç¡®ä¿åŸæœ‰é€»è¾‘ä¸è¢«ç ´åï¼›  
  * 2.  
    å¦‚æœç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™æŠ›å‡ºå…¶åŸå§‹å¼‚å¸¸ï¼ˆ`getCause()`ï¼‰ï¼Œä¿æŒè¡Œä¸ºä¸€è‡´ã€‚

å¦‚æœä½¿ç”¨äº†ä¸Šè¿°æ‹’ç»ç­–ç•¥åŠ¨æ€ä»£ç†ç±»ï¼Œæ‰€æœ‰å¯¹ `rejectedExecution()` çš„è°ƒç”¨éƒ½è¢«åŠ¨æ€ä»£ç†æ‹¦æˆªï¼Œæ‰§è¡Œäº†é¢å¤–çš„ç»Ÿè®¡ä¸å‘Šè­¦é€»è¾‘ã€‚åŒæ—¶**ä¿æŒäº†åŸç”Ÿè¯­ä¹‰** ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨åŸå§‹ç­–ç•¥çš„é€»è¾‘ï¼ˆå¦‚ `AbortPolicy` æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œä¸å½±å“çº¿ç¨‹æ± åŸæœ‰è¡Œä¸ºã€‚

![iShot_2025-07-19_13.07.28.png](https://article-images.zsxq.com/FsXLrnU6eyA_amgbwFUu5MUptcbw "iShot_2025-07-19_13.07.28.png")

### 2. oneThread çº¿ç¨‹æ± ä»£ç† {#2-one-thread}

åœ¨æ„å»ºçº¿ç¨‹æ± æ—¶ï¼Œæˆ‘ä»¬ä¾ç„¶ä¿ç•™ç”¨æˆ·è‡ªå®šä¹‰çš„åŸå§‹æ‹’ç»ç­–ç•¥ï¼Œ**ä¸ç ´åå…¶åŸæœ‰ä½¿ç”¨ä¹ æƒ¯** ã€‚ç„¶ååœ¨ `oneThread` çš„æ„é€ æ–¹æ³•ä¸­ï¼Œé€šè¿‡ **åŠ¨æ€ä»£ç†æ–¹å¼å¯¹æ‹’ç»ç­–ç•¥è¿›è¡Œå¢å¼ºå¤„ç†** ï¼Œå®ç°åŠŸèƒ½æ³¨å…¥ã€‚

è¿™ç§è®¾è®¡æ—¢ä¿æŒäº†**ç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§** ï¼Œåˆå®ç°äº†å¯¹çº¿ç¨‹æ± æ‹’ç»è¡Œä¸ºçš„**é€æ˜å¢å¼º** ï¼Œå…¼é¡¾äº†**å…¼å®¹æ€§ä¸å¯æ‰©å±•æ€§** ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    /**
     * å¢å¼ºçš„åŠ¨æ€ã€æŠ¥è­¦å’Œå—ç›‘æ§çš„çº¿ç¨‹æ±  oneThread
     * <p>
     * ä½œè€…ï¼šé©¬ä¸
     * åŠ é¡¹ç›®ç¾¤ï¼šæ—©åŠ å…¥å°±æ˜¯ä¼˜åŠ¿ï¼500äººå†…éƒ¨é¡¹ç›®ç¾¤ï¼Œåˆ†äº«çš„çŸ¥è¯†æ€»æœ‰ä½ éœ€è¦çš„ <a href="https://t.zsxq.com/cw7b9" />
     * å¼€å‘æ—¶é—´ï¼š2025-04-20
     */
    @Slf4j
    public class OneThreadExecutor extends ThreadPoolExecutor {
    â€‹
        // ......
    â€‹
        /**
         * çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
         */
        @Getter
        private final AtomicLong rejectCount = new AtomicLong();
    â€‹
        // ......
    â€‹
        public OneThreadExecutor(
                @NonNull String threadPoolId,
                int corePoolSize,
                int maximumPoolSize,
                long keepAliveTime,
                @NonNull TimeUnit unit,
                @NonNull BlockingQueue<Runnable> workQueue,
                @NonNull ThreadFactory threadFactory,
                @NonNull RejectedExecutionHandler handler,
                long awaitTerminationMillis) {
            super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);
    â€‹
            // é€šè¿‡åŠ¨æ€ä»£ç†è®¾ç½®æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
            setRejectedExecutionHandler(handler);
    â€‹
            // ......
        }
    â€‹
        @Override
        public void setRejectedExecutionHandler(RejectedExecutionHandler handler) {
            RejectedExecutionHandler rejectedProxy = (RejectedExecutionHandler) Proxy
                    .newProxyInstance(
                            handler.getClass().getClassLoader(),
                            new Class[]{RejectedExecutionHandler.class},
                            new RejectedProxyInvocationHandler(handler, rejectCount)
                    );
            super.setRejectedExecutionHandler(rejectedProxy);
        }
    }
              
ç»“æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![iShot_2025-07-19_13.07.29.png](https://article-images.zsxq.com/FpQc5Tah6WRWXLmXB5S073zPtdrN "iShot_2025-07-19_13.07.29.png")

### 3. æ‹’ç»ç­–ç•¥å‘Šè­¦æ£€æŸ¥ {#3}

ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼šå‰é¢çš„æµç¨‹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯**ç»Ÿè®¡äº†æ‹’ç»ç­–ç•¥çš„æ‰§è¡Œæ¬¡æ•°** ï¼Œé‚£ä¹ˆ------**å‘Šè­¦åˆ°åº•æ˜¯åœ¨å“ªè§¦å‘çš„å‘¢** ï¼Ÿ

åœ¨æˆ‘æœ€åˆè®¾è®¡ Hippo4j æ—¶ï¼Œé‡‡å–çš„æ˜¯ä¸€ç§"å³æ—¶å‘Šè­¦"çš„æ€è·¯ï¼š**åœ¨æ‹’ç»ç­–ç•¥è¢«è§¦å‘çš„é‚£ä¸€åˆ»ï¼Œç«‹å³æ‰§è¡Œå‘Šè­¦é€»è¾‘** ã€‚

æ„æ€ oneThread æ—¶ï¼Œæˆ‘å¼€å§‹åæ€ï¼š**çœŸçš„éœ€è¦è¿™ä¹ˆé«˜çš„å®æ—¶æ€§å—ï¼Ÿ** ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯\*\*"æœ‰æ²¡æœ‰æ‹’ç»å‘ç”Ÿ"\*\* ï¼Œè€Œä¸æ˜¯å®ƒå‘ç”Ÿçš„**ç²¾ç¡®æ—¶åˆ»** ã€‚

äºæ˜¯ï¼Œæˆ‘é‡‡ç”¨äº†å¦ä¸€ç§å®ç°æ€è·¯ ------**é€šè¿‡å®šæ—¶ä»»åŠ¡å®šæœŸæ‰«ææ‹’ç»æ¬¡æ•°** ï¼šå¦‚æœæŸä¸ªçº¿ç¨‹æ± çš„æ‹’ç»æ¬¡æ•°ä¸ä¸Šä¸€æ¬¡è®°å½•ä¸ä¸€è‡´ï¼Œå³è§†ä¸ºå‡ºç°äº†æ–°çš„æ‹’ç»è¡Œä¸ºï¼Œå†è§¦å‘å‘Šè­¦é€»è¾‘ã€‚  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    /**
     * çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€æŠ¥è­¦æ£€æŸ¥å™¨
     * <p>
     * ä½œè€…ï¼šé©¬ä¸
     * åŠ é¡¹ç›®ç¾¤ï¼šæ—©åŠ å…¥å°±æ˜¯ä¼˜åŠ¿ï¼500äººå†…éƒ¨é¡¹ç›®ç¾¤ï¼Œåˆ†äº«çš„çŸ¥è¯†æ€»æœ‰ä½ éœ€è¦çš„ <a href="https://t.zsxq.com/cw7b9" />
     * å¼€å‘æ—¶é—´ï¼š2025-05-04
     */
    @Slf4j
    @RequiredArgsConstructor
    public class ThreadPoolAlarmChecker {
    â€‹
        private final ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(
                1,
                ThreadFactoryBuilder.builder()
                        .namePrefix("scheduler_thread-pool_alarm_checker")
                        .build()
        );
        private final Map<String, Long> lastRejectCountMap = new ConcurrentHashMap<>();
    â€‹
        // ......  
    â€‹
        /**
         * æŠ¥è­¦æ£€æŸ¥æ ¸å¿ƒé€»è¾‘
         */
        private void checkAlarm() {
            Collection<ThreadPoolExecutorHolder> holders = OneThreadRegistry.getAllHolders();
            for (ThreadPoolExecutorHolder holder : holders) {
                if (holder.getExecutorProperties().getAlarm().getEnable()) {
                    // ......
                    checkRejectCount(holder);
                }
            }
        }
    â€‹
        /**
         * æ£€æŸ¥æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
         */
        private void checkRejectCount(ThreadPoolExecutorHolder holder) {
            ThreadPoolExecutor executor = holder.getExecutor();
            String threadPoolId = holder.getThreadPoolId();
    â€‹
            // åªå¤„ç†è‡ªå®šä¹‰çº¿ç¨‹æ± ç±»å‹
            if (!(executor instanceof OneThreadExecutor)) {
                return;
            }
    â€‹
            OneThreadExecutor oneThreadExecutor = (OneThreadExecutor) executor;
            long currentRejectCount = oneThreadExecutor.getRejectCount().get();
            long lastRejectCount = lastRejectCountMap.getOrDefault(threadPoolId, 0L);
    â€‹
            // é¦–æ¬¡åˆå§‹åŒ–æˆ–æ‹’ç»æ¬¡æ•°å¢åŠ æ—¶è§¦å‘
            if (currentRejectCount > lastRejectCount) {
                sendAlarmMessage("Reject", holder);
                // æ›´æ–°æœ€åè®°å½•å€¼
                lastRejectCountMap.put(threadPoolId, currentRejectCount);
            }
        }
    â€‹
        // ......
    }
              
Lambda è½»é‡çº§é™æ€ä»£ç† {#lambda}
------------------------

### 1. æ‰©å±•å®ç° {#1}

ä¸Šé¢çš„åŠ¨æ€ä»£ç†å®ç°ç›¸ä¿¡å¤§å®¶å·²ç»çœ‹æ‡‚äº†ã€‚åœ¨å®ç°å®Œæˆåï¼Œæˆ‘ä¹Ÿåœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š
> æˆ‘ä»¬çš„åœºæ™¯å…¶å®éå¸¸ç®€å•ï¼Œè¿œä¸å¦‚ MyBatis é‚£æ ·éœ€è¦æ”¯æŒç”¨æˆ·å®šä¹‰å¤šç§ Mapper æ¥å£ã€é›†æˆ Spring ç­‰å¤æ‚èƒ½åŠ›ï¼Œç¡®å®æœ‰å¿…è¦æåˆ°"åŠ¨æ€ä»£ç†"è¿™ä¹ˆé‡å—ï¼Ÿ

æ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯æƒ³å¯¹å›ºå®šçš„æ‹’ç»ç­–ç•¥åšä¸€å±‚å¢å¼ºé€»è¾‘ã€‚

äºæ˜¯æˆ‘å°è¯•ç”¨ Lambda å®ç°äº†ä¸€ä¸ªæ›´**è½»é‡çº§** çš„æ–¹æ¡ˆï¼Œä¸ä¾èµ–åå°„ï¼Œä¹Ÿä¸éœ€è¦é¢å¤–çš„ä»£ç†ç±»ï¼Œä»…é€šè¿‡ä¸€å±‚é™æ€åŒ…è£…å°±å®Œæˆäº†åŠŸèƒ½å¢å¼ºã€‚ä¸‹é¢æ˜¯å…·ä½“å®ç°ï¼Œä¾›å¤§å®¶å‚è€ƒï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @Slf4j
    public class OneThreadExecutor extends ThreadPoolExecutor {
    â€‹
        // ......
    â€‹
        /**
         * çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
         */
        @Getter
        private final AtomicLong rejectCount = new AtomicLong();
    â€‹
        // ......
    â€‹
        public OneThreadExecutor(
                @NonNull String threadPoolId,
                int corePoolSize,
                int maximumPoolSize,
                long keepAliveTime,
                @NonNull TimeUnit unit,
                @NonNull BlockingQueue<Runnable> workQueue,
                @NonNull ThreadFactory threadFactory,
                @NonNull RejectedExecutionHandler handler,
                long awaitTerminationMillis) {
            super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);
    â€‹
            // é€šè¿‡ Lambda é™æ€åŒ…è£…è®¾ç½®æ‹’ç»ç­–ç•¥æ‰§è¡Œæ¬¡æ•°
            setRejectedExecutionHandler(handler);
    â€‹
            // ......
        }
    â€‹
        @Override
        public void setRejectedExecutionHandler(RejectedExecutionHandler handler) {
            super.setRejectedExecutionHandler((r, executor) -> {
                rejectCount.incrementAndGet();
                handler.rejectedExecution(r, executor);
            });
        }
    }
              
ä¸Šé¢è¿™ç§æ–¹æ¡ˆçœ‹ç€æ²¡é—®é¢˜ï¼Œå…¶å®è¿˜æœ‰ç‚¹å°ç‘•ç–µï¼Œé‚£å°±æ˜¯å‘Šè­¦æ—¶å€™è·å–æ‹’ç»ç­–ç•¥åç§°æ˜¯ä¸‹é¢è¿™ç§ï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    com.nageoffer.onethread.core.executor.OneThreadExecutor$$Lambda$758/0x0000000801634fc0@54ceb23d
              
è¿˜éœ€è¦åšæ‹’ç»ç­–ç•¥çš„ toString æ–¹æ³•é‡å†™ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š  
textjavascripttypescriptcsshtmlbashjsonmarkdownpythonjavaccpprubygorustphpsqlyaml Copy

                    @Override
    public void setRejectedExecutionHandler(RejectedExecutionHandler handler) {
        RejectedExecutionHandler handlerWrapper = new RejectedExecutionHandler() {
            @Override
            public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
                rejectCount.incrementAndGet();
                handler.rejectedExecution(r, executor);
            }
    â€‹
            @Override
            public String toString() {
                return handler.getClass().getSimpleName();
            }
        };
    â€‹
        super.setRejectedExecutionHandler(handlerWrapper);
    }
              
### 2. Lambda vs åŠ¨æ€ä»£ç† {#2-lambda-vs}

åœ¨æœ¬åœºæ™¯ä¸­ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼æ˜¯åˆç†çš„ï¼Œå®ƒä¸ä»…æ»¡è¶³åŠŸèƒ½éœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå…·å¤‡ä¸€å®šçš„å®æˆ˜è®­ç»ƒä»·å€¼ï¼Œå±äº"å­¦ä¹ å±‚é¢ä¸Šçš„èŠ±æ´»"ã€‚ç„¶è€Œåœ¨å®é™…å·¥ç¨‹è½åœ°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å§‹ç»ˆåšæŒä¸€ä¸ªåŸåˆ™ï¼š**ç®€å•å³æ­£ä¹‰ï¼Œä¼˜å…ˆé€‰æ‹©å¯è¯»æ€§å¼ºã€ç»´æŠ¤æˆæœ¬ä½çš„å®ç°æ–¹å¼** ã€‚

å› æ­¤ï¼Œåœ¨ oneThread çš„æ ¸å¿ƒå®ç°ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†æ›´åŠ ç®€æ´ç›´è§‚çš„ **Lambdaé™æ€åŒ…è£…æ–¹æ¡ˆ** æ¥å¢å¼ºæ‹’ç»ç­–ç•¥é€»è¾‘ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬ä»ä¿ç•™äº†åŸºäºåŠ¨æ€ä»£ç†çš„å®ç°ä½œä¸ºå­¦ä¹ å‚è€ƒï¼Œé›†æˆåœ¨ `OneThreadExecutor` ç±»ä¸­ï¼Œä¾›æœ‰æ›´é«˜å®šåˆ¶éœ€æ±‚æˆ–å¯¹ä»£ç†æœºåˆ¶æ„Ÿå…´è¶£çš„å¼€å‘è€…æ·±å…¥ç ”ç©¶å’Œæ‹“å±•ã€‚

### 3. Lambda åŒ…è£…æ˜¯é™æ€ä»£ç†ä¹ˆï¼Ÿ {#3-lambda}

Lambda å’Œé™æ€ä»£ç†æœ¬è´¨ä¸Šéƒ½åšäº†**ç›¸åŒçš„äº‹æƒ…** ï¼šåœ¨è°ƒç”¨çœŸå®é€»è¾‘ï¼ˆå¦‚ `rejectedExecution`ï¼‰ä¹‹å‰æˆ–ä¹‹åï¼Œ**æ’å…¥ä¸€æ®µå¢å¼ºé€»è¾‘** ã€‚æ‰€ä»¥ä»è¡Œä¸ºè§’åº¦æ¥çœ‹ï¼ŒLambda å®ç°çš„åŒ…è£…å°±æ˜¯ä¸€ç§"é™æ€ä»£ç†"ã€‚

æœ‰ç›¸åŒç‚¹ä¹Ÿæœ‰ä¸åŒç‚¹ï¼š  

|  å¯¹æ¯”ç»´åº¦   |    ä¼ ç»Ÿé™æ€ä»£ç†     |               Lambda é™æ€åŒ…è£…               |
|---------|---------------|-----------------------------------------|
| æ˜¯å¦éœ€è¦ä»£ç†ç±» | âœ… æ˜¯ï¼ˆè¦å†™ä¸€ä¸ªå®ç°ç±»ï¼‰  | âŒ å¦ï¼ˆç”¨é—­åŒ…æˆ–åŒ¿åå‡½æ•°ç›´æ¥å®ç°ï¼‰                       |
| å¯å¤ç”¨æ€§    | âœ… é«˜ï¼ˆä»£ç†ç±»å¯ç”¨äºå¤šå¤„ï¼‰ | âš  é™äºä½œç”¨åŸŸï¼ˆé€‚åˆå±€éƒ¨åŒ…è£…ï¼‰                         |
| å¯è¯»æ€§     | âŒ å®¹æ˜“äº§ç”Ÿæ ·æ¿ä»£ç     | âœ… ç®€æ´æ¸…æ™°                                  |
| æ¥å£è¦æ±‚    | å¯ä»£ç†å¤šä¸ªæ–¹æ³•       | ä»…é€‚ç”¨äºå‡½æ•°å¼æ¥å£ï¼ˆå¦‚ `RejectedExecutionHandler`ï¼‰ |

å¤§å®¶å¯ä»¥è¿™ä¹ˆç†è§£ï¼šLambda å®ç°æœ¬è´¨ä¸Šæ˜¯ä¸€ç§"è½»é‡çº§çš„é™æ€ä»£ç†"ï¼Œç‰¹åˆ«é€‚ç”¨äºå‡½æ•°å¼æ¥å£çš„åŒ…è£…å¢å¼ºåœºæ™¯ã€‚

æ–‡æœ«æ€»ç»“
----

æœ¬æ–‡å›´ç»•çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥çš„æ‰©å±•éœ€æ±‚ï¼Œä» JDK é™åˆ¶å‡ºå‘ï¼Œæ·±å…¥æ¢è®¨äº†é™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†ä¸ Lambda åŒ…è£…ä¸‰ç§ä¸åŒå®ç°è·¯å¾„ï¼Œé€æ­¥æ„å»ºå‡ºä¸€å¥—æ—¢å¯å¢å¼ºæ‹’ç»ç»Ÿè®¡ä¸å‘Šè­¦èƒ½åŠ›ã€åˆä¸ç ´ååŸæœ‰ç­–ç•¥è¡Œä¸ºçš„é€šç”¨æ–¹æ¡ˆã€‚

åœ¨å®è·µè¿‡ç¨‹ä¸­ï¼Œä¸ä»…è®²è¿°äº†ä»£ç†æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³ï¼Œä¹Ÿæ€è€ƒäº†è®¾è®¡å¤æ‚åº¦ä¸å·¥ç¨‹å¯ç»´æŠ¤æ€§çš„æƒè¡¡ï¼šåŠ¨æ€ä»£ç†é€‚åˆé€šç”¨å°è£…ä¸ç»Ÿä¸€æ‹¦æˆªï¼ŒLambda åˆ™åœ¨è½»é‡åœºæ™¯ä¸­å…·å¤‡æ›´é«˜æ€§ä»·æ¯”ã€‚æœ€ç»ˆï¼ŒoneThread é€‰æ‹©å°† Lambda ç”¨äºæ ¸å¿ƒé€»è¾‘å®ç°ï¼Œä¿ç•™åŠ¨æ€ä»£ç†ä½œä¸ºå­¦ä¹ æ–¹æ¡ˆï¼Œå®ç°åŠŸèƒ½ã€æ€§èƒ½ä¸å¼€å‘ä½“éªŒçš„å¹³è¡¡ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©å¤§å®¶ç†è§£ä»£ç†å¢å¼ºåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ä»·å€¼ã€‚

å®Œç»“ï¼Œæ’’èŠ± ğŸ‰

